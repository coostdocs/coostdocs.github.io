<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="#What is coost coost is an elegant and efficient cross-platform C&#43;&#43; base library. Its goal is to create a sword of C&#43;&#43; to make C&#43;&#43; programming easy and enjoyable.
The original name of coost is co or cocoyaxi. It is like boost, but more lightweight, the static library built on linux or mac is only about 1MB in size. However, it still provides enough powerful features:
Command line and config file parser (flag) High performance log library (log) Unit testing framework go-style coroutine Coroutine-based network library Efficient JSON library JSON RPC framework Atomic operation (atomic) Efficient stream (fastream) Efficient string (fastring) String utility (str) Time library (time) Thread library (thread) Timed Task Scheduler God-oriented programming LruMap hash library path library File utilities (fs) System operations (os) Fast memory allocator #History of coost 2013-2015, Alvin(idealvin) felt a little cumbersome when using google&rsquo;s gflags, glog, gtest, etc.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Introduction" />
<meta property="og:description" content="#What is coost coost is an elegant and efficient cross-platform C&#43;&#43; base library. Its goal is to create a sword of C&#43;&#43; to make C&#43;&#43; programming easy and enjoyable.
The original name of coost is co or cocoyaxi. It is like boost, but more lightweight, the static library built on linux or mac is only about 1MB in size. However, it still provides enough powerful features:
Command line and config file parser (flag) High performance log library (log) Unit testing framework go-style coroutine Coroutine-based network library Efficient JSON library JSON RPC framework Atomic operation (atomic) Efficient stream (fastream) Efficient string (fastring) String utility (str) Time library (time) Thread library (thread) Timed Task Scheduler God-oriented programming LruMap hash library path library File utilities (fs) System operations (os) Fast memory allocator #History of coost 2013-2015, Alvin(idealvin) felt a little cumbersome when using google&rsquo;s gflags, glog, gtest, etc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://coostdocs.github.io/en/about/co/" /><meta property="article:section" content="about" />

<meta property="article:modified_time" content="2022-10-06T21:08:51+08:00" />

<title>Introduction | Documents for Coost</title>
<link rel="manifest" href="../../../manifest.json">
<link rel="icon" href="../../../favicon.png" type="image/x-icon">
  <link rel="alternate" hreflang="cn" href="https://coostdocs.github.io/cn/about/co/" title="ç®€ä»‹">
<link rel="stylesheet" href="../../../book.min.34012a023bb86e99e9c5d444ca11c3e38625a1b8f226bf07e2360827bb149b14.css" integrity="sha256-NAEqAju4bpnpxdREyhHD44YlobjyJr8H4jYIJ7sUmxQ=" crossorigin="anonymous">
  <script defer src="../../../flexsearch.min.js"></script>
  <script defer src="../../../en.search.min.14984b7732e9305097bf16cd269c495e2b206979e5cc2b8737ab171582ecdcde.js" integrity="sha256-FJhLdzLpMFCXvxbNJpxJXisgaXnlzCuHN6sXFYLs3N4=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  


<link href='//cdn.bootcss.com/highlight.js/11.1.0/styles/github.min.css'
  rel='stylesheet' type='text/css' />


</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="../../../cn/"><span>Documents for Coost</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>About</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../en/about/co/" class=" active">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/about/contact/" class="">Contact</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/about/sponsor/" class="">SponsorðŸ’•</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Documents for CO</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/def/" class="">Basic definitions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/defer/" class="">defer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/atomic/" class="">Atomic Operations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/fastring/" class="">fastring</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/fastream/" class="">fastream</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/str/" class="">String utilities</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/flag/" class="">co/flag</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/log/" class="">co/log</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/unitest/" class="">Unitest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/json/" class="">JSON</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/time/" class="">Time</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/thread/" class="">Thread</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/coroutine/" class="">Coroutine</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-752f64a904309658adbf6062b2c3d8c1" class="toggle"  />
    <label for="section-752f64a904309658adbf6062b2c3d8c1" class="flex justify-between">
      <a role="button" class="">Network Programming</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/net/byte_order/" class="">Byte order</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/net/tcp/" class="">TCP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/net/http/" class="">HTTP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/net/rpc/" class="">RPC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/tasked/" class="">Timed task scheduler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/random/" class="">Random number</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/lrumap/" class="">LruMap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/hash/" class="">Hash</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/path/" class="">Path</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/fs/" class="">File System</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/os/" class="">Operating System</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../en/co/build/" class="">Compiling</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Introduction</strong>

  <label for="toc-control">
    
    <img src="../../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-coost">What is coost</a></li>
        <li><a href="#history-of-coost">History of coost</a></li>
        <li><a href="#quick-start">Quick Start</a>
          <ul>
            <li><a href="#compiling">Compiling</a></li>
            <li><a href="#develop-c-programs-with-coost">Develop C++ programs with coost</a></li>
          </ul>
        </li>
        <li><a href="#performance">Performance</a>
          <ul>
            <li><a href="#memory-allocator">Memory allocator</a></li>
            <li><a href="#log-library">Log library</a></li>
            <li><a href="#json-library">JSON library</a></li>
          </ul>
        </li>
        <li><a href="#core-features">Core features</a>
          <ul>
            <li><a href="#god-oriented-programming">God-oriented programming</a></li>
            <li><a href="#flag">flag</a></li>
            <li><a href="#log">log</a></li>
            <li><a href="#unitest">unitest</a></li>
            <li><a href="#json">JSON</a></li>
            <li><a href="#coroutine">Coroutine</a></li>
            <li><a href="#network-programming">network programming</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h2 id="what-is-coost"><a class="anchor" href="#what-is-coost">#</a>What is coost</h2>
<p><a href="https://github.com/idealvin/coost"><img src="https://img.shields.io/github/stars/idealvin/coost?style=social" alt="stars" /></a>
<a href="https://github.com/idealvin/coost"><img src="https://img.shields.io/github/forks/idealvin/coost?style=social" alt="forks" /></a>
<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="MIT" /></a></p>
<p><strong><a href="https://github.com/idealvin/coost">coost</a></strong> is an elegant and efficient cross-platform C++ base library. Its goal is to create a sword of C++ to make C++ programming easy and enjoyable.</p>
<p>The original name of coost is <strong>co</strong> or cocoyaxi. It is like <a href="https://www.boost.org/">boost</a>, but more lightweight, <strong>the static library built on linux or mac is only about 1MB in size</strong>. However, it still provides enough powerful features:</p>
<div class="book-columns flex flex-wrap">

  <div class="flex-even markdown-inner">
    <ul>
<li>Command line and config file parser (flag)</li>
<li><strong>High performance log library (log)</strong></li>
<li>Unit testing framework</li>
<li><strong>go-style coroutine</strong></li>
<li>Coroutine-based network library</li>
<li>Efficient JSON library</li>
<li><strong>JSON RPC framework</strong></li>
</ul>

  </div>

  <div class="flex-even markdown-inner">
    <ul>
<li>Atomic operation (atomic)</li>
<li><strong>Efficient stream (fastream)</strong></li>
<li>Efficient string (fastring)</li>
<li>String utility (str)</li>
<li>Time library (time)</li>
<li>Thread library (thread)</li>
<li>Timed Task Scheduler</li>
</ul>

  </div>

  <div class="flex-even markdown-inner">
    <ul>
<li><strong>God-oriented programming</strong></li>
<li>LruMap</li>
<li>hash library</li>
<li>path library</li>
<li>File utilities (fs)</li>
<li>System operations (os)</li>
<li><strong>Fast memory allocator</strong></li>
</ul>

  </div>

</div>

<h2 id="history-of-coost"><a class="anchor" href="#history-of-coost">#</a>History of coost</h2>
<ul>
<li>
<p><strong>2013-2015</strong>, <a href="https://github.com/idealvin">Alvin(idealvin)</a> felt a little cumbersome when using google&rsquo;s gflags, glog, gtest, etc., so he implemented the corresponding functions by himself, that is, the <strong>flag, log, unitest, etc.</strong> in today&rsquo;s coost.</p>
</li>
<li>
<p><strong>2015-2018</strong>, Alvin introduced this library into actual projects for use by himself and his colleagues, which greatly improved the efficiency of C++ development. It has also been tested by industrial projects, and continuously improved and expanded new features in practice.</p>
</li>
<li>
<p><strong>In 2019</strong>, Alvin implemented a <strong>go-style coroutine</strong> and a network programming framework based on coroutines, and then <strong>named the project co and release v1.0 on <a href="https://github.com/idealvin/coost">github</a></strong>.</p>
</li>
<li>
<p><strong>2020-2021</strong>, improve hook mechanism, coroutine synchronization mechanism, add channel, defer and other features in golang, <strong>release 2.x version</strong>. During this period, <strong>some githubers provided a lot of valuable suggestions, and helped to improve <a href="https://github.com/xmake-io/xmake">xmake</a>, cmake building scripts and many features in coost</strong>.</p>
</li>
<li>
<p><strong>2022</strong>, add <strong>a fast memory allocator</strong>, improve overall performance, make major improvements to many components such as flag, log, JSON, RPC, fastring, fastream, and <strong>rename the project coost, release version 3.0</strong>.</p>
</li>
</ul>
<h2 id="quick-start"><a class="anchor" href="#quick-start">#</a>Quick Start</h2>
<h3 id="compiling"><a class="anchor" href="#compiling">#</a>Compiling</h3>
<p>It is recommended to install <a href="https://github.com/xmake-io/xmake">xmake</a> and run the following command in the root directory of coost to build all sub-projects:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xmake -a
</span></span></code></pre></div><p>If you need to use http::Client, SSL or HTTPS features, you can use the following command to build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xmake f --with_libcurl<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --with_openssl<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>xmake -a
</span></span></code></pre></div><p>Xmake will automatically install libcurl and openssl from the network. Depending on the network, this process may be slow. <code>xmake -a</code> will build <a href="https://github.com/idealvin/coost/tree/master/src">libco</a>, <a href="https://github.com/idealvin/coost/tree/master/gen">gen</a>, <a href="https://github.com/idealvin/coost/tree/master/unitest">co/unitest</a> and <a href="https://github.com/idealvin/coost/tree/master/test">co/test</a>. Users can run test programs in coost with the following commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xmake r unitest
</span></span><span style="display:flex;"><span>xmake r flag
</span></span><span style="display:flex;"><span>xmake r log -cout
</span></span><span style="display:flex;"><span>xmake r co
</span></span></code></pre></div><h3 id="develop-c-programs-with-coost"><a class="anchor" href="#develop-c-programs-with-coost">#</a>Develop C++ programs with coost</h3>
<p>The simplest, you can directly include <a href="https://github.com/idealvin/coost/blob/master/include/co/all.h">co/all.h</a> and use all the features in coost. If you are worried about the compiling speed, you can also include only the header files that you need, such as including <a href="https://github.com/idealvin/coost/blob/master/include/co/co.h">co/co.h</a>, you can use co/flag, co/log and all features related to coroutines.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/all.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>DEF_string(s, <span style="color:#d14">&#34;nice&#34;</span>, <span style="color:#d14">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_s;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The above is a simple example. The first line of the main function is used to parse the command-line flags and the config file. Some components in coost use co/flag to define config items. Therefore, it is generally necessary to call <code>flag::init()</code> at the beginning of the main function for initialization.</p>
<p>Users can also use the macro <code>DEF_main</code> to define the main function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/all.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>DEF_string(s, <span style="color:#d14">&#34;nice&#34;</span>, <span style="color:#d14">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DEF_main(argc, argv) {
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_s;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>DEF_main</code> puts code in the main function into a coroutine, and <code>flag::init()</code> has been called internally, and users needn&rsquo;t call it manually.</p>
<h2 id="performance"><a class="anchor" href="#performance">#</a>Performance</h2>
<h3 id="memory-allocator"><a class="anchor" href="#memory-allocator">#</a>Memory allocator</h3>
<p>For memory allocators such as ptmalloc, jemalloc, tcmalloc and mimalloc, there is a high probability that the small memory will not be returned to the operating system after they are freed. To solve this problem, coost has designed a dedicated memory allocator (co/malloc), which will return as much released memory to the system as possible while taking into account performance, which is conducive to reducing the memory footprint of the program.</p>
<p><a href="https://github.com/idealvin/coost/blob/master/test/mem.cc">co/test</a> provides a simple test code, which can be built and run as follow:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xmake b mem
</span></span><span style="display:flex;"><span>xmake r mem -t <span style="color:#099">4</span> -s
</span></span></code></pre></div><p><code>-t</code> specifies the number of threads, <code>-s</code> means to compare with the system memory allocator. Here are the test results on different platforms (4 threads):</p>
<table>
<thead>
<tr>
<th>os/cpu</th>
<th>co::alloc</th>
<th>co::free</th>
<th>::malloc</th>
<th>::free</th>
<th>speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>win/AMD 3.2G</td>
<td>7.32</td>
<td>6.83</td>
<td>86.05</td>
<td>105.06</td>
<td>11.7/15.3</td>
</tr>
<tr>
<td>mac/i7 2.4G</td>
<td>9.91</td>
<td>9.86</td>
<td>55.64</td>
<td>60.20</td>
<td>5.6/6.1</td>
</tr>
<tr>
<td>linux/i7 2.2G</td>
<td>10.80</td>
<td>7.51</td>
<td>1070.5</td>
<td>21.17</td>
<td>99.1/2.8</td>
</tr>
</tbody>
</table>
<p>The data in the table is the average time, the unit is nanoseconds (ns), linux is the ubuntu system running in Windows WSL, speedup is the performance improvement multiple of coost memory allocator relative to the system memory allocator.</p>
<p>It can be seen that <strong>co::alloc is nearly 99 times faster than ::malloc</strong> on Linux. One of the reasons is that ptmalloc has a large lock competition overhead in multi-threaded environment, and co/malloc is designed to avoid the use of locks as much as possible. The allocation and release of small blocks of memory do not require locks, and even spin locks are not used when releasing across threads.</p>
<h3 id="log-library"><a class="anchor" href="#log-library">#</a>Log library</h3>
<table>
<thead>
<tr>
<th>platform</th>
<th>glog</th>
<th>co/log</th>
<th>speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>win2012 HHD</td>
<td>1.6MB/s</td>
<td>180MB/s</td>
<td>112.5</td>
</tr>
<tr>
<td>win10 SSD</td>
<td>3.7MB/s</td>
<td>560MB/s</td>
<td>151.3</td>
</tr>
<tr>
<td>mac SSD</td>
<td>17MB/s</td>
<td>450MB/s</td>
<td>26.4</td>
</tr>
<tr>
<td>linux SSD</td>
<td>54MB/s</td>
<td>1023MB/s</td>
<td>18.9</td>
</tr>
</tbody>
</table>
<p>The above is the write speed of co/log and glog (single thread, 1 million logs). It can be seen that co/log is nearly two orders of magnitude faster than glog.</p>
<table>
<thead>
<tr>
<th>threads</th>
<th>linux co/log</th>
<th>linux spdlog</th>
<th>win co/log</th>
<th>win spdlog</th>
<th>speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0.087235</td>
<td>2.076172</td>
<td>0.117704</td>
<td>0.461156</td>
<td>23.8/3.9</td>
</tr>
<tr>
<td>2</td>
<td>0.183160</td>
<td>3.729386</td>
<td>0.158122</td>
<td>0.511769</td>
<td>20.3/3.2</td>
</tr>
<tr>
<td>4</td>
<td>0.206712</td>
<td>4.764238</td>
<td>0.316607</td>
<td>0.743227</td>
<td>23.0/2.3</td>
</tr>
<tr>
<td>8</td>
<td>0.302088</td>
<td>3.963644</td>
<td>0.406025</td>
<td>1.417387</td>
<td>13.1/3.5</td>
</tr>
</tbody>
</table>
<p>The above is the time of <a href="https://github.com/idealvin/coost/tree/benchmark">printing 1 million logs with 1, 2, 4, and 8 threads</a>, in seconds. Speedup is the performance improvement of co/log compared to spdlog on linux and windows platforms.</p>
<h3 id="json-library"><a class="anchor" href="#json-library">#</a>JSON library</h3>
<table>
<thead>
<tr>
<th>os</th>
<th>co/json stringify</th>
<th>co/json parse</th>
<th>rapidjson stringify</th>
<th>rapidjson parse</th>
<th>speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>win</td>
<td>569</td>
<td>924</td>
<td>2089</td>
<td>2495</td>
<td>3.6/2.7</td>
</tr>
<tr>
<td>mac</td>
<td>783</td>
<td>1097</td>
<td>1289</td>
<td>1658</td>
<td>1.6/1.5</td>
</tr>
<tr>
<td>linux</td>
<td>468</td>
<td>764</td>
<td>1359</td>
<td>1070</td>
<td>2.9/1.4</td>
</tr>
</tbody>
</table>
<p>The above is the average time of stringifying and parsing minimized <a href="https://raw.githubusercontent.com/simdjson/simdjson/master/jsonexamples/twitter.json">twitter.json</a>, in microseconds (us), speedup is the performance improvement of co/json compared to rapidjson.</p>
<h2 id="core-features"><a class="anchor" href="#core-features">#</a>Core features</h2>
<h3 id="god-oriented-programming"><a class="anchor" href="#god-oriented-programming">#</a>God-oriented programming</h3>
<p><a href="https://github.com/idealvin/coost/blob/master/include/co/god.h">co/god.h</a> provides some features based on templates.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/god.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    god<span style="color:#000;font-weight:bold">::</span>bless_no_bugs();
</span></span><span style="display:flex;"><span>    god<span style="color:#000;font-weight:bold">::</span>align_up<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#099">8</span><span style="color:#000;font-weight:bold">&gt;</span>(<span style="color:#099">31</span>); <span style="color:#998;font-style:italic">// -&gt; 32
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    god<span style="color:#000;font-weight:bold">::</span>is_same<span style="color:#000;font-weight:bold">&lt;</span>T, <span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">&gt;</span>(); <span style="color:#998;font-style:italic">// T is int or bool?
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></div><h3 id="flag"><a class="anchor" href="#flag">#</a>flag</h3>
<p><strong><a href="../../co/flag/">flag</a></strong> is a simple and easy-to-use command line and config file parsing library. Some components in coost use it to define config items.</p>
<p>Each <strong>flag(config item)</strong> has a default value, and by default, the program can run with the default config values. Users can also pass in parameters from the <strong>command line or config file</strong>, and when a config file is required, <code>-mkconf</code> can be used to <strong>generate it automatically</strong>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/flag.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/cout.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>DEF_bool(x, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;x&#34;</span>);
</span></span><span style="display:flex;"><span>DEF_bool(debug, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;dbg&#34;</span>, d);
</span></span><span style="display:flex;"><span>DEF_uint32(u, <span style="color:#099">0</span>, <span style="color:#d14">&#34;xxx&#34;</span>);
</span></span><span style="display:flex;"><span>DEF_string(s, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;xx&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>    COUT <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;x: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_x;
</span></span><span style="display:flex;"><span>    COUT <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;y: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_y;
</span></span><span style="display:flex;"><span>    COUT <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;debug: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_debug;
</span></span><span style="display:flex;"><span>    COUT <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;u: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_u;
</span></span><span style="display:flex;"><span>    COUT <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_s <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;|&#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> FLG_s.size();
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the above example, the macros start with <code>DEF_</code> define 4 flags. Each flag corresponds to a global variable, whose name is <code>FLG_</code> plus the flag name. The flag <code>debug</code> has an alias <code>d</code>. After building, the above code can run as follow:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./xx                  <span style="color:#998;font-style:italic"># Run with default configs</span>
</span></span><span style="display:flex;"><span>./xx -x -s good       <span style="color:#998;font-style:italic"># x -&gt; true, s -&gt; &#34;good&#34;</span>
</span></span><span style="display:flex;"><span>./xx -debug           <span style="color:#998;font-style:italic"># debug -&gt; true</span>
</span></span><span style="display:flex;"><span>./xx -xd              <span style="color:#998;font-style:italic"># x -&gt; true, debug -&gt; true</span>
</span></span><span style="display:flex;"><span>./xx -u 8k            <span style="color:#998;font-style:italic"># u -&gt; 8192</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./xx -mkconf          <span style="color:#998;font-style:italic"># Automatically generate a config file: xx.conf</span>
</span></span><span style="display:flex;"><span>./xx xx.conf          <span style="color:#998;font-style:italic"># run with a config file</span>
</span></span><span style="display:flex;"><span>./xx -conf xx.conf    <span style="color:#998;font-style:italic"># Same as above</span>
</span></span></code></pre></div><h3 id="log"><a class="anchor" href="#log">#</a>log</h3>
<p><strong><a href="../../co/log/">log</a></strong> is a high-performance log library, some components in coost use it to print logs.</p>
<p>log supports two types of logs: one is level log, which is divided into 5 levels: debug, info, warning, error and fatal, <strong>printing a fatal log will terminate the program</strong>; the other is topic log, logs are grouped by topic, and logs of different topics are written to different files.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/log.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TLOG(<span style="color:#d14">&#34;xx&#34;</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;s&#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>; <span style="color:#998;font-style:italic">// topic log
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    DLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;  <span style="color:#998;font-style:italic">// debug
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;   <span style="color:#998;font-style:italic">// info
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    WLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;  <span style="color:#998;font-style:italic">// warning
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    ELOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;  <span style="color:#998;font-style:italic">// error
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    FLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;  <span style="color:#998;font-style:italic">// fatal
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>co/log also provides a series of <code>CHECK</code> macros, which is an enhanced version of <code>assert</code>, and they will not be cleared in debug mode.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> p <span style="color:#000;font-weight:bold">=</span> malloc(<span style="color:#099">32</span>);
</span></span><span style="display:flex;"><span>CHECK(p <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;malloc failed..&#34;</span>;
</span></span><span style="display:flex;"><span>CHECK_NE(p, <span style="color:#0086b3">NULL</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;malloc failed..&#34;</span>;
</span></span></code></pre></div><p>log is very fast, the following are some test results:</p>
<table>
<thead>
<tr>
<th>platform</th>
<th>glog</th>
<th>co/log</th>
<th>speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>win2012 HHD</td>
<td>1.6MB/s</td>
<td>180MB/s</td>
<td>112.5</td>
</tr>
<tr>
<td>win10 SSD</td>
<td>3.7MB/s</td>
<td>560MB/s</td>
<td>151.3</td>
</tr>
<tr>
<td>mac SSD</td>
<td>17MB/s</td>
<td>450MB/s</td>
<td>26.4</td>
</tr>
<tr>
<td>linux SSD</td>
<td>54MB/s</td>
<td>1023MB/s</td>
<td>18.9</td>
</tr>
</tbody>
</table>
<p>The above is the write speed of co/log and glog (single thread, 1 million logs). It can be seen that co/log is nearly two orders of magnitude faster than glog.</p>
<table>
<thead>
<tr>
<th>threads</th>
<th>linux co/log</th>
<th>linux spdlog</th>
<th>win co/log</th>
<th>win spdlog</th>
<th>speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0.087235</td>
<td>2.076172</td>
<td>0.117704</td>
<td>0.461156</td>
<td>23.8/3.9</td>
</tr>
<tr>
<td>2</td>
<td>0.183160</td>
<td>3.729386</td>
<td>0.158122</td>
<td>0.511769</td>
<td>20.3/3.2</td>
</tr>
<tr>
<td>4</td>
<td>0.206712</td>
<td>4.764238</td>
<td>0.316607</td>
<td>0.743227</td>
<td>23.0/2.3</td>
</tr>
<tr>
<td>8</td>
<td>0.302088</td>
<td>3.963644</td>
<td>0.406025</td>
<td>1.417387</td>
<td>13.1/3.5</td>
</tr>
</tbody>
</table>
<p>The above is the time of <a href="https://github.com/idealvin/coost/tree/benchmark">printing 1 million logs with 1, 2, 4, and 8 threads</a>, in seconds. Speedup is the performance improvement of co/log compared to spdlog on linux and windows platforms.</p>
<h3 id="unitest"><a class="anchor" href="#unitest">#</a>unitest</h3>
<p><strong><a href="../../co/unitest/">unitest</a></strong> is a simple and easy-to-use unit test framework. Many components in coost use it to write unit test code, which guarantees the stability of coost.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/unitest.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/os.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">namespace</span> test {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>DEF_test(os) {
</span></span><span style="display:flex;"><span>    DEF_case(homedir) {
</span></span><span style="display:flex;"><span>        EXPECT_NE(os<span style="color:#000;font-weight:bold">::</span>homedir(), <span style="color:#d14">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DEF_case(cpunum) {
</span></span><span style="display:flex;"><span>        EXPECT_GT(os<span style="color:#000;font-weight:bold">::</span>cpunum(), <span style="color:#099">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>} <span style="color:#998;font-style:italic">// namespace test
</span></span></span></code></pre></div><p>The above is a simple example. The <code>DEF_test</code> macro defines a test unit, which is actually a function (a method in a class). The <code>DEF_case</code> macro defines test cases, and each test case is actually a code block. The main function is simple as below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/unitest.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>    unitest<span style="color:#000;font-weight:bold">::</span>run_all_tests();
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The directory <a href="https://github.com/idealvin/coost/tree/master/unitest">unitest</a> contains the unit test code in coost. Users can run unitest with the following commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xmake r unitest -a   <span style="color:#998;font-style:italic"># Run all test cases</span>
</span></span><span style="display:flex;"><span>xmake r unitest -os  <span style="color:#998;font-style:italic"># Run test cases in the os unit</span>
</span></span></code></pre></div><h3 id="json"><a class="anchor" href="#json">#</a>JSON</h3>
<p>In coost v3.0, <strong><a href="https://github.com/idealvin/coost/blob/master/include/co/json.h">Json</a></strong> provides <strong>fluent APIs</strong>, which is more convenient to use.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// {&#34;a&#34;:23,&#34;b&#34;:false,&#34;s&#34;:&#34;123&#34;,&#34;v&#34;:[1,2,3],&#34;o&#34;:{&#34;xx&#34;:0}}
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Json x <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>    { <span style="color:#d14">&#34;a&#34;</span>, <span style="color:#099">23</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#d14">&#34;b&#34;</span>, <span style="color:#0086b3">false</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#d14">&#34;s&#34;</span>, <span style="color:#d14">&#34;123&#34;</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#d14">&#34;v&#34;</span>, {<span style="color:#099">1</span>,<span style="color:#099">2</span>,<span style="color:#099">3</span>} },
</span></span><span style="display:flex;"><span>    { <span style="color:#d14">&#34;o&#34;</span>, {
</span></span><span style="display:flex;"><span>        {<span style="color:#d14">&#34;xx&#34;</span>, <span style="color:#099">0</span>}
</span></span><span style="display:flex;"><span>    }},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// equal to x
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>Json y <span style="color:#000;font-weight:bold">=</span> Json()
</span></span><span style="display:flex;"><span>    .add_member(<span style="color:#d14">&#34;a&#34;</span>, <span style="color:#099">23</span>)
</span></span><span style="display:flex;"><span>    .add_member(<span style="color:#d14">&#34;b&#34;</span>, <span style="color:#0086b3">false</span>)
</span></span><span style="display:flex;"><span>    .add_member(<span style="color:#d14">&#34;s&#34;</span>, <span style="color:#d14">&#34;123&#34;</span>)
</span></span><span style="display:flex;"><span>    .add_member(<span style="color:#d14">&#34;v&#34;</span>, Json().push_back(<span style="color:#099">1</span>).push_back(<span style="color:#099">2</span>).push_back(<span style="color:#099">3</span>))
</span></span><span style="display:flex;"><span>    .add_member(<span style="color:#d14">&#34;o&#34;</span>, Json().add_member(<span style="color:#d14">&#34;xx&#34;</span>, <span style="color:#099">0</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x.get(<span style="color:#d14">&#34;a&#34;</span>).as_int();       <span style="color:#998;font-style:italic">// 23
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x.get(<span style="color:#d14">&#34;s&#34;</span>).as_string();    <span style="color:#998;font-style:italic">// &#34;123&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x.get(<span style="color:#d14">&#34;s&#34;</span>).as_int();       <span style="color:#998;font-style:italic">// 123, string -&gt; int
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x.get(<span style="color:#d14">&#34;v&#34;</span>, <span style="color:#099">0</span>).as_int();    <span style="color:#998;font-style:italic">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x.get(<span style="color:#d14">&#34;v&#34;</span>, <span style="color:#099">2</span>).as_int();    <span style="color:#998;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x.get(<span style="color:#d14">&#34;o&#34;</span>, <span style="color:#d14">&#34;xx&#34;</span>).as_int(); <span style="color:#998;font-style:italic">// 0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>x[<span style="color:#d14">&#34;a&#34;</span>] <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">23</span>;          <span style="color:#998;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x[<span style="color:#d14">&#34;s&#34;</span>] <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;123&#34;</span>;       <span style="color:#998;font-style:italic">// true
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>x.get(<span style="color:#d14">&#34;o&#34;</span>, <span style="color:#d14">&#34;xx&#34;</span>) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>; <span style="color:#998;font-style:italic">// false
</span></span></span></code></pre></div><h3 id="coroutine"><a class="anchor" href="#coroutine">#</a>Coroutine</h3>
<p>coost has implemented a <a href="https://github.com/golang/go">go-style</a> coroutine, which has the following features:</p>
<ul>
<li>Support multi-thread scheduling, the default number of threads is the number of system CPU cores.</li>
<li>Shared stack, coroutines in the same thread share several stacks (the default size is 1MB), and the memory usage is low.</li>
<li>There is a flat relationship between coroutines, and new coroutines can be created from anywhere (including in coroutines).</li>
<li>Support coroutine synchronization events, coroutine locks, channels, and waitgroups.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/co.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>WaitGroup wg;
</span></span><span style="display:flex;"><span>    wg.add(<span style="color:#099">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    go([wg](){
</span></span><span style="display:flex;"><span>        LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello world&#34;</span>;
</span></span><span style="display:flex;"><span>        wg.done();
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    go([wg](){
</span></span><span style="display:flex;"><span>        LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello again&#34;</span>;
</span></span><span style="display:flex;"><span>        wg.done();
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    wg.wait();
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the above code, the coroutines created by <code>go()</code> will be evenly distributed to different scheduling threads. Users can also control the scheduling of coroutines by themselves:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// run f1 and f2 in the same scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">auto</span> s <span style="color:#000;font-weight:bold">=</span> co<span style="color:#000;font-weight:bold">::</span>next_scheduler();
</span></span><span style="display:flex;"><span>s<span style="color:#000;font-weight:bold">-&gt;</span>go(f1);
</span></span><span style="display:flex;"><span>s<span style="color:#000;font-weight:bold">-&gt;</span>go(f2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// run f in all schedulers
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">for</span> (<span style="color:#000;font-weight:bold">auto</span><span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#900;font-weight:bold">s</span> : co<span style="color:#000;font-weight:bold">::</span>schedulers()) {
</span></span><span style="display:flex;"><span>    s<span style="color:#000;font-weight:bold">-&gt;</span>go(f);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="network-programming"><a class="anchor" href="#network-programming">#</a>network programming</h3>
<p>coost provides a coroutine-based network programming framework, which can be roughly divided into 3 parts:</p>
<ul>
<li><strong><a href="../../co/coroutine/#coroutineized-socket-api">coroutineized socket API</a></strong>, similar in form to the system socket API, users familiar with socket programming can easily write high-performance network programs in a synchronous manner.</li>
<li><a href="../../co/net/tcp/">TCP</a>, <a href="../../co/net/http/">HTTP</a>, <a href="../../co/net/rpc/">RPC</a> and other high-level network programming components, compatible with IPv6, also support SSL, it is more convenient to use than socket API.</li>
<li><strong><a href="../../co/coroutine/#system-api-hook">System API hook</a></strong>, with which, third-party network libraries can be used directly in coroutines.</li>
</ul>
<p><strong>RPC server</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/co.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/rpc.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/time.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rpc<span style="color:#000;font-weight:bold">::</span>Server()
</span></span><span style="display:flex;"><span>        .add_service(<span style="color:#000;font-weight:bold">new</span> xx<span style="color:#000;font-weight:bold">::</span>HelloWorldImpl)
</span></span><span style="display:flex;"><span>        .start(<span style="color:#d14">&#34;127.0.0.1&#34;</span>, <span style="color:#099">7788</span>, <span style="color:#d14">&#34;/xx&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> (;;) sleep<span style="color:#000;font-weight:bold">::</span>sec(<span style="color:#099">80000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>rpc::Server</code> also supports HTTP protocol, you may use the POST method to call the RPC service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl http://127.0.0.1:7788/xx --request POST --data <span style="color:#d14">&#39;{&#34;api&#34;:&#34;ping&#34;}&#39;</span>
</span></span></code></pre></div><p><strong>Static web server</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/flag.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/http.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>DEF_string(d, <span style="color:#d14">&#34;.&#34;</span>, <span style="color:#d14">&#34;root dir&#34;</span>); <span style="color:#998;font-style:italic">// docroot for the web server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>    so<span style="color:#000;font-weight:bold">::</span>easy(FLG_d.c_str()); <span style="color:#998;font-style:italic">// mum never have to worry again
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>HTTP server</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">cb</span>(<span style="color:#000;font-weight:bold">const</span> http<span style="color:#000;font-weight:bold">::</span>Req<span style="color:#000;font-weight:bold">&amp;</span> req, http<span style="color:#000;font-weight:bold">::</span>Res<span style="color:#000;font-weight:bold">&amp;</span> res) {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (req.is_method_get()) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (req.url() <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;/hello&#34;</span>) {
</span></span><span style="display:flex;"><span>            res.set_status(<span style="color:#099">200</span>);
</span></span><span style="display:flex;"><span>            res.set_body(<span style="color:#d14">&#34;hello world&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            res.set_status(<span style="color:#099">404</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        res.set_status(<span style="color:#099">405</span>); <span style="color:#998;font-style:italic">// method not allowed
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// http
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>http<span style="color:#000;font-weight:bold">::</span>Server().on_req(cb).start(<span style="color:#d14">&#34;0.0.0.0&#34;</span>, <span style="color:#099">80</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// https
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>http<span style="color:#000;font-weight:bold">::</span>Server().on_req(cb).start(
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;0.0.0.0&#34;</span>, <span style="color:#099">443</span>, <span style="color:#d14">&#34;privkey.pem&#34;</span>, <span style="color:#d14">&#34;certificate.pem&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p><strong>HTTP client</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    http<span style="color:#000;font-weight:bold">::</span>Client c(<span style="color:#d14">&#34;https://github.com&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    c.get(<span style="color:#d14">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;response code: &#34;</span><span style="color:#000;font-weight:bold">&lt;&lt;</span> c.status();
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;body size: &#34;</span><span style="color:#000;font-weight:bold">&lt;&lt;</span> c.body().size();
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;Content-Length: &#34;</span><span style="color:#000;font-weight:bold">&lt;&lt;</span> c.header(<span style="color:#d14">&#34;Content-Length&#34;</span>);
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> c.header();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    c.post(<span style="color:#d14">&#34;/hello&#34;</span>, <span style="color:#d14">&#34;data xxx&#34;</span>);
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;response code: &#34;</span><span style="color:#000;font-weight:bold">&lt;&lt;</span> c.status();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(f);
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

  



  
    
  
    
  


  


<div class="book-languages" tabindex="0" aria-haspopup="true">
  <ul>
    <li class="flex align-center">
      <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
      English
    </li> 
  </ul>

  <ul class="book-languages-list">
    
    <li class="">
      <a href="../../../cn/about/co/" class="flex align-center">
        <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
        ä¸­æ–‡
      </a>
    </li>
    
    <li class="active">
      <a href="../../../en/" class="flex align-center">
        <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </li>
    
  </ul>
</div>




  <div class="book-date"><a class="flex align-center" href="https://github.com/cocoyaxi/codoc/commit/7f991b2b846a2f6a9523863182a0ea0f525128ed" title='Last modified by idealvin | October 6, 2022' target="_blank" rel="noopener">
      <img src="../../../svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>October 6, 2022</span>
    </a>
  </div>



  <div class="book-edit">
    <a class="flex align-center" href="https://github.com/cocoyaxi/codoc/edit/master/content/en/about/co.md" target="_blank" rel="noopener">
      <img src="../../../svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        





<script src="//cdn.bootcss.com/highlight.js/11.1.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/cpp.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/bash.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/lua.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/yaml.min.js"></script>
<script>hljs.configure({ languages: [] }); hljs.initHighlightingOnLoad();</script>





      </footer>

      
  
  <div class="book-comments">


<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '11f9ff9ca43804d70b32',
    clientSecret: '07e2bd5b09a1654e7942a7698c3ec164e7566177',
    repo: 'gitalk',
    owner: 'idealvin',
    admin: ['idealvin'],
    id: location.pathname,
    language: 'zh-CN',
    distractionFreeMode: false,
    proxy: 'https:\/\/cors-anywhere.azm.workers.dev\/https:\/\/github.com\/login\/oauth\/access_token'
  })
  gitalk.render('gitalk-container');
</script></div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-coost">What is coost</a></li>
        <li><a href="#history-of-coost">History of coost</a></li>
        <li><a href="#quick-start">Quick Start</a>
          <ul>
            <li><a href="#compiling">Compiling</a></li>
            <li><a href="#develop-c-programs-with-coost">Develop C++ programs with coost</a></li>
          </ul>
        </li>
        <li><a href="#performance">Performance</a>
          <ul>
            <li><a href="#memory-allocator">Memory allocator</a></li>
            <li><a href="#log-library">Log library</a></li>
            <li><a href="#json-library">JSON library</a></li>
          </ul>
        </li>
        <li><a href="#core-features">Core features</a>
          <ul>
            <li><a href="#god-oriented-programming">God-oriented programming</a></li>
            <li><a href="#flag">flag</a></li>
            <li><a href="#log">log</a></li>
            <li><a href="#unitest">unitest</a></li>
            <li><a href="#json">JSON</a></li>
            <li><a href="#coroutine">Coroutine</a></li>
            <li><a href="#network-programming">network programming</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












