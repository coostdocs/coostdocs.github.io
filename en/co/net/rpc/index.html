<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="include: co/rpc.h.
Coost implements a coroutine-based RPC framework, which internally uses JSON as the data exchange format. Compared with RPC frameworks using binary protocols such as protobuf, it is more flexible and easier to use.
Since v3.0, the RPC framework also supports HTTP protocol, and we are able to send a RPC request with the HTTP POST method. #rpc::Service class Service { public: Service() = default; virtual ~Service() = default; typedef std::function&lt;void(Json&amp;, Json&amp;)&gt; Fun; virtual const char* name() const = 0; virtual const co::map&lt;const char*, Fun&gt;&amp; methods() const = 0; }; This class is a pure interface, which represents a RPC service.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="RPC" />
<meta property="og:description" content="include: co/rpc.h.
Coost implements a coroutine-based RPC framework, which internally uses JSON as the data exchange format. Compared with RPC frameworks using binary protocols such as protobuf, it is more flexible and easier to use.
Since v3.0, the RPC framework also supports HTTP protocol, and we are able to send a RPC request with the HTTP POST method. #rpc::Service class Service { public: Service() = default; virtual ~Service() = default; typedef std::function&lt;void(Json&amp;, Json&amp;)&gt; Fun; virtual const char* name() const = 0; virtual const co::map&lt;const char*, Fun&gt;&amp; methods() const = 0; }; This class is a pure interface, which represents a RPC service." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://coostdocs.github.io/en/co/net/rpc/" /><meta property="article:section" content="co" />

<meta property="article:modified_time" content="2023-09-09T08:51:44+08:00" />

<title>RPC | Documents for Coost</title>
<link rel="manifest" href="../../../../manifest.json">
<link rel="icon" href="../../../../favicon.png" type="image/x-icon">
  <link rel="alternate" hreflang="cn" href="https://coostdocs.github.io/cn/co/net/rpc/" title="RPC">
<link rel="stylesheet" href="../../../../book.min.e64f6734cb67825f25e10bdd1164b6a6045cb02f3f55987979761a7be73c4787.css" integrity="sha256-5k9nNMtngl8l4QvdEWS2pgRcsC8/VZh5eXYae&#43;c8R4c=" crossorigin="anonymous">
  <script defer src="../../../../flexsearch.min.js"></script>
  <script defer src="../../../../en.search.min.0d32128d3d724eba79cf6c00c8e570bfc9c785e6617b9adc0fa987ea55b53a21.js" integrity="sha256-DTISjT1yTrp5z2wAyOVwv8nHheZhe5rcD6mH6lW1OiE=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  


<link href='../../../../css/github.css' rel='stylesheet' type='text/css' />


</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="../../../../cn/"><span>Documents for Coost</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>About</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../en/about/co/" class="">Introduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/about/contact/" class="">Contact</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/about/sponsor/" class="">SponsorðŸ’•</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Documents</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/def/" class="">Basic Definitions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/god/" class="">God Oriented Programming</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/mem/" class="">Memory Allocation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/flag/" class="">flag</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/log/" class="">log</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/unitest/" class="">Unitest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/benchmark/" class="">Benchmark</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/json/" class="">JSON</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b823a0d731c4d472c5b015b832e5d976" class="toggle"  />
    <label for="section-b823a0d731c4d472c5b015b832e5d976" class="flex justify-between">
      <a role="button" class="">Concurrency</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/atomic/" class="">Atomic Operations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/thread/" class="">Thread</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a8bcee0f770e9eedef784caa025649c4" class="toggle"  />
    <label for="section-a8bcee0f770e9eedef784caa025649c4" class="flex justify-between">
      <a role="button" class="">Coroutine</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/basic/" class="">Basic concepts</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/api/" class="">APIs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/chan/" class="">Channel</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/event/" class="">Sync Event</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/io_event/" class="">IO Event</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/mutex/" class="">Mutex Lock</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/wg/" class="">Wait Group</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/pool/" class="">Coroutine Pool</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/concurrency/coroutine/conf/" class="">Config</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-752f64a904309658adbf6062b2c3d8c1" class="toggle" checked />
    <label for="section-752f64a904309658adbf6062b2c3d8c1" class="flex justify-between">
      <a role="button" class="">Network Programming</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/byte_order/" class="">Byte order</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/sock/" class="">Socket programming</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/mode/" class="">Network programming model</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/third/" class="">Use third-party network libraries</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/tcp/" class="">TCP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/http/" class="">HTTP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/net/rpc/" class=" active">RPC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-76a5d3cff40a8cc3b003b19d517c02e9" class="toggle"  />
    <label for="section-76a5d3cff40a8cc3b003b19d517c02e9" class="flex justify-between">
      <a role="button" class="">others</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/console/" class="">Console</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/defer/" class="">defer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/error/" class="">Error</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/fastring/" class="">fastring</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/fastream/" class="">fastream</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/stl/" class="">STL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/str/" class="">String Utility</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/rand/" class="">Random Value</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/hash/" class="">Hash</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/time/" class="">Time</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/tasked/" class="">Timed task scheduler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/path/" class="">Path</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/fs/" class="">File System</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/other/os/" class="">Operating System</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../en/co/build/" class="">Compiling</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>RPC</strong>

  <label for="toc-control">
    
    <img src="../../../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#rpcservice">rpc::Service</a></li>
        <li><a href="#rpcserver">rpc::Server</a>
          <ul>
            <li><a href="#serverserver">Server::Server</a></li>
            <li><a href="#serveradd_service">Server::add_service</a></li>
            <li><a href="#serverstart">Server::start</a></li>
            <li><a href="#serverexit">Server::exit</a></li>
          </ul>
        </li>
        <li><a href="#rpc-server-example">RPC server example</a>
          <ul>
            <li><a href="#define-a-proto-file">Define a proto file</a></li>
            <li><a href="#generate-code-for-rpc-service">Generate code for RPC service</a></li>
            <li><a href="#implement-the-rpc-service">Implement the RPC service</a></li>
            <li><a href="#start-rpc-server">Start RPC server</a></li>
            <li><a href="#call-rpc-service-with-curl">Call RPC service with curl</a></li>
          </ul>
        </li>
        <li><a href="#rpcclient">rpc::Client</a>
          <ul>
            <li><a href="#clientclient">Client::Client</a></li>
            <li><a href="#clientclient-1">Client::~Client</a></li>
            <li><a href="#clientcall">Client::call</a></li>
            <li><a href="#clientclose">Client::close</a></li>
            <li><a href="#clientping">Client::ping</a></li>
          </ul>
        </li>
        <li><a href="#rpc-client-example">RPC client example</a>
          <ul>
            <li><a href="#use-rpcclient-directly">Use rpc::Client directly</a></li>
            <li><a href="#use-connection-pool">Use connection pool</a></li>
          </ul>
        </li>
        <li><a href="#config-items">Config items</a>
          <ul>
            <li><a href="#rpc_conn_idle_sec">rpc_conn_idle_sec</a></li>
            <li><a href="#rpc_conn_timeout">rpc_conn_timeout</a></li>
            <li><a href="#rpc_log">rpc_log</a></li>
            <li><a href="#rpc_max_idle_conn">rpc_max_idle_conn</a></li>
            <li><a href="#rpc_max_msg_size">rpc_max_msg_size</a></li>
            <li><a href="#rpc_recv_timeout">rpc_recv_timeout</a></li>
            <li><a href="#rpc_send_timeout">rpc_send_timeout</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>include: <a href="https://github.com/idealvin/coost/blob/master/include/co/rpc.h">co/rpc.h</a>.</p>
<p>Coost implements a coroutine-based RPC framework, which internally uses <strong>JSON</strong> as the data exchange format. Compared with RPC frameworks using binary protocols such as protobuf, it is more flexible and easier to use.</p>
<blockquote class="book-hint info">
  Since v3.0, the RPC framework also supports HTTP protocol, and we are able to send a RPC request with the HTTP POST method.
</blockquote>

<h2 id="rpcservice"><a class="anchor" href="#rpcservice">#</a>rpc::Service</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Service</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">     <span class="n">Service</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">virtual</span> <span class="o">~</span><span class="n">Service</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">Json</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">Fun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">name</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="k">virtual</span> <span class="k">const</span> <span class="n">co</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="n">Fun</span><span class="o">&gt;&amp;</span> <span class="n">methods</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><ul>
<li>This class is a pure interface, which represents a RPC service. A RPC server may have multiple services.</li>
<li><code>name()</code> returns the service name, <code>methods()</code> returns all the RPC methods.</li>
</ul>
<h2 id="rpcserver"><a class="anchor" href="#rpcserver">#</a>rpc::Server</h2>
<h3 id="serverserver"><a class="anchor" href="#serverserver">#</a>Server::Server</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">Server</span><span class="p">();</span>
</span></span></code></pre></div><ul>
<li>The default constructor, users do not need to care.</li>
</ul>
<h3 id="serveradd_service"><a class="anchor" href="#serveradd_service">#</a>Server::add_service</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="n">Server</span><span class="o">&amp;</span> <span class="n">add_service</span><span class="p">(</span><span class="n">rpc</span><span class="o">::</span><span class="n">Service</span><span class="o">*</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="n">Server</span><span class="o">&amp;</span> <span class="n">add_service</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rpc</span><span class="o">::</span><span class="n">Service</span><span class="o">&gt;&amp;</span> <span class="n">s</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Add a service, the parameter <code>s</code> in the first one must be dynamically created with <code>operator new</code>.</li>
<li>Users can call this method multiple times to add multiple services, and <strong>different services must have different names</strong>.</li>
</ul>
<h3 id="serverstart"><a class="anchor" href="#serverstart">#</a>Server::start</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">start</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="o">=</span><span class="s">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ca</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Start the RPC server, this method will not block the current thread.</li>
<li>The parameter <code>ip</code> is the server ip, which can be an IPv4 or IPv6 address, and the parameter <code>port</code> is the server port.</li>
<li>The parameter <code>url</code> is the url of the HTTP server, and must start with <code>/</code>.</li>
<li>The parameter <strong>key</strong> is path of a <strong>PEM</strong>file which stores the SSL private key, and the parameter <strong>ca</strong> is path of a PEM file which stores the SSL certificate. They are NULL by default, and SSL is disabled.</li>
<li>Starting from v3.0, the server no longer depends on the <code>rpc::Server</code> object after startup.</li>
</ul>
<h3 id="serverexit"><a class="anchor" href="#serverexit">#</a>Server::exit</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">exit</span><span class="p">();</span>
</span></span></code></pre></div><ul>
<li>Added since v2.0.2.</li>
<li>Exit the RPC server, close the listening socket, and no longer receive new connections.</li>
<li>Since v3.0, after the RPC server exits, previously established connections will be reset in the future.</li>
</ul>
<h2 id="rpc-server-example"><a class="anchor" href="#rpc-server-example">#</a>RPC server example</h2>
<h3 id="define-a-proto-file"><a class="anchor" href="#define-a-proto-file">#</a>Define a proto file</h3>
<p>Here is a simple proto file hello_world.proto:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">package</span> <span class="n">xx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">service</span> <span class="n">HelloWorld</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hello</span>
</span></span><span class="line"><span class="cl">    <span class="n">world</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>package</strong> defines the package name.</p>
<ul>
<li>
<p><strong>package</strong> defines the package name, which corresponds to <strong>namespace</strong> in C++.</p>
</li>
<li>
<p><strong>service</strong> defines a RPC service, it has 2 methods, hello and world.</p>
</li>
<li>
<p>Since the RPC request and response are both JSON, there is no need to define the structure in the proto file.</p>
</li>
<li>
<p>At most one service can be defined in a proto file.</p>
</li>
</ul>
<blockquote class="book-hint info">
  Coost v3.0.1 rewrote <a href="https://github.com/idealvin/coost/tree/master/gen">gen</a> with flex and <a href="https://invisible-island.net/byacc/">byacc</a>, and we can alse define object (struct) in the proto file. For specific usage, please refer to <a href="https://github.com/idealvin/coost/tree/master/test/j2s">j2s</a>.
</blockquote>

<h3 id="generate-code-for-rpc-service"><a class="anchor" href="#generate-code-for-rpc-service">#</a>Generate code for RPC service</h3>
<p><a href="https://github.com/idealvin/coost/tree/master/gen">gen</a> is the RPC code generator provided by coost, which can be used to generate code for RPC service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">xmake -b gen             <span class="c1"># build gen</span>
</span></span><span class="line"><span class="cl">cp gen /usr/local/bin    <span class="c1"># put gen in the /usr/local/bin directory</span>
</span></span><span class="line"><span class="cl">gen hello_world.proto    <span class="c1"># Generate code</span>
</span></span></code></pre></div><p>The generated file hello_world.proto is as follow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Autogenerated.
</span></span></span><span class="line"><span class="cl"><span class="c1">// DO NOT EDIT. All changes will be undone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;co/rpc.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">xx</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HelloWorld</span> <span class="o">:</span> <span class="k">public</span> <span class="n">rpc</span><span class="o">::</span><span class="n">Service</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">Json</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">Fun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HelloWorld</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_methods</span><span class="p">[</span><span class="s">&#34;HelloWorld.hello&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HelloWorld</span><span class="o">::</span><span class="n">hello</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_methods</span><span class="p">[</span><span class="s">&#34;HelloWorld.world&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HelloWorld</span><span class="o">::</span><span class="n">world</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="o">~</span><span class="n">HelloWorld</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;HelloWorld&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="k">const</span> <span class="n">co</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="n">Fun</span><span class="o">&gt;&amp;</span> <span class="n">methods</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_methods</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">hello</span><span class="p">(</span><span class="n">Json</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">world</span><span class="p">(</span><span class="n">Json</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">co</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="n">Fun</span><span class="o">&gt;</span> <span class="n">_methods</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">// xx
</span></span></span></code></pre></div><ul>
<li>As you can see, the <code>HelloWorld</code> class inherits from <a href="#rpcservice">rpc::Service</a>, and it has already implemented <code>name()</code> and <code>methods()</code> in <code>rpc::Service</code>.</li>
<li>Users only need to inherit the <code>HelloWorld</code> class and implement the methods <code>hello</code> and <code>world</code>.</li>
</ul>
<h3 id="implement-the-rpc-service"><a class="anchor" href="#implement-the-rpc-service">#</a>Implement the RPC service</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;hello_world.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">xx</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HelloWorldImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">HelloWorld</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HelloWorldImpl</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="o">~</span><span class="n">HelloWorldImpl</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">hello</span><span class="p">(</span><span class="n">Json</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> <span class="s">&#34;result&#34;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span> <span class="s">&#34;hello&#34;</span><span class="p">,</span> <span class="mi">23</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">world</span><span class="p">(</span><span class="n">Json</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> <span class="s">&#34;error&#34;</span><span class="p">,</span> <span class="s">&#34;not supported&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">// xx
</span></span></span></code></pre></div><ul>
<li>The above is just a very simple example. In actual applications, it is generally necessary to perform corresponding business processing according to the parameters in <code>req</code>, and then fill in <code>res</code>.</li>
</ul>
<h3 id="start-rpc-server"><a class="anchor" href="#start-rpc-server">#</a>Start RPC server</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">rpc</span><span class="o">::</span><span class="n">Server</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">add_service</span><span class="p">(</span><span class="k">new</span> <span class="n">xx</span><span class="o">::</span><span class="n">HelloWorldImpl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="mi">7788</span><span class="p">,</span> <span class="s">&#34;/xx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="n">sleep</span><span class="o">::</span><span class="n">sec</span><span class="p">(</span><span class="mi">80000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>First call <a href="#serveradd_service">add_service()</a> to add the service, then call <a href="#serverstart">start()</a> to start the server.</li>
</ul>
<blockquote class="book-hint info">
  The <code>start()</code> method will not block the current thread, so we need a for loop to prevent the main function from exiting.
</blockquote>

<h3 id="call-rpc-service-with-curl"><a class="anchor" href="#call-rpc-service-with-curl">#</a>Call RPC service with curl</h3>
<p>In v3.0, the RPC framework supports HTTP protocol, so we can call the RPC service with the <code>curl</code> command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl http://127.0.0.1:7788/xx --request POST --data <span class="s1">&#39;{&#34;api&#34;:&#34;ping&#34;}&#39;</span>
</span></span><span class="line"><span class="cl">curl http://127.0.0.1:7788/xx --request POST --data <span class="s1">&#39;{&#34;api&#34;:&#34;HelloWorld.hello&#34;}&#39;</span>
</span></span></code></pre></div><ul>
<li>
<p>The above use <code>curl</code> to send a POST request to the RPC server, the parameter is a JSON string, and a <code>&quot;api&quot;</code> field must be provided to indicate the RPC method to be called.</p>
</li>
<li>
<p><code>&quot;ping&quot;</code> is a built-in method of the RPC framework, generally used for testing or sending heartbeats.</p>
</li>
<li>
<p><code>/xx</code> in the url should be consistent with the url specified when the RPC server is started.</p>
</li>
</ul>
<h2 id="rpcclient"><a class="anchor" href="#rpcclient">#</a>rpc::Client</h2>
<h3 id="clientclient"><a class="anchor" href="#clientclient">#</a>Client::Client</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="n">Client</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">use_ssl</span><span class="o">=</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mf">2.</span> <span class="n">Client</span><span class="p">(</span><span class="k">const</span> <span class="n">Client</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>1, the parameter <code>ip</code> is ip of the server, which can be a domain name, IPv4 or IPv6 address; the parameter <code>port</code> is port of the server; the parameter <code>use_ssl</code> indicates whether to enable SSL transmission, the default is false, and SSL is disabled.</li>
</ul>
<blockquote class="book-hint info">
  When rpc::Client was constructed, the connection is not established immediately.
</blockquote>

<h3 id="clientclient-1"><a class="anchor" href="#clientclient-1">#</a>Client::~Client</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">Client</span><span class="o">::~</span><span class="n">Client</span><span class="p">();</span>
</span></span></code></pre></div><ul>
<li>Destructor, close the internal connection.</li>
</ul>
<h3 id="clientcall"><a class="anchor" href="#clientcall">#</a>Client::call</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">call</span><span class="p">(</span><span class="k">const</span> <span class="n">Json</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">Json</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Perform a RPC request, it must be called in coroutine.</li>
<li>The parameter <code>req</code> must contain the <code>&quot;api&quot;</code> field, its value is generally in the form of <code>&quot;service.method&quot;</code>.</li>
<li>The parameter <code>res</code> is the response of the RPC request.</li>
<li>If the RPC request is not sent, or no response from the server is received, res will not be filled.</li>
<li>This method checks the connection status before sending the RPC request, and establishes the connection first if it is not connected.</li>
</ul>
<h3 id="clientclose"><a class="anchor" href="#clientclose">#</a>Client::close</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">close</span><span class="p">();</span>
</span></span></code></pre></div><ul>
<li>Close the connection, it is safe to call this function multiple times.</li>
</ul>
<h3 id="clientping"><a class="anchor" href="#clientping">#</a>Client::ping</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ping</span><span class="p">();</span>
</span></span></code></pre></div><ul>
<li>Send a <code>ping</code> request to the server, generally used for testing or sending heartbeats.</li>
</ul>
<h2 id="rpc-client-example"><a class="anchor" href="#rpc-client-example">#</a>RPC client example</h2>
<h3 id="use-rpcclient-directly"><a class="anchor" href="#use-rpcclient-directly">#</a>Use rpc::Client directly</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_bool</span><span class="p">(</span><span class="n">use_ssl</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="s">&#34;use ssl if true&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#34;request num&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">client_fun</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc</span><span class="o">::</span><span class="n">Client</span> <span class="n">c</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="mi">7788</span><span class="p">,</span> <span class="n">FLG_use_ssl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FLG_n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">co</span><span class="o">::</span><span class="n">Json</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s">&#34;api&#34;</span><span class="p">,</span> <span class="s">&#34;HelloWorld.hello&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">co</span><span class="o">::</span><span class="n">Json</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">co</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">go</span><span class="p">(</span><span class="n">client_fun</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>In the above example, the client sends an RPC request to the server every 1 second.</li>
</ul>
<h3 id="use-connection-pool"><a class="anchor" href="#use-connection-pool">#</a>Use connection pool</h3>
<p>When a client needs to establish a large number of connections, <a href="../../concurrency/coroutine/pool/">co::pool</a> can be used to manage these connections.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">rpc</span><span class="o">::</span><span class="n">Client</span><span class="o">&gt;</span> <span class="n">proto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">co</span><span class="o">::</span><span class="n">pool</span> <span class="n">pool</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[]()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="k">new</span> <span class="n">rpc</span><span class="o">::</span><span class="n">Client</span><span class="p">(</span><span class="o">*</span><span class="n">proto</span><span class="p">);</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">[](</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">delete</span> <span class="p">(</span><span class="n">rpc</span><span class="o">::</span><span class="n">Client</span><span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">client_fun</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">co</span><span class="o">::</span><span class="n">pool_guard</span><span class="o">&lt;</span><span class="n">rpc</span><span class="o">::</span><span class="n">Client</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">ping</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">co</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">proto</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">rpc</span><span class="o">::</span><span class="n">Client</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="mi">7788</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">go</span><span class="p">(</span><span class="n">client_fun</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>In the above example, co::pool is used to store the clients, and multiple coroutines can share these clients.</li>
<li>The ccb of co::pool uses copy construction to copy a client from <code>proto</code>.</li>
</ul>
<h2 id="config-items"><a class="anchor" href="#config-items">#</a>Config items</h2>
<p>Coost uses <a href="../../flag/">co.flag</a> to define config items for RPC.</p>
<h3 id="rpc_conn_idle_sec"><a class="anchor" href="#rpc_conn_idle_sec">#</a>rpc_conn_idle_sec</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">rpc_conn_idle_sec</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="s">&#34;#2 connection may be closed if no data...&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Timeout in <strong>seconds</strong> for idle connections in rpc::Server. If a connection does not receive any data within this time, the server may close the connection.</li>
</ul>
<h3 id="rpc_conn_timeout"><a class="anchor" href="#rpc_conn_timeout">#</a>rpc_conn_timeout</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">rpc_conn_timeout</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="s">&#34;#2 connect timeout in ms&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Connect timeout in milliseconds for rpc::Client.</li>
</ul>
<h3 id="rpc_log"><a class="anchor" href="#rpc_log">#</a>rpc_log</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_bool</span><span class="p">(</span><span class="n">rpc_log</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&#34;#2 enable rpc log if true&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Whether to print RPC logs, the default is true, rpc::Server and rpc::Client will print RPC requests and responses.</li>
</ul>
<h3 id="rpc_max_idle_conn"><a class="anchor" href="#rpc_max_idle_conn">#</a>rpc_max_idle_conn</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">rpc_max_idle_conn</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s">&#34;#2 max idle connections&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>Maximum number of idle connections for rpc::Server. The default is 128. When this number is exceeded, the server will close some idle connections.</li>
</ul>
<h3 id="rpc_max_msg_size"><a class="anchor" href="#rpc_max_msg_size">#</a>rpc_max_msg_size</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">rpc_max_msg_size</span><span class="p">,</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&#34;#2 max size of rpc message, default: 8M&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>The maximum length of RPC messages, the default is 8M.</li>
</ul>
<h3 id="rpc_recv_timeout"><a class="anchor" href="#rpc_recv_timeout">#</a>rpc_recv_timeout</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">rpc_recv_timeout</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="s">&#34;#2 recv timeout in ms&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>RPC recv timeout in milliseconds.</li>
</ul>
<h3 id="rpc_send_timeout"><a class="anchor" href="#rpc_send_timeout">#</a>rpc_send_timeout</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DEF_int32</span><span class="p">(</span><span class="n">rpc_send_timeout</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="s">&#34;#2 send timeout in ms&#34;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>RPC send timeout in milliseconds.</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

  



  
    
  
    
  


  


<div class="book-languages" tabindex="0" aria-haspopup="true">
  <ul>
    <li class="flex align-center">
      <img src="../../../../svg/translate.svg" class="book-icon" alt="Languages" />
      English
    </li> 
  </ul>

  <ul class="book-languages-list">
    
    <li class="">
      <a href="../../../../cn/co/net/rpc/" class="flex align-center">
        <img src="../../../../svg/translate.svg" class="book-icon" alt="Languages" />
        ä¸­æ–‡
      </a>
    </li>
    
    <li class="active">
      <a href="../../../../en/" class="flex align-center">
        <img src="../../../../svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </li>
    
  </ul>
</div>




  <div class="book-date"><a class="flex align-center" href="https://github.com/coostdocs/codoc/commit/265464652ec7af99f0d224db2a618227cb64a318" title='Last modified by idealvin | 2023/09/09' target="_blank" rel="noopener">
      <img src="../../../../svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>2023/09/09</span>
    </a>
  </div>



  <div class="book-edit">
    <a class="flex align-center" href="https://github.com/coostdocs/codoc/edit/master/content/en/co/net/rpc.md" target="_blank" rel="noopener">
      <img src="../../../../svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        





<script src="//cdn.bootcss.com/highlight.js/11.1.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/cpp.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/bash.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/lua.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/yaml.min.js"></script>
<script>hljs.configure({ languages: [] }); hljs.initHighlightingOnLoad();</script>





      </footer>

      
  
  <div class="book-comments">


<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '11f9ff9ca43804d70b32',
    clientSecret: '07e2bd5b09a1654e7942a7698c3ec164e7566177',
    repo: 'gitalk',
    owner: 'idealvin',
    admin: ['idealvin'],
    id: location.pathname,
    language: 'zh-CN',
    distractionFreeMode: false,
    proxy: 'https:\/\/cors-anywhere.azm.workers.dev\/https:\/\/github.com\/login\/oauth\/access_token'
  })
  gitalk.render('gitalk-container');
</script></div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#rpcservice">rpc::Service</a></li>
        <li><a href="#rpcserver">rpc::Server</a>
          <ul>
            <li><a href="#serverserver">Server::Server</a></li>
            <li><a href="#serveradd_service">Server::add_service</a></li>
            <li><a href="#serverstart">Server::start</a></li>
            <li><a href="#serverexit">Server::exit</a></li>
          </ul>
        </li>
        <li><a href="#rpc-server-example">RPC server example</a>
          <ul>
            <li><a href="#define-a-proto-file">Define a proto file</a></li>
            <li><a href="#generate-code-for-rpc-service">Generate code for RPC service</a></li>
            <li><a href="#implement-the-rpc-service">Implement the RPC service</a></li>
            <li><a href="#start-rpc-server">Start RPC server</a></li>
            <li><a href="#call-rpc-service-with-curl">Call RPC service with curl</a></li>
          </ul>
        </li>
        <li><a href="#rpcclient">rpc::Client</a>
          <ul>
            <li><a href="#clientclient">Client::Client</a></li>
            <li><a href="#clientclient-1">Client::~Client</a></li>
            <li><a href="#clientcall">Client::call</a></li>
            <li><a href="#clientclose">Client::close</a></li>
            <li><a href="#clientping">Client::ping</a></li>
          </ul>
        </li>
        <li><a href="#rpc-client-example">RPC client example</a>
          <ul>
            <li><a href="#use-rpcclient-directly">Use rpc::Client directly</a></li>
            <li><a href="#use-connection-pool">Use connection pool</a></li>
          </ul>
        </li>
        <li><a href="#config-items">Config items</a>
          <ul>
            <li><a href="#rpc_conn_idle_sec">rpc_conn_idle_sec</a></li>
            <li><a href="#rpc_conn_timeout">rpc_conn_timeout</a></li>
            <li><a href="#rpc_log">rpc_log</a></li>
            <li><a href="#rpc_max_idle_conn">rpc_max_idle_conn</a></li>
            <li><a href="#rpc_max_msg_size">rpc_max_msg_size</a></li>
            <li><a href="#rpc_recv_timeout">rpc_recv_timeout</a></li>
            <li><a href="#rpc_send_timeout">rpc_send_timeout</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












