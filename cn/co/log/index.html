<!DOCTYPE html>
<html lang="cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="include: co/log.h.
#简介 co/log 是一个类似 google glog 的 C&#43;&#43; 流式日志库，它像下面这样打印日志：
LOG &lt;&lt; &#34;hello world&#34; &lt;&lt; 23; // level log TLOG(&#34;topic&#34;) &lt;&lt; &#34;hello&#34; &lt;&lt; 23; // topic log co/log 支持两种类型的日志，level log 与 topic log(TLOG)。
#Level Log Level log 分为 debug, info, warning, error, fatal 5 个级别，并提供一系列的宏，用于打印不同级别的日志。
打印 fatal 级别的日志会终止程序的运行，co/log 还会在程序退出前打印函数调用栈信息，以方便追查程序崩溃的原因。
此类型的日志会写入同一个文件中，一般用于打印调试信息。
#Topic Log Topic log(TLOG) 没有级别之分，而是按主题分类。
此类型的日志，按主题写入不同的文件，一般用于打印业务日志，按业务功能划分，便于日志管理。
#性能 co/log 内部采用异步的实现方式，日志先写入缓存，达到一定量或超过一定时间后，由后台线程一次性写入文件，性能在不同平台比 glog 提升了 20~150 倍左右。下表是不同平台单线程连续打印 100 万条(每条 50 字节左右) info 日志的测试结果：
platform google glog co/log win2012 HHD 1.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="日志" />
<meta property="og:description" content="include: co/log.h.
#简介 co/log 是一个类似 google glog 的 C&#43;&#43; 流式日志库，它像下面这样打印日志：
LOG &lt;&lt; &#34;hello world&#34; &lt;&lt; 23; // level log TLOG(&#34;topic&#34;) &lt;&lt; &#34;hello&#34; &lt;&lt; 23; // topic log co/log 支持两种类型的日志，level log 与 topic log(TLOG)。
#Level Log Level log 分为 debug, info, warning, error, fatal 5 个级别，并提供一系列的宏，用于打印不同级别的日志。
打印 fatal 级别的日志会终止程序的运行，co/log 还会在程序退出前打印函数调用栈信息，以方便追查程序崩溃的原因。
此类型的日志会写入同一个文件中，一般用于打印调试信息。
#Topic Log Topic log(TLOG) 没有级别之分，而是按主题分类。
此类型的日志，按主题写入不同的文件，一般用于打印业务日志，按业务功能划分，便于日志管理。
#性能 co/log 内部采用异步的实现方式，日志先写入缓存，达到一定量或超过一定时间后，由后台线程一次性写入文件，性能在不同平台比 glog 提升了 20~150 倍左右。下表是不同平台单线程连续打印 100 万条(每条 50 字节左右) info 日志的测试结果：
platform google glog co/log win2012 HHD 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://coostdocs.github.io/cn/co/log/" /><meta property="article:section" content="co" />

<meta property="article:modified_time" content="2022-09-19T20:44:32+08:00" />

<title>日志 | Documents for Coost</title>
<link rel="manifest" href="../../../manifest.json">
<link rel="icon" href="../../../favicon.png" type="image/x-icon">
  <link rel="alternate" hreflang="en" href="https://coostdocs.github.io/en/co/log/" title="co/log">
<link rel="stylesheet" href="../../../book.min.34012a023bb86e99e9c5d444ca11c3e38625a1b8f226bf07e2360827bb149b14.css" integrity="sha256-NAEqAju4bpnpxdREyhHD44YlobjyJr8H4jYIJ7sUmxQ=" crossorigin="anonymous">
  <script defer src="../../../flexsearch.min.js"></script>
  <script defer src="../../../cn.search.min.f2f8f9cac63bf8044b0a1ec22aaecb38a4f829ded1cce9ae4558d3741a7849f5.js" integrity="sha256-8vj5ysY7&#43;ARLCh7CKq7LOKT4Kd7RzOmuRVjTdBp4SfU=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  


<link href='//cdn.bootcss.com/highlight.js/11.1.0/styles/github.min.css'
  rel='stylesheet' type='text/css' />


</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="../../../cn/"><span>Documents for Coost</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>关于</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/about/co/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/about/contact/" class="">联系</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/about/sponsor/" class="">赞助💕</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>CO 参考文档</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/def/" class="">基本定义</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/defer/" class="">defer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/atomic/" class="">原子操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/fastring/" class="">字符串(fastring)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/fastream/" class="">字符流(fastream)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/str/" class="">字符串操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/flag/" class="">命令行参数与配置文件解析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/log/" class=" active">日志</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/unitest/" class="">单元测试框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/json/" class="">JSON</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/time/" class="">时间</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/thread/" class="">线程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/coroutine/" class="">协程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-752f64a904309658adbf6062b2c3d8c1" class="toggle"  />
    <label for="section-752f64a904309658adbf6062b2c3d8c1" class="flex justify-between">
      <a role="button" class="">网络编程</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/byte_order/" class="">字节序</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/tcp/" class="">TCP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/http/" class="">HTTP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/rpc/" class="">RPC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/tasked/" class="">定时任务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/random/" class="">随机数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/lrumap/" class="">LruMap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/hash/" class="">Hash</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/path/" class="">文件路径(path)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/fs/" class="">文件系统</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/os/" class="">操作系统</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/build/" class="">编译</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>markdown文档示例</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/demo/demo/" class="">markdown模板文档</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>日志</strong>

  <label for="toc-control">
    
    <img src="../../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#简介">简介</a>
          <ul>
            <li><a href="#level-log">Level Log</a></li>
            <li><a href="#topic-log">Topic Log</a></li>
            <li><a href="#性能">性能</a></li>
          </ul>
        </li>
        <li><a href="#api">API</a>
          <ul>
            <li><a href="#logexit">log::exit</a></li>
            <li><a href="#logset_write_cb">log::set_write_cb</a></li>
            <li><a href="#v30-删除的-api">v3.0 删除的 API</a></li>
          </ul>
        </li>
        <li><a href="#level-log-1">Level Log</a>
          <ul>
            <li><a href="#基本用法">基本用法</a></li>
            <li><a href="#条件日志">条件日志</a></li>
            <li><a href="#每-n-条打印一次日志">每 N 条打印一次日志</a></li>
            <li><a href="#打印前-n-条日志">打印前 N 条日志</a></li>
          </ul>
        </li>
        <li><a href="#tlog">TLOG</a></li>
        <li><a href="#check-断言">CHECK 断言</a></li>
        <li><a href="#打印堆栈信息">打印堆栈信息</a></li>
        <li><a href="#配置项">配置项</a>
          <ul>
            <li><a href="#log_dir">log_dir</a></li>
            <li><a href="#log_file_name">log_file_name</a></li>
            <li><a href="#min_log_level">min_log_level</a></li>
            <li><a href="#max_log_size">max_log_size</a></li>
            <li><a href="#max_log_file_size">max_log_file_size</a></li>
            <li><a href="#max_log_file_num">max_log_file_num</a></li>
            <li><a href="#max_log_buffer_size">max_log_buffer_size</a></li>
            <li><a href="#log_flush_ms">log_flush_ms</a></li>
            <li><a href="#log_daily">log_daily</a></li>
            <li><a href="#cout">cout</a></li>
          </ul>
        </li>
        <li><a href="#日志文件">日志文件</a>
          <ul>
            <li><a href="#日志组织方式">日志组织方式</a></li>
            <li><a href="#日志格式">日志格式</a></li>
            <li><a href="#查看日志">查看日志</a></li>
          </ul>
        </li>
        <li><a href="#构建及运行-colog-测试程序">构建及运行 co/log 测试程序</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/log.h">co/log.h</a>.</p>
<h2 id="简介"><a class="anchor" href="#%e7%ae%80%e4%bb%8b">#</a>简介</h2>
<p><code>co/log</code> 是一个类似 <a href="https://github.com/google/glog">google glog</a> 的 C++ 流式日志库，它像下面这样打印日志：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello world&#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;     <span style="color:#998;font-style:italic">// level log
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>TLOG(<span style="color:#d14">&#34;topic&#34;</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello&#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>; <span style="color:#998;font-style:italic">// topic log
</span></span></span></code></pre></div><p>co/log 支持两种类型的日志，level log 与 topic log(TLOG)。</p>
<h3 id="level-log"><a class="anchor" href="#level-log">#</a>Level Log</h3>
<p>Level log 分为 debug, info, warning, error, fatal 5 个级别，并提供一系列的宏，用于打印不同级别的日志。</p>
<p><strong>打印 fatal 级别的日志会终止程序的运行</strong>，co/log 还会在程序退出前打印函数调用栈信息，以方便追查程序崩溃的原因。</p>
<p>此类型的日志会写入同一个文件中，一般用于打印调试信息。</p>
<h3 id="topic-log"><a class="anchor" href="#topic-log">#</a>Topic Log</h3>
<p>Topic log(TLOG) 没有级别之分，而是按主题分类。</p>
<p>此类型的日志，按主题写入不同的文件，一般用于打印业务日志，按业务功能划分，便于日志管理。</p>
<h3 id="性能"><a class="anchor" href="#%e6%80%a7%e8%83%bd">#</a>性能</h3>
<p>co/log 内部采用异步的实现方式，日志先写入缓存，达到一定量或超过一定时间后，由后台线程一次性写入文件，性能在不同平台比 glog 提升了 20~150 倍左右。下表是不同平台单线程连续打印 100 万条(每条 50 字节左右) info 日志的测试结果：</p>
<table>
<thead>
<tr>
<th>platform</th>
<th>google glog</th>
<th>co/log</th>
</tr>
</thead>
<tbody>
<tr>
<td>win2012 HHD</td>
<td>1.6MB/s</td>
<td>180MB/s</td>
</tr>
<tr>
<td>win10 SSD</td>
<td>3.7MB/s</td>
<td>560MB/s</td>
</tr>
<tr>
<td>mac SSD</td>
<td>17MB/s</td>
<td>450MB/s</td>
</tr>
<tr>
<td>linux SSD</td>
<td>54MB/s</td>
<td>1023MB/s</td>
</tr>
</tbody>
</table>
<h2 id="api"><a class="anchor" href="#api">#</a>API</h2>
<h3 id="logexit"><a class="anchor" href="#logexit">#</a>log::exit</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">exit</span>();
</span></span></code></pre></div><ul>
<li>将缓存中的日志写入文件，并退出后台写日志的线程。</li>
<li>程序正常退出时，co/log 会自动调用此函数。</li>
<li>多次调用此函数是安全的。</li>
<li>co/log 内部捕获到 <code>SIGINT, SIGTERM, SIGQUIT</code> 等信号时，会在程序退出前调用此函数。</li>
</ul>
<h3 id="logset_write_cb"><a class="anchor" href="#logset_write_cb">#</a>log::set_write_cb</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_write_cb</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> std<span style="color:#000;font-weight:bold">::</span>function<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">void</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>, size_t)<span style="color:#000;font-weight:bold">&gt;&amp;</span> cb,
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">int</span> flags<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_write_cb</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> std<span style="color:#000;font-weight:bold">::</span>function<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">void</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span>, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>, size_t)<span style="color:#000;font-weight:bold">&gt;&amp;</span> cb,
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">int</span> flags<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><ul>
<li>co/log 默认将日志写到本地文件，用户可以调用此 API 自定义写日志的 callback，将日志写到不同的目标。</li>
<li>参数 <code>cb</code> 是 callback。第 1 个版本用于 Level log，cb 带 2 个参数，表示日志 buffer 的地址及长度；第 2 个版本用于 Topic log(TLOG)，cb 带 3 个参数，第 1 个参数是 topic，后两个参数与第 1 个版本相同。buffer 中可能含有多条日志。</li>
<li>参数 <code>flags</code> 是 v3.0 新增，默认为 0，可以是下述选项的组合：
<ul>
<li><code>log::log2local</code>，在本地也写一份日志。</li>
</ul>
</li>
</ul>
<h3 id="v30-删除的-api"><a class="anchor" href="#v30-%e5%88%a0%e9%99%a4%e7%9a%84-api">#</a>v3.0 删除的 API</h3>
<ul>
<li>
<p><strong>log::init</strong>，v3.0 移除，从 co 3.0 开始，一般只需要在 main 函数开头调用 <code>flag::init(argc, argv)</code>。</p>
</li>
<li>
<p><strong>log::set_single_write_cb</strong>，v3.0 移除。</p>
</li>
<li>
<p><strong>log::close</strong>，v3.0 移除，使用 <code>log::exit()</code> 取代之。</p>
</li>
</ul>
<h2 id="level-log-1"><a class="anchor" href="#level-log-1">#</a>Level Log</h2>
<h3 id="基本用法"><a class="anchor" href="#%e5%9f%ba%e6%9c%ac%e7%94%a8%e6%b3%95">#</a>基本用法</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DLOG  LOG  WLOG  ELOG  FLOG
</span></span></code></pre></div><ul>
<li>
<p>上面的 5 个宏分别用于打印 5 种不同级别的日志，它们是<strong>线程安全</strong>的。</p>
</li>
<li>
<p>这些宏实际上是 <a href="../fastream/">fastream</a> 的引用，因此可以打印 <code>fastream::operator&lt;&lt;</code> 支持的任何类型。</p>
</li>
<li>
<p>这些宏会自动在每条日志末尾加上 &lsquo;\n&rsquo; 换行符，用户无需手动输入换行符。</p>
</li>
<li>
<p>前 4 种仅在 <code>FLG_min_log_level</code> 不大于当前日志级别时，才会打印日志，用户可以将 FLG_min_log_level 的值设置大一些，以屏蔽低级别的日志。</p>
</li>
<li>
<p>打印 fatal 级别的日志，表示程序出现了致命错误，co/log 会打印当前线程的函数调用栈信息，并终止程序的运行。</p>
</li>
<li>
<p>示例</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is DEBUG log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is INFO log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>WLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is WARNING log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>ELOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is ERROR log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>FLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is FATAL log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span></code></pre></div><h3 id="条件日志"><a class="anchor" href="#%e6%9d%a1%e4%bb%b6%e6%97%a5%e5%bf%97">#</a>条件日志</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define DLOG_IF(cond) if (cond) DLOG
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define  LOG_IF(cond) if (cond) LOG
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define WLOG_IF(cond) if (cond) WLOG
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define ELOG_IF(cond) if (cond) ELOG
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define FLOG_IF(cond) if (cond) FLOG
</span></span></span></code></pre></div><ul>
<li>
<p>上面的 5 个宏，接受一个条件参数 cond，当 cond 为 true 时才打印日志。</p>
</li>
<li>
<p>参数 cond 可以是值为 bool 类型的任意表达式。</p>
</li>
<li>
<p>由于条件判断在最前面，即使相应级别的日志被屏蔽掉，这些宏也会保证 cond 表达式被执行。</p>
</li>
<li>
<p>示例</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> s <span style="color:#000;font-weight:bold">=</span> socket();
</span></span><span style="display:flex;"><span>DLOG_IF(s <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket ok: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> s;
</span></span><span style="display:flex;"><span> LOG_IF(s <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket ok: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> s;
</span></span><span style="display:flex;"><span>WLOG_IF(s <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket ko: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> s;
</span></span><span style="display:flex;"><span>ELOG_IF(s <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket ko: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> s;
</span></span><span style="display:flex;"><span>FLOG_IF(s <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket ko: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> s;
</span></span></code></pre></div><h3 id="每-n-条打印一次日志"><a class="anchor" href="#%e6%af%8f-n-%e6%9d%a1%e6%89%93%e5%8d%b0%e4%b8%80%e6%ac%a1%e6%97%a5%e5%bf%97">#</a>每 N 条打印一次日志</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define DLOG_EVERY_N(n) _LOG_EVERY_N(n, DLOG)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define  LOG_EVERY_N(n) _LOG_EVERY_N(n, LOG)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define WLOG_EVERY_N(n) _LOG_EVERY_N(n, WLOG)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define ELOG_EVERY_N(n) _LOG_EVERY_N(n, ELOG)
</span></span></span></code></pre></div><ul>
<li>
<p>上面的宏每 n 条打印一次日志，内部用<a href="../atomic/">原子操作</a>计数，是<strong>线程安全</strong>的。</p>
</li>
<li>
<p>参数 n 必须是大于 0 的整数，一般不要超过 int 类型的最大值。</p>
</li>
<li>
<p>第 1 条日志始终会被打印，之后每隔 n 条打印一次。</p>
</li>
<li>
<p>fatal 日志一打印，程序就会终止运行，因此没有提供 FLOG_EVERY_N。</p>
</li>
<li>
<p>示例</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 每 32 条打印一次 (1,33,65...)
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>DLOG_EVERY_N(<span style="color:#099">32</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is DEBUG log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>LOG_EVERY_N(<span style="color:#099">32</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is INFO log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>WLOG_EVERY_N(<span style="color:#099">32</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is WARNING log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>ELOG_EVERY_N(<span style="color:#099">32</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is ERROR log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span></code></pre></div><h3 id="打印前-n-条日志"><a class="anchor" href="#%e6%89%93%e5%8d%b0%e5%89%8d-n-%e6%9d%a1%e6%97%a5%e5%bf%97">#</a>打印前 N 条日志</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define DLOG_FIRST_N(n) _LOG_FIRST_N(n, DLOG)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define  LOG_FIRST_N(n) _LOG_FIRST_N(n, LOG)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define WLOG_FIRST_N(n) _LOG_FIRST_N(n, WLOG)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define ELOG_FIRST_N(n) _LOG_FIRST_N(n, ELOG)
</span></span></span></code></pre></div><ul>
<li>
<p>上面的宏打印前 n 条日志，内部用<a href="../atomic/">原子操作</a>计数，是<strong>线程安全</strong>的。</p>
</li>
<li>
<p>参数 n 是不小于 0 的整数(等于 0 时不会打印日志)，一般不要超过 int 类型的最大值。</p>
</li>
<li>
<p>参数 n 一般不要用复杂的表达式，因为表达式 n 可能被执行两次。</p>
</li>
<li>
<p>fatal 日志一打印，程序就会终止运行，因此没有提供 FLOG_FIRST_N。</p>
</li>
<li>
<p>示例</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 打印前 10 条日志
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>DLOG_FIRST_N(<span style="color:#099">10</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is DEBUG log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>LOG_FIRST_N(<span style="color:#099">10</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is INFO log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>WLOG_FIRST_N(<span style="color:#099">10</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is WARNING log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>ELOG_FIRST_N(<span style="color:#099">10</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;this is ERROR log &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span></code></pre></div><h2 id="tlog"><a class="anchor" href="#tlog">#</a>TLOG</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define TLOG(topic)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define TLOG_IF(topic, cond) if (cond) TLOG(topic)
</span></span></span></code></pre></div><ul>
<li>
<p>TLOG 宏带有一个参数 <code>topic</code>，它是一个 C 风格的字符串，<strong>需要具备静态生命周期</strong>。</p>
</li>
<li>
<p>TLOG_IF 宏仅当 cond 条件成立时，才打印日志。</p>
</li>
<li>
<p>示例</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>TLOG(<span style="color:#d14">&#34;xx&#34;</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span><span style="display:flex;"><span>TLOG_IF(<span style="color:#d14">&#34;xx&#34;</span>, <span style="color:#0086b3">true</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">23</span>;
</span></span></code></pre></div><h2 id="check-断言"><a class="anchor" href="#check-%e6%96%ad%e8%a8%80">#</a>CHECK 断言</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK(cond) \
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">    if (!(cond)) _FLOG_STREAM &lt;&lt; &#34;check failed: &#34; #cond &#34;! &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_NOTNULL(p) \
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">    if ((p) == 0) _FLOG_STREAM &lt;&lt; &#34;check failed: &#34; #p &#34; mustn&#39;t be NULL! &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_EQ(a, b) _CHECK_OP(a, b, ==)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_NE(a, b) _CHECK_OP(a, b, !=)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_GE(a, b) _CHECK_OP(a, b, &gt;=)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_LE(a, b) _CHECK_OP(a, b, &lt;=)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_GT(a, b) _CHECK_OP(a, b, &gt;)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#define CHECK_LT(a, b) _CHECK_OP(a, b, &lt;)
</span></span></span></code></pre></div><ul>
<li>
<p>上面的宏可视为加强版的 assert，它们在 DEBUG 模式下也不会被清除。</p>
</li>
<li>
<p>这些宏与 <code>FLOG</code> 类似，可以打印 fatal 级别的日志。</p>
</li>
<li>
<p><code>CHECK</code> 断言条件 cond 为真，cond 可以是值为 bool 类型的任意表达式。</p>
</li>
<li>
<p><code>CHECK_NOTNULL</code> 断言指针不是 NULL，参数 p 是任意类型的指针。</p>
</li>
<li>
<p><code>CHECK_EQ</code> 断言 <code>a == b</code>，参数 a 与 b 确保只计算一次。</p>
</li>
<li>
<p><code>CHECK_NE</code> 断言 <code>a != b</code>，参数 a 与 b 确保只计算一次。</p>
</li>
<li>
<p><code>CHECK_GE</code> 断言 <code>a &gt;= b</code>，参数 a 与 b 确保只计算一次。</p>
</li>
<li>
<p><code>CHECK_LE</code> 断言 <code>a &lt;= b</code>，参数 a 与 b 确保只计算一次。</p>
</li>
<li>
<p><code>CHECK_GT</code> 断言 <code>a &gt; b</code>，参数 a 与 b 确保只计算一次。</p>
</li>
<li>
<p><code>CHECK_LT</code> 断言 <code>a &lt; b</code>，参数 a 与 b 确保只计算一次。</p>
</li>
<li>
<p>一般建议优先使用 <code>CHECK_XX(a, b)</code> 这些宏，它们提供比 <code>CHECK(cond)</code> 更多的信息，会打印出参数 a 与 b 的值。</p>
</li>
<li>
<p><code>fastream::operator&lt;&lt;</code> 不支持的参数类型，如 STL 容器的 iterator 类型，不能用 <code>CHECK_XX(a, b)</code> 这些宏。</p>
</li>
<li>
<p>断言失败时，co/log 先调用 <code>log::exit()</code>，再打印当前线程的函数调用栈信息，然后退出程序。</p>
</li>
<li>
<p>示例</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> s <span style="color:#000;font-weight:bold">=</span> socket();
</span></span><span style="display:flex;"><span>CHECK(s <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>);
</span></span><span style="display:flex;"><span>CHECK(s <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket failed&#34;</span>;
</span></span><span style="display:flex;"><span>CHECK_NE(s, <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket failed&#34;</span>;  <span style="color:#998;font-style:italic">// s != -1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>CHECK_GE(s, <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket failed&#34;</span>;   <span style="color:#998;font-style:italic">// s &gt;= 0
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>CHECK_GT(s, <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;create socket failed&#34;</span>;  <span style="color:#998;font-style:italic">// s &gt; -1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>std<span style="color:#000;font-weight:bold">::</span>map<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">&gt;</span> m;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">auto</span> it <span style="color:#000;font-weight:bold">=</span> m.find(<span style="color:#099">3</span>);
</span></span><span style="display:flex;"><span>CHECK(it <span style="color:#000;font-weight:bold">!=</span> m.end()); <span style="color:#998;font-style:italic">// 不能使用 CHECK_NE(it, m.end()), 编译器会报错
</span></span></span></code></pre></div><h2 id="打印堆栈信息"><a class="anchor" href="#%e6%89%93%e5%8d%b0%e5%a0%86%e6%a0%88%e4%bf%a1%e6%81%af">#</a>打印堆栈信息</h2>
<p><code>co/log</code> 在 <code>CHECK</code> 断言失败或捕获到 <code>SIGSEGV</code> 等异常信号时，会打印函数调用栈，以方便定位问题，效果见下图：</p>
<p><img src="https://coostdocs.github.io/images/stack.png" alt="stack" />(<a href="https://asciinema.org/a/435894">https://asciinema.org/a/435894</a>)</p>
<p>此功能需要在编译时，加入调试信息，如 gcc 需要开启 <code>-g</code> 选项。在 linux 与 macosx 平台，还需要安装 <a href="https://github.com/ianlancetaylor/libbacktrace">libbacktrace</a>，才能打印堆栈信息。在 linux 上，<code>libbacktrace</code> 可能已经集成到 gcc 里了，您也许可以在类似 <code>/usr/lib/gcc/x86_64-linux-gnu/9</code> 的目录中找到它。否则，您可以按下面的方式手动安装它：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/ianlancetaylor/libbacktrace.git
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> libbacktrace-master
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make -j8
</span></span><span style="display:flex;"><span>sudo make install
</span></span></code></pre></div><h2 id="配置项"><a class="anchor" href="#%e9%85%8d%e7%bd%ae%e9%a1%b9">#</a>配置项</h2>
<p>co/log 使用 <a href="../flag/">co/flag</a> 定义配置项，下面列出的是 co/log 内部定义的 flag，这些配置项如无特别说明，对 level log 与 TLOG 均有效。</p>
<h3 id="log_dir"><a class="anchor" href="#log_dir">#</a>log_dir</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_string(log_dir, <span style="color:#d14">&#34;logs&#34;</span>, <span style="color:#d14">&#34;#0 log dir, will be created if not exists&#34;</span>);
</span></span></code></pre></div><ul>
<li>指定日志目录，默认为当前目录下的 <code>logs</code> 目录，不存在时将会自动创建。</li>
<li>log_dir 可以是绝对路径或相对路径，路径分隔符可以是 &lsquo;/&rsquo; 或 &lsquo;\&rsquo;，一般建议使用 &lsquo;/&rsquo;。</li>
<li>程序启动时，确保当前用户有足够的权限，否则创建日志目录可能失败。</li>
</ul>
<h3 id="log_file_name"><a class="anchor" href="#log_file_name">#</a>log_file_name</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_string(log_file_name, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;#0 name of log file, using exename if empty&#34;</span>);
</span></span></code></pre></div><ul>
<li>指定日志文件名(不含路径)，默认为空，使用程序名作为日志文件名(程序名末尾的 <code>.exe</code> 会被去掉)，如程序 xx 或 xx.exe 对应的日志文件名是 xx.log。</li>
<li>如果日志文件名不是以 <code>.log</code> 结尾，co/log 自动在文件名末尾加上 <code>.log</code>。</li>
</ul>
<h3 id="min_log_level"><a class="anchor" href="#min_log_level">#</a>min_log_level</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_int32(min_log_level, <span style="color:#099">0</span>, <span style="color:#d14">&#34;#0 write logs at or above this level, 0-4 (debug|info|warning|error|fatal)&#34;</span>);
</span></span></code></pre></div><ul>
<li>仅适用于 level log，指定打印日志的最小级别，用于屏蔽低级别的日志，默认为 0，打印所有级别的日志。</li>
</ul>
<h3 id="max_log_size"><a class="anchor" href="#max_log_size">#</a>max_log_size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_int32(max_log_size, <span style="color:#099">4096</span>, <span style="color:#d14">&#34;#0 max size of a single log&#34;</span>);
</span></span></code></pre></div><ul>
<li>单条日志的最大长度，超过这个值，日志会被截断。</li>
</ul>
<h3 id="max_log_file_size"><a class="anchor" href="#max_log_file_size">#</a>max_log_file_size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_int64(max_log_file_size, <span style="color:#099">256</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">20</span>, <span style="color:#d14">&#34;#0 max size of log file, default: 256MB&#34;</span>);
</span></span></code></pre></div><ul>
<li>指定日志文件的最大大小，默认 256M，超过此大小，生成新的日志文件，旧的日志文件会被重命名。</li>
</ul>
<h3 id="max_log_file_num"><a class="anchor" href="#max_log_file_num">#</a>max_log_file_num</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_uint32(max_log_file_num, <span style="color:#099">8</span>, <span style="color:#d14">&#34;#0 max number of log files&#34;</span>);
</span></span></code></pre></div><ul>
<li>指定日志文件的最大数量，默认是 8，超过此值，删除旧的日志文件。</li>
</ul>
<h3 id="max_log_buffer_size"><a class="anchor" href="#max_log_buffer_size">#</a>max_log_buffer_size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_uint32(max_log_buffer_size, <span style="color:#099">32</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">20</span>, <span style="color:#d14">&#34;#0 max size of log buffer, default: 32MB&#34;</span>);
</span></span></code></pre></div><ul>
<li>指定日志缓存的最大大小，默认 32M，超过此值，丢掉一半的日志。</li>
</ul>
<h3 id="log_flush_ms"><a class="anchor" href="#log_flush_ms">#</a>log_flush_ms</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_uint32(log_flush_ms, <span style="color:#099">128</span>, <span style="color:#d14">&#34;#0 flush the log buffer every n ms&#34;</span>);
</span></span></code></pre></div><ul>
<li>后台线程将日志缓存刷入文件的时间间隔，单位为毫秒。</li>
</ul>
<h3 id="log_daily"><a class="anchor" href="#log_daily">#</a>log_daily</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_bool(log_daily, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;&gt;&gt;#0 if true, enable daily log rotation&#34;</span>);
</span></span></code></pre></div><ul>
<li>按天生成日志文件，默认为 false。</li>
</ul>
<h3 id="cout"><a class="anchor" href="#cout">#</a>cout</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_bool(cout, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;#0 also logging to terminal&#34;</span>);
</span></span></code></pre></div><ul>
<li>终端日志开关，默认为 false。若为 true，将日志也打印到终端。</li>
</ul>
<h2 id="日志文件"><a class="anchor" href="#%e6%97%a5%e5%bf%97%e6%96%87%e4%bb%b6">#</a>日志文件</h2>
<h3 id="日志组织方式"><a class="anchor" href="#%e6%97%a5%e5%bf%97%e7%bb%84%e7%bb%87%e6%96%b9%e5%bc%8f">#</a>日志组织方式</h3>
<p>co/log 将所有级别的日志记录到同一个文件中，默认使用程序名作为日志文件名，如进程 xx 的日志文件是 xx.log。当日志文件达到最大大小 (FLG_max_log_file_size) 时，co/log 会重命名日志文件，并生成新文件。日志目录下面可能包含如下的文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xx.log
</span></span><span style="display:flex;"><span>xx_0523_16_12_54.970.log
</span></span><span style="display:flex;"><span>xx_0523_16_13_12.921.log
</span></span><span style="display:flex;"><span>xx_0523_16_15_05.264.log
</span></span></code></pre></div><p><code>xx.log</code> 始终是当前最新的日志文件。当文件数量超过 <code>FLG_max_log_file_num</code> 时，co/log 就会删除最旧的日志文件。</p>
<p><code>fatal</code> 级别的日志，还会额外记录到 <code>xx.fatal</code> 文件中，<strong>co/log 不会重命名 fatal 日志文件，也不会删除它</strong>。</p>
<h3 id="日志格式"><a class="anchor" href="#%e6%97%a5%e5%bf%97%e6%a0%bc%e5%bc%8f">#</a>日志格式</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>I0514 11:15:30.123 <span style="color:#099">1045</span> test/xx.cc:11<span style="color:#000;font-weight:bold">]</span> hello world
</span></span><span style="display:flex;"><span>D0514 11:15:30.123 <span style="color:#099">1045</span> test/xx.cc:12<span style="color:#000;font-weight:bold">]</span> hello world
</span></span><span style="display:flex;"><span>W0514 11:15:30.123 <span style="color:#099">1045</span> test/xx.cc:13<span style="color:#000;font-weight:bold">]</span> hello world
</span></span><span style="display:flex;"><span>E0514 11:15:30.123 <span style="color:#099">1045</span> test/xx.cc:14<span style="color:#000;font-weight:bold">]</span> hello world
</span></span><span style="display:flex;"><span>F0514 11:15:30.123 <span style="color:#099">1045</span> test/xx.cc:15<span style="color:#000;font-weight:bold">]</span> hello world
</span></span></code></pre></div><ul>
<li>上面的例子中，每行对应一条日志。</li>
<li>每条日志的第一个字母是日志级别，<code>I</code> 表示 info，<code>D</code> 表示 debug，<code>W</code> 表示 warning，<code>E</code> 表示 error，<code>F</code> 表示 fatal。</li>
<li>级别后面是时间，从月份开始到毫秒。年份意义不大，只会多占几个字节，因此没有打印出来。co/log 日志的时间，并不是生成时的时间，而是写入缓存时的时间，这是为了保证日志文件中的日志严格按时间排序。</li>
<li>时间后面是线程 id，上面的 1045 即是线程 id。</li>
<li>线程 id 后面是日志代码所在文件及行数。</li>
<li>行数后面是 <code>] </code> ，即 <code>]</code> 后面加一个空格。</li>
<li><code>] </code> 后面就是用户输入的日志内容。</li>
</ul>
<h3 id="查看日志"><a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e6%97%a5%e5%bf%97">#</a>查看日志</h3>
<p>Linux 等系统，可以用 <code>grep</code>，<code>tail</code> 等命令查看日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep ^E xx.log
</span></span><span style="display:flex;"><span>tail -F xx.log
</span></span><span style="display:flex;"><span>tail -F xx.log | grep ^E
</span></span></code></pre></div><ul>
<li>第 1 行用 <code>grep</code> 过滤出文件中的错误日志，<code>^E</code> 表示以字母 <code>E</code> 开头。</li>
<li>第 2 行用 <code>tail -F</code> 命令动态追踪日志文件，这里需要用大写的 <code>F</code>，因为 xx.log 可能被重命名，然后生成新的 xx.log 文件，<code>-F</code> 确保按文件名追踪到最新的日志文件。</li>
<li>第 3 行用 <code>tail -F</code> 配合 <code>grep</code> 动态追踪日志文件中的错误日志。</li>
</ul>
<h2 id="构建及运行-colog-测试程序"><a class="anchor" href="#%e6%9e%84%e5%bb%ba%e5%8f%8a%e8%bf%90%e8%a1%8c-colog-%e6%b5%8b%e8%af%95%e7%a8%8b%e5%ba%8f">#</a>构建及运行 co/log 测试程序</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>xmake -b log                   <span style="color:#998;font-style:italic"># build log or log.exe</span>
</span></span><span style="display:flex;"><span>xmake r log                    <span style="color:#998;font-style:italic"># run log or log.exe</span>
</span></span><span style="display:flex;"><span>xmake r log -cout              <span style="color:#998;font-style:italic"># also log to terminal</span>
</span></span><span style="display:flex;"><span>xmake r log -min_log_level<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>   <span style="color:#998;font-style:italic"># 0-4: debug,info,warning,error,fatal </span>
</span></span><span style="display:flex;"><span>xmake r log -perf              <span style="color:#998;font-style:italic"># performance test</span>
</span></span></code></pre></div><ul>
<li>在 co 根目录执行 <code>xmake -b log</code> 即可编译 <a href="https://github.com/idealvin/co/blob/master/test/log.cc">test/log.cc</a> 测试代码，并生成 <code>log</code> 二进制文件。</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

  



  
    
  
    
  


  


<div class="book-languages" tabindex="0" aria-haspopup="true">
  <ul>
    <li class="flex align-center">
      <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
      中文
    </li> 
  </ul>

  <ul class="book-languages-list">
    
    <li class="active">
      <a href="../../../cn/" class="flex align-center">
        <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
        中文
      </a>
    </li>
    
    <li class="">
      <a href="../../../en/co/log/" class="flex align-center">
        <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </li>
    
  </ul>
</div>




  <div class="book-date"><a class="flex align-center" href="https://github.com/cocoyaxi/codoc/commit/07947e66070d8427517d89d2d0edc9b2af36e9ee" title='最后修改者 idealvin | September 19, 2022' target="_blank" rel="noopener">
      <img src="../../../svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>September 19, 2022</span>
    </a>
  </div>



  <div class="book-edit">
    <a class="flex align-center" href="https://github.com/cocoyaxi/codoc/edit/master/content/cn/co/log.md" target="_blank" rel="noopener">
      <img src="../../../svg/edit.svg" class="book-icon" alt="Edit" />
      <span>编辑本页</span>
    </a>
  </div>

</div>

 
        





<script src="//cdn.bootcss.com/highlight.js/11.1.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/cpp.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/bash.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/lua.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/yaml.min.js"></script>
<script>hljs.configure({ languages: [] }); hljs.initHighlightingOnLoad();</script>





      </footer>

      
  
  <div class="book-comments">


<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '11f9ff9ca43804d70b32',
    clientSecret: '07e2bd5b09a1654e7942a7698c3ec164e7566177',
    repo: 'gitalk',
    owner: 'idealvin',
    admin: ['idealvin'],
    id: location.pathname,
    language: 'zh-CN',
    distractionFreeMode: false,
    proxy: 'https:\/\/cors-anywhere.azm.workers.dev\/https:\/\/github.com\/login\/oauth\/access_token'
  })
  gitalk.render('gitalk-container');
</script></div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#简介">简介</a>
          <ul>
            <li><a href="#level-log">Level Log</a></li>
            <li><a href="#topic-log">Topic Log</a></li>
            <li><a href="#性能">性能</a></li>
          </ul>
        </li>
        <li><a href="#api">API</a>
          <ul>
            <li><a href="#logexit">log::exit</a></li>
            <li><a href="#logset_write_cb">log::set_write_cb</a></li>
            <li><a href="#v30-删除的-api">v3.0 删除的 API</a></li>
          </ul>
        </li>
        <li><a href="#level-log-1">Level Log</a>
          <ul>
            <li><a href="#基本用法">基本用法</a></li>
            <li><a href="#条件日志">条件日志</a></li>
            <li><a href="#每-n-条打印一次日志">每 N 条打印一次日志</a></li>
            <li><a href="#打印前-n-条日志">打印前 N 条日志</a></li>
          </ul>
        </li>
        <li><a href="#tlog">TLOG</a></li>
        <li><a href="#check-断言">CHECK 断言</a></li>
        <li><a href="#打印堆栈信息">打印堆栈信息</a></li>
        <li><a href="#配置项">配置项</a>
          <ul>
            <li><a href="#log_dir">log_dir</a></li>
            <li><a href="#log_file_name">log_file_name</a></li>
            <li><a href="#min_log_level">min_log_level</a></li>
            <li><a href="#max_log_size">max_log_size</a></li>
            <li><a href="#max_log_file_size">max_log_file_size</a></li>
            <li><a href="#max_log_file_num">max_log_file_num</a></li>
            <li><a href="#max_log_buffer_size">max_log_buffer_size</a></li>
            <li><a href="#log_flush_ms">log_flush_ms</a></li>
            <li><a href="#log_daily">log_daily</a></li>
            <li><a href="#cout">cout</a></li>
          </ul>
        </li>
        <li><a href="#日志文件">日志文件</a>
          <ul>
            <li><a href="#日志组织方式">日志组织方式</a></li>
            <li><a href="#日志格式">日志格式</a></li>
            <li><a href="#查看日志">查看日志</a></li>
          </ul>
        </li>
        <li><a href="#构建及运行-colog-测试程序">构建及运行 co/log 测试程序</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












