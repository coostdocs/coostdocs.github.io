<!DOCTYPE html>
<html lang="cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="include: co/co.h.
#åŸºæœ¬æ¦‚å¿µ åç¨‹æ˜¯è¿è¡Œäºçº¿ç¨‹ä¸­çš„è½»é‡çº§è°ƒåº¦å•ä½ã€‚ åç¨‹ä¹‹äºçº¿ç¨‹ï¼Œç±»ä¼¼äºçº¿ç¨‹ä¹‹äºè¿›ç¨‹ã€‚ ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªåç¨‹ã€‚ åç¨‹æ‰€åœ¨çš„çº¿ç¨‹ä¸€èˆ¬è¢«ç§°ä¸ºè°ƒåº¦çº¿ç¨‹ã€‚ åç¨‹å‘ç”Ÿ io é˜»å¡æˆ–è°ƒç”¨ sleep ç­‰æ“ä½œæ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šæŒ‚èµ·æ­¤åç¨‹ã€‚ åç¨‹æŒ‚èµ·æ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šåˆ‡æ¢åˆ°å…¶ä»–ç­‰å¾…ä¸­çš„åç¨‹è¿è¡Œã€‚ åç¨‹çš„åˆ‡æ¢æ˜¯åœ¨ç”¨æˆ·æ€è¿›è¡Œçš„ï¼Œæ¯”çº¿ç¨‹é—´çš„åˆ‡æ¢æ›´å¿«ã€‚ åç¨‹éå¸¸é€‚åˆå†™ç½‘ç»œç¨‹åºï¼Œå¯ä»¥å®ç°åŒæ­¥çš„ç¼–ç¨‹æ–¹å¼ï¼Œä¸éœ€è¦å¼‚æ­¥å›è°ƒï¼Œå¤§å¤§å‡è½»äº†ç¨‹åºå‘˜çš„æ€æƒ³è´Ÿæ‹…ã€‚
co åç¨‹åº“å®ç°çš„æ˜¯ä¸€ç§ç±»ä¼¼ golang çš„åç¨‹ï¼Œæœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š
æ”¯æŒå¤šçº¿ç¨‹è°ƒåº¦ï¼Œé»˜è®¤çº¿ç¨‹æ•°ä¸ºç³»ç»Ÿ CPU æ ¸æ•°ã€‚ å…±äº«æ ˆï¼ŒåŒä¸€çº¿ç¨‹ä¸­çš„åç¨‹å…±ç”¨è‹¥å¹²ä¸ªæ ˆ(å¤§å°é»˜è®¤ä¸º 1MB)ï¼Œå†…å­˜å ç”¨ä½ï¼ŒLinux ä¸Šçš„æµ‹è¯•æ˜¾ç¤º 1000 ä¸‡åç¨‹åªç”¨äº† 2.8G å†…å­˜(ä»…ä¾›å‚è€ƒ)ã€‚ åç¨‹åˆ›å»ºåï¼Œå§‹ç»ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œè€Œä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚ å„åç¨‹ä¹‹é—´ä¸ºå¹³çº§å…³ç³»ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹(åŒ…æ‹¬åœ¨åç¨‹ä¸­)åˆ›å»ºæ–°çš„åç¨‹ã€‚ co åç¨‹åº“åœ¨ linux, mac, windows ç­‰å¹³å°ï¼Œåˆ†åˆ«åŸºäº epoll, kqueue, iocp å®ç°ã€‚
co åç¨‹åº“ä¸­ context åˆ‡æ¢ç›¸å…³çš„ä»£ç ï¼Œå–è‡ª ruki çš„ tboxï¼Œè€Œ tbox åˆ™å‚è€ƒäº† boost çš„å®ç°ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿè°¢ï¼
#åç¨‹ API #v3.0 åˆ é™¤çš„ API co::init, v3.0 ç§»é™¤ï¼Œä» co 3.0 å¼€å§‹ï¼Œä¸€èˆ¬åªéœ€è¦åœ¨ main å‡½æ•°å¼€å¤´è°ƒç”¨ flag::init(argc, argv)ã€‚ co::exit, v3.0 ç§»é™¤ã€‚ co::stop, v3.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="åç¨‹" />
<meta property="og:description" content="include: co/co.h.
#åŸºæœ¬æ¦‚å¿µ åç¨‹æ˜¯è¿è¡Œäºçº¿ç¨‹ä¸­çš„è½»é‡çº§è°ƒåº¦å•ä½ã€‚ åç¨‹ä¹‹äºçº¿ç¨‹ï¼Œç±»ä¼¼äºçº¿ç¨‹ä¹‹äºè¿›ç¨‹ã€‚ ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªåç¨‹ã€‚ åç¨‹æ‰€åœ¨çš„çº¿ç¨‹ä¸€èˆ¬è¢«ç§°ä¸ºè°ƒåº¦çº¿ç¨‹ã€‚ åç¨‹å‘ç”Ÿ io é˜»å¡æˆ–è°ƒç”¨ sleep ç­‰æ“ä½œæ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šæŒ‚èµ·æ­¤åç¨‹ã€‚ åç¨‹æŒ‚èµ·æ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šåˆ‡æ¢åˆ°å…¶ä»–ç­‰å¾…ä¸­çš„åç¨‹è¿è¡Œã€‚ åç¨‹çš„åˆ‡æ¢æ˜¯åœ¨ç”¨æˆ·æ€è¿›è¡Œçš„ï¼Œæ¯”çº¿ç¨‹é—´çš„åˆ‡æ¢æ›´å¿«ã€‚ åç¨‹éå¸¸é€‚åˆå†™ç½‘ç»œç¨‹åºï¼Œå¯ä»¥å®ç°åŒæ­¥çš„ç¼–ç¨‹æ–¹å¼ï¼Œä¸éœ€è¦å¼‚æ­¥å›è°ƒï¼Œå¤§å¤§å‡è½»äº†ç¨‹åºå‘˜çš„æ€æƒ³è´Ÿæ‹…ã€‚
co åç¨‹åº“å®ç°çš„æ˜¯ä¸€ç§ç±»ä¼¼ golang çš„åç¨‹ï¼Œæœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š
æ”¯æŒå¤šçº¿ç¨‹è°ƒåº¦ï¼Œé»˜è®¤çº¿ç¨‹æ•°ä¸ºç³»ç»Ÿ CPU æ ¸æ•°ã€‚ å…±äº«æ ˆï¼ŒåŒä¸€çº¿ç¨‹ä¸­çš„åç¨‹å…±ç”¨è‹¥å¹²ä¸ªæ ˆ(å¤§å°é»˜è®¤ä¸º 1MB)ï¼Œå†…å­˜å ç”¨ä½ï¼ŒLinux ä¸Šçš„æµ‹è¯•æ˜¾ç¤º 1000 ä¸‡åç¨‹åªç”¨äº† 2.8G å†…å­˜(ä»…ä¾›å‚è€ƒ)ã€‚ åç¨‹åˆ›å»ºåï¼Œå§‹ç»ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œè€Œä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚ å„åç¨‹ä¹‹é—´ä¸ºå¹³çº§å…³ç³»ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹(åŒ…æ‹¬åœ¨åç¨‹ä¸­)åˆ›å»ºæ–°çš„åç¨‹ã€‚ co åç¨‹åº“åœ¨ linux, mac, windows ç­‰å¹³å°ï¼Œåˆ†åˆ«åŸºäº epoll, kqueue, iocp å®ç°ã€‚
co åç¨‹åº“ä¸­ context åˆ‡æ¢ç›¸å…³çš„ä»£ç ï¼Œå–è‡ª ruki çš„ tboxï¼Œè€Œ tbox åˆ™å‚è€ƒäº† boost çš„å®ç°ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿè°¢ï¼
#åç¨‹ API #v3.0 åˆ é™¤çš„ API co::init, v3.0 ç§»é™¤ï¼Œä» co 3.0 å¼€å§‹ï¼Œä¸€èˆ¬åªéœ€è¦åœ¨ main å‡½æ•°å¼€å¤´è°ƒç”¨ flag::init(argc, argv)ã€‚ co::exit, v3.0 ç§»é™¤ã€‚ co::stop, v3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://coostdocs.github.io/cn/co/coroutine/" /><meta property="article:section" content="co" />

<meta property="article:modified_time" content="2022-08-14T17:23:52+08:00" />

<title>åç¨‹ | Documents for Coost</title>
<link rel="manifest" href="../../../manifest.json">
<link rel="icon" href="../../../favicon.png" type="image/x-icon">
  <link rel="alternate" hreflang="en" href="https://coostdocs.github.io/en/co/coroutine/" title="Coroutine">
<link rel="stylesheet" href="../../../book.min.0608a3570dae40fa4b3de520d6a873cc9855bb4cb5001c4b16e95a226b84aff8.css" integrity="sha256-BgijVw2uQPpLPeUg1qhzzJhVu0y1ABxLFulaImuEr/g=" crossorigin="anonymous">
  <script defer src="../../../flexsearch.min.js"></script>
  <script defer src="../../../cn.search.min.aa8a3c91aca1dc000ce777789927731dbb4ddb666a8b6ac6249844476bf2f98a.js" integrity="sha256-qoo8kayh3AAM53d4mSdzHbtN22Zqi2rGJJhER2vy&#43;Yo=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  


<link href='//cdn.bootcss.com/highlight.js/11.1.0/styles/github.min.css'
  rel='stylesheet' type='text/css' />


</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="../../../cn/"><span>Documents for Coost</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="æœç´¢" aria-label="æœç´¢" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>å…³äº</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/about/co/" class="">ç®€ä»‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/about/contact/" class="">è”ç³»</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/about/sponsor/" class="">èµåŠ©ğŸ’•</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>CO å‚è€ƒæ–‡æ¡£</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/def/" class="">åŸºæœ¬å®šä¹‰</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/defer/" class="">defer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/atomic/" class="">åŸå­æ“ä½œ</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/fastring/" class="">å­—ç¬¦ä¸²(fastring)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/fastream/" class="">å­—ç¬¦æµ(fastream)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/str/" class="">å­—ç¬¦ä¸²æ“ä½œ</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/flag/" class="">å‘½ä»¤è¡Œå‚æ•°ä¸é…ç½®æ–‡ä»¶è§£æ</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/log/" class="">æ—¥å¿—</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/unitest/" class="">å•å…ƒæµ‹è¯•æ¡†æ¶</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/json/" class="">JSON</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/time/" class="">æ—¶é—´</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/thread/" class="">çº¿ç¨‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/coroutine/" class=" active">åç¨‹</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-752f64a904309658adbf6062b2c3d8c1" class="toggle"  />
    <label for="section-752f64a904309658adbf6062b2c3d8c1" class="flex justify-between">
      <a role="button" class="">ç½‘ç»œç¼–ç¨‹</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/byte_order/" class="">å­—èŠ‚åº</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/tcp/" class="">TCP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/http/" class="">HTTP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/net/rpc/" class="">RPC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/tasked/" class="">å®šæ—¶ä»»åŠ¡</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/random/" class="">éšæœºæ•°</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/lrumap/" class="">LruMap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/hash/" class="">Hash</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/path/" class="">æ–‡ä»¶è·¯å¾„(path)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/fs/" class="">æ–‡ä»¶ç³»ç»Ÿ</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/os/" class="">æ“ä½œç³»ç»Ÿ</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../cn/co/build/" class="">ç¼–è¯‘</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>åç¨‹</strong>

  <label for="toc-control">
    
    <img src="../../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></li>
        <li><a href="#åç¨‹-api">åç¨‹ API</a>
          <ul>
            <li><a href="#v30-åˆ é™¤çš„-api">v3.0 åˆ é™¤çš„ API</a></li>
            <li><a href="#go">go</a></li>
            <li><a href="#def_main">DEF_main</a></li>
            <li><a href="#cocoroutine">co::coroutine</a></li>
            <li><a href="#coresume">co::resume</a></li>
            <li><a href="#coyield">co::yield</a></li>
            <li><a href="#coscheduler">co::scheduler</a></li>
            <li><a href="#coschedulers">co::schedulers</a></li>
            <li><a href="#conext_scheduler">co::next_scheduler</a></li>
            <li><a href="#coscheduler_num">co::scheduler_num</a></li>
            <li><a href="#coscheduler_id">co::scheduler_id</a></li>
            <li><a href="#cocoroutine_id">co::coroutine_id</a></li>
            <li><a href="#cosleep">co::sleep</a></li>
            <li><a href="#cotimeout">co::timeout</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹åŒ–çš„-socket-api">åç¨‹åŒ–çš„ socket API</a>
          <ul>
            <li><a href="#æœ¯è¯­çº¦å®šå¿…çœ‹">æœ¯è¯­çº¦å®š(å¿…çœ‹)</a></li>
            <li><a href="#cosocket">co::socket</a></li>
            <li><a href="#coaccept">co::accept</a></li>
            <li><a href="#cobind">co::bind</a></li>
            <li><a href="#coclose">co::close</a></li>
            <li><a href="#coconnect">co::connect</a></li>
            <li><a href="#colisten">co::listen</a></li>
            <li><a href="#corecv">co::recv</a></li>
            <li><a href="#corecvn">co::recvn</a></li>
            <li><a href="#corecvfrom">co::recvfrom</a></li>
            <li><a href="#cosend">co::send</a></li>
            <li><a href="#cosendto">co::sendto</a></li>
            <li><a href="#coshutdown">co::shutdown</a></li>
            <li><a href="#coerror">co::error</a></li>
            <li><a href="#costrerror">co::strerror</a></li>
            <li><a href="#heading">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</a></li>
            <li><a href="#cogetsockopt">co::getsockopt</a></li>
            <li><a href="#cosetsockopt">co::setsockopt</a></li>
            <li><a href="#coset_nonblock">co::set_nonblock</a></li>
            <li><a href="#coset_reuseaddr">co::set_reuseaddr</a></li>
            <li><a href="#coset_recv_buffer_size">co::set_recv_buffer_size</a></li>
            <li><a href="#coset_send_buffer_size">co::set_send_buffer_size</a></li>
            <li><a href="#coset_tcp_keepalive">co::set_tcp_keepalive</a></li>
            <li><a href="#coset_tcp_nodelay">co::set_tcp_nodelay</a></li>
            <li><a href="#coreset_tcp_socket">co::reset_tcp_socket</a></li>
            <li><a href="#heading-1">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</a></li>
            <li><a href="#coinit_ip_addr">co::init_ip_addr</a></li>
            <li><a href="#coip_str">co::ip_str</a></li>
            <li><a href="#coto_string">co::to_string</a></li>
            <li><a href="#copeer">co::peer</a></li>
          </ul>
        </li>
        <li><a href="#channelcochan">channel(co::Chan)</a>
          <ul>
            <li><a href="#chanchan">Chan::Chan</a></li>
            <li><a href="#operator">operator&laquo;</a></li>
            <li><a href="#operator-1">operator&raquo;</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-1">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹åŒæ­¥äº‹ä»¶coevent">åç¨‹åŒæ­¥äº‹ä»¶(co::Event)</a>
          <ul>
            <li><a href="#eventevent">Event::Event</a></li>
            <li><a href="#eventsignal">Event::signal</a></li>
            <li><a href="#eventwait">Event::wait</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-2">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#waitgroupcowaitgroup">waitgroup(co::WaitGroup)</a>
          <ul>
            <li><a href="#waitgroupwaitgroup">WaitGroup::WaitGroup</a></li>
            <li><a href="#waitgroupadd">WaitGroup::add</a></li>
            <li><a href="#waitgroupdone">WaitGroup::done</a></li>
            <li><a href="#waitgroupwait">WaitGroup::wait</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-3">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹é”comutex">åç¨‹é”(co::Mutex)</a>
          <ul>
            <li><a href="#mutexmutex">Mutex::Mutex</a></li>
            <li><a href="#mutexlock">Mutex::lock</a></li>
            <li><a href="#mutextry_lock">Mutex::try_lock</a></li>
            <li><a href="#mutexunlock">Mutex::unlock</a></li>
          </ul>
        </li>
        <li><a href="#comutexguard">co::MutexGuard</a>
          <ul>
            <li><a href="#mutexguardmutexguard">MutexGuard::MutexGuard</a></li>
            <li><a href="#mutexguardmutexguard-1">MutexGuard::~MutexGuard</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-4">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹æ± copool">åç¨‹æ± (co::Pool)</a>
          <ul>
            <li><a href="#poolpool">Pool::Pool</a></li>
            <li><a href="#poolclear">Pool::clear</a></li>
            <li><a href="#poolpop">Pool::pop</a></li>
            <li><a href="#poolpush">Pool::push</a></li>
            <li><a href="#poolsize">Pool::size</a></li>
          </ul>
        </li>
        <li><a href="#copoolguard">co::PoolGuard</a>
          <ul>
            <li><a href="#poolguardpoolguard">PoolGuard::PoolGuard</a></li>
            <li><a href="#poolguardpoolguard-1">PoolGuard::~PoolGuard</a></li>
            <li><a href="#poolguardget">PoolGuard::get</a></li>
            <li><a href="#poolguardoperator-">PoolGuard::operator-&gt;</a></li>
            <li><a href="#poolguardoperator">PoolGuard::operator*</a></li>
            <li><a href="#poolguardoperator-bool">PoolGuard::operator bool</a></li>
            <li><a href="#poolguardoperator-1">PoolGuard::operator!</a></li>
            <li><a href="#poolguardoperator-2">PoolGuard::operator==</a></li>
            <li><a href="#poolguardoperator-3">PoolGuard::operator!=</a></li>
            <li><a href="#poolguardoperator-4">PoolGuard::operator=</a></li>
            <li><a href="#poolguardreset">PoolGuard::reset</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-5">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#io-äº‹ä»¶coioevent">I/O äº‹ä»¶(co::IoEvent)</a>
          <ul>
            <li><a href="#coio_event_t">co::io_event_t</a></li>
            <li><a href="#ioeventioevent">IoEvent::IoEvent</a></li>
            <li><a href="#ioeventioevent-1">IoEvent::~IoEvent</a></li>
            <li><a href="#ioeventwait">IoEvent::wait</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-6">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹ä¸­ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“">åç¨‹ä¸­ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“</a>
          <ul>
            <li><a href="#åç¨‹åŒ–">åç¨‹åŒ–</a></li>
            <li><a href="#ç³»ç»Ÿ-api-hook">ç³»ç»Ÿ API hook</a></li>
          </ul>
        </li>
        <li><a href="#åŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼">åŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼</a>
          <ul>
            <li><a href="#æœåŠ¡ç«¯ç½‘ç»œæ¨¡å‹">æœåŠ¡ç«¯ç½‘ç»œæ¨¡å‹</a></li>
            <li><a href="#å®¢æˆ·ç«¯ç½‘ç»œæ¨¡å‹">å®¢æˆ·ç«¯ç½‘ç»œæ¨¡å‹</a></li>
          </ul>
        </li>
        <li><a href="#é…ç½®">é…ç½®</a>
          <ul>
            <li><a href="#co_debug_log">co_debug_log</a></li>
            <li><a href="#co_sched_num">co_sched_num</a></li>
            <li><a href="#co_stack_size">co_stack_size</a></li>
            <li><a href="#disable_hook_sleep">disable_hook_sleep</a></li>
            <li><a href="#hook_log">hook_log</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>include: <a href="https://github.com/idealvin/co/blob/master/include/co/co.h">co/co.h</a>.</p>
<h2 id="åŸºæœ¬æ¦‚å¿µ"><a class="anchor" href="#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5">#</a>åŸºæœ¬æ¦‚å¿µ</h2>
<ul>
<li>åç¨‹æ˜¯è¿è¡Œäºçº¿ç¨‹ä¸­çš„è½»é‡çº§è°ƒåº¦å•ä½ã€‚</li>
<li>åç¨‹ä¹‹äºçº¿ç¨‹ï¼Œç±»ä¼¼äºçº¿ç¨‹ä¹‹äºè¿›ç¨‹ã€‚</li>
<li>ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªåç¨‹ã€‚</li>
<li>åç¨‹æ‰€åœ¨çš„çº¿ç¨‹ä¸€èˆ¬è¢«ç§°ä¸º<strong>è°ƒåº¦çº¿ç¨‹</strong>ã€‚</li>
<li>åç¨‹å‘ç”Ÿ io é˜»å¡æˆ–è°ƒç”¨ sleep ç­‰æ“ä½œæ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šæŒ‚èµ·æ­¤åç¨‹ã€‚</li>
<li>åç¨‹æŒ‚èµ·æ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šåˆ‡æ¢åˆ°å…¶ä»–ç­‰å¾…ä¸­çš„åç¨‹è¿è¡Œã€‚</li>
<li>åç¨‹çš„åˆ‡æ¢æ˜¯åœ¨ç”¨æˆ·æ€è¿›è¡Œçš„ï¼Œæ¯”çº¿ç¨‹é—´çš„åˆ‡æ¢æ›´å¿«ã€‚</li>
</ul>
<p>åç¨‹éå¸¸é€‚åˆå†™ç½‘ç»œç¨‹åºï¼Œå¯ä»¥å®ç°<strong>åŒæ­¥çš„ç¼–ç¨‹æ–¹å¼</strong>ï¼Œä¸éœ€è¦å¼‚æ­¥å›è°ƒï¼Œå¤§å¤§å‡è½»äº†ç¨‹åºå‘˜çš„æ€æƒ³è´Ÿæ‹…ã€‚</p>
<p>co åç¨‹åº“å®ç°çš„æ˜¯ä¸€ç§ç±»ä¼¼ <a href="https://github.com/golang/go/">golang</a> çš„åç¨‹ï¼Œæœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒå¤šçº¿ç¨‹è°ƒåº¦ï¼Œé»˜è®¤çº¿ç¨‹æ•°ä¸ºç³»ç»Ÿ CPU æ ¸æ•°ã€‚</li>
<li>å…±äº«æ ˆï¼ŒåŒä¸€çº¿ç¨‹ä¸­çš„åç¨‹å…±ç”¨è‹¥å¹²ä¸ªæ ˆ(å¤§å°é»˜è®¤ä¸º 1MB)ï¼Œå†…å­˜å ç”¨ä½ï¼ŒLinux ä¸Šçš„æµ‹è¯•æ˜¾ç¤º 1000 ä¸‡åç¨‹åªç”¨äº† 2.8G å†…å­˜(ä»…ä¾›å‚è€ƒ)ã€‚</li>
<li>åç¨‹åˆ›å»ºåï¼Œå§‹ç»ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œè€Œä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>å„åç¨‹ä¹‹é—´ä¸ºå¹³çº§å…³ç³»ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹(åŒ…æ‹¬åœ¨åç¨‹ä¸­)åˆ›å»ºæ–°çš„åç¨‹ã€‚</li>
</ul>
<p>co åç¨‹åº“åœ¨ linux, mac, windows ç­‰å¹³å°ï¼Œåˆ†åˆ«åŸºäº <a href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll</a>, <a href="https://man.openbsd.org/kqueue.2">kqueue</a>, <a href="https://docs.microsoft.com/en-us/windows/win32/fileio/i-o-completion-ports">iocp</a> å®ç°ã€‚</p>
<p>co åç¨‹åº“ä¸­ context åˆ‡æ¢ç›¸å…³çš„ä»£ç ï¼Œå–è‡ª <a href="https://github.com/waruqi">ruki</a> çš„ <a href="https://github.com/tboox/tbox/">tbox</a>ï¼Œè€Œ tbox åˆ™å‚è€ƒäº† <a href="https://www.boost.org/doc/libs/1_70_0/libs/context/doc/html/index.html">boost</a> çš„å®ç°ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿè°¢ï¼</p>
<h2 id="åç¨‹-api"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b-api">#</a>åç¨‹ API</h2>
<h3 id="v30-åˆ é™¤çš„-api"><a class="anchor" href="#v30-%e5%88%a0%e9%99%a4%e7%9a%84-api">#</a>v3.0 åˆ é™¤çš„ API</h3>
<ul>
<li><strong>co::init</strong>, v3.0 ç§»é™¤ï¼Œä» co 3.0 å¼€å§‹ï¼Œä¸€èˆ¬åªéœ€è¦åœ¨ main å‡½æ•°å¼€å¤´è°ƒç”¨ <code>flag::init(argc, argv)</code>ã€‚</li>
<li><strong>co::exit</strong>, v3.0 ç§»é™¤ã€‚</li>
<li><strong>co::stop</strong>, v3.0 ç§»é™¤ã€‚</li>
<li><strong>co::all_schedulers</strong>, v3.0 é‡å‘½åä¸º <a href="#coschedulers">co::schedulers</a>ã€‚</li>
</ul>
<h3 id="go"><a class="anchor" href="#go">#</a>go</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">go</span>(Closure<span style="color:#000;font-weight:bold">*</span> cb);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> F<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#458;font-weight:bold">void</span> go(F<span style="color:#000;font-weight:bold">&amp;&amp;</span> f);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> F, <span style="color:#000;font-weight:bold">typename</span> P<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#458;font-weight:bold">void</span> go(F<span style="color:#000;font-weight:bold">&amp;&amp;</span> f, P<span style="color:#000;font-weight:bold">&amp;&amp;</span> p);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> F, <span style="color:#000;font-weight:bold">typename</span> T, <span style="color:#000;font-weight:bold">typename</span> P<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#458;font-weight:bold">void</span> go(F<span style="color:#000;font-weight:bold">&amp;&amp;</span> f, T<span style="color:#000;font-weight:bold">*</span> t, P<span style="color:#000;font-weight:bold">&amp;&amp;</span> p);
</span></span></code></pre></div><ul>
<li>
<p>æ­¤å‡½æ•°ç”¨äº<strong>åˆ›å»ºåç¨‹</strong>ï¼Œä¸åˆ›å»ºçº¿ç¨‹ç±»ä¼¼ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªåç¨‹å‡½æ•°ã€‚</p>
</li>
<li>
<p>ç¬¬ 1 ä¸ªç‰ˆæœ¬ä¸­ï¼Œå‚æ•° cb æŒ‡å‘ä¸€ä¸ª Closure å¯¹è±¡ï¼Œåç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Closure ä¸­çš„ <code>run()</code>Â æ–¹æ³•ã€‚</p>
</li>
<li>
<p>ç¬¬ 2-4 ä¸ªç‰ˆæœ¬ï¼Œå°†ä¼ å…¥çš„å‚æ•°æ‰“åŒ…æˆä¸€ä¸ª Closureï¼Œç„¶åè°ƒç”¨ç¬¬ 1 ä¸ªç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p>ç¬¬ 2 ä¸ªç‰ˆæœ¬ä¸­ï¼Œå‚æ•° f æ˜¯ä»»æ„å¯è°ƒç”¨çš„å¯¹è±¡ï¼Œåªè¦èƒ½è°ƒç”¨ <code>f()</code>Â æˆ– <code>(*f)()</code>Â å°±è¡Œã€‚</p>
</li>
<li>
<p>ç¬¬ 3 ä¸ªç‰ˆæœ¬ä¸­ï¼Œå‚æ•° f æ˜¯ä»»æ„å¯è°ƒç”¨çš„å¯¹è±¡ï¼Œåªè¦èƒ½è°ƒç”¨ <code>f(p)</code>, <code>(*f)(p)</code>Â æˆ– <code>(p-&gt;*f)()</code>Â å°±è¡Œã€‚</p>
</li>
<li>
<p>ç¬¬ 4 ä¸ªç‰ˆæœ¬ä¸­ï¼Œå‚æ•° f æ˜¯ç±»ä¸­å¸¦ä¸€ä¸ªå‚æ•°çš„æ–¹æ³• <code>void T::f(P)</code>ï¼Œå‚æ•° t æ˜¯ <code>T</code>Â ç±»å‹çš„æŒ‡é’ˆï¼Œå‚æ•° p æ˜¯æ–¹æ³• f çš„å‚æ•°ã€‚</p>
</li>
<li>
<p>å®é™…æµ‹è¯•å‘ç°ï¼Œåˆ›å»º <code>std::function</code> ç±»å‹çš„å¯¹è±¡å¼€é”€è¾ƒå¤§ï¼Œåº”å°½é‡å°‘ç”¨ã€‚</p>
</li>
<li>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œgo() åªæ˜¯å°† Closure åˆ†é…åˆ°ä¸€ä¸ªè°ƒåº¦çº¿ç¨‹ä¸­ï¼ŒçœŸæ­£åˆ›å»ºåç¨‹æ˜¯ç”±è°ƒåº¦çº¿ç¨‹å®Œæˆçš„ã€‚ä½†ä»ç”¨æˆ·çš„è§’åº¦çœ‹ï¼Œé€»è¾‘ä¸Šå¯ä»¥è®¤ä¸º go() åˆ›å»ºäº†åç¨‹ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>go(f);             <span style="color:#998;font-style:italic">// void f();
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>go(f, <span style="color:#099">7</span>);          <span style="color:#998;font-style:italic">// void f(int);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>go(<span style="color:#000;font-weight:bold">&amp;</span>T<span style="color:#000;font-weight:bold">::</span>f, <span style="color:#000;font-weight:bold">&amp;</span>o);     <span style="color:#998;font-style:italic">// void T::f();    T o;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>go(<span style="color:#000;font-weight:bold">&amp;</span>T<span style="color:#000;font-weight:bold">::</span>f, <span style="color:#000;font-weight:bold">&amp;</span>o, <span style="color:#099">3</span>);  <span style="color:#998;font-style:italic">// void T::f(int); T o;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// lambda
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>go([](){
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello co&#34;</span>;
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// std::function
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>std<span style="color:#000;font-weight:bold">::</span>function<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">void</span>()<span style="color:#000;font-weight:bold">&gt;</span> x(std<span style="color:#000;font-weight:bold">::</span>bind(f, <span style="color:#099">7</span>));
</span></span><span style="display:flex;"><span>go(x);
</span></span><span style="display:flex;"><span>go(<span style="color:#000;font-weight:bold">&amp;</span>x); <span style="color:#998;font-style:italic">// Ensure that x is alive when the coroutine is running.
</span></span></span></code></pre></div><h3 id="def_main"><a class="anchor" href="#def_main">#</a>DEF_main</h3>
<p>è¿™ä¸ªå®ç”¨äºå®šä¹‰ main å‡½æ•°ï¼Œå¹¶å°† main å‡½æ•°ä¸­çš„ä»£ç ä¹Ÿæ”¾åˆ°åç¨‹ä¸­è¿è¡Œã€‚DEF_main å†…éƒ¨å·²ç»è°ƒç”¨ <code>flag::init(argc, argv)</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œç”¨æˆ·æ— éœ€å†æ¬¡è°ƒç”¨ã€‚</p>
<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_main(argc, argv) {
</span></span><span style="display:flex;"><span>    go([](){
</span></span><span style="display:flex;"><span>        LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;hello world&#34;</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>sleep(<span style="color:#099">100</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="cocoroutine"><a class="anchor" href="#cocoroutine">#</a>co::coroutine</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">coroutine</span>();
</span></span></code></pre></div><ul>
<li>è¿”å›å½“å‰çš„ coroutine æŒ‡é’ˆï¼Œè‹¥åœ¨éåç¨‹ä¸­è°ƒç”¨æ­¤å‡½æ•°ï¼Œåˆ™è¿”å›å€¼æ˜¯ NULLã€‚</li>
<li>æ­¤å‡½æ•°çš„è¿”å›å€¼ï¼Œå¯ä½œä¸º <a href="#coresume">co::resume()</a> çš„å‚æ•°ï¼Œç”¨äºå”¤é†’åç¨‹ã€‚</li>
</ul>
<h3 id="coresume"><a class="anchor" href="#coresume">#</a>co::resume</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">resume</span>(<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> p);
</span></span></code></pre></div><ul>
<li>å”¤é†’æŒ‡å®šçš„åç¨‹ï¼Œå‚æ•° <code>p</code> æ˜¯ <a href="#cocoroutine">co::coroutine()</a> çš„è¿”å›å€¼ã€‚</li>
<li>æ­¤å‡½æ•°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯åœ¨ä»»æ„åœ°æ–¹è°ƒç”¨ã€‚</li>
</ul>
<h3 id="coyield"><a class="anchor" href="#coyield">#</a>co::yield</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">yield</span>();
</span></span></code></pre></div><ul>
<li>æŒ‚èµ·å½“å‰åç¨‹ï¼Œå¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨ã€‚</li>
<li>æ­¤å‡½æ•°é…åˆ <a href="#cocoroutine">co::coroutine()</a> ä¸ <a href="#coresume">co::resume()</a>ï¼Œå¯ä»¥æ‰‹åŠ¨æ§åˆ¶åç¨‹çš„è°ƒåº¦ï¼Œè¯¦æƒ…å‚è€ƒ <a href="https://github.com/idealvin/coost/blob/master/test/yield.cc">test/yield.cc</a>ã€‚</li>
</ul>
<h3 id="coscheduler"><a class="anchor" href="#coscheduler">#</a>co::scheduler</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Scheduler<span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">scheduler</span>();
</span></span></code></pre></div><ul>
<li>è¿”å›å½“å‰çº¿ç¨‹çš„ scheduler æŒ‡é’ˆï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è°ƒåº¦çº¿ç¨‹ï¼Œè¿”å›å€¼æ˜¯ NULLã€‚</li>
<li>æ­¤å‡½æ•°ä¸€èˆ¬åœ¨åç¨‹ä¸­è°ƒç”¨ï¼Œç”¨äºè·å–å½“å‰åç¨‹æ‰€åœ¨çš„ schedulerã€‚</li>
</ul>
<h3 id="coschedulers"><a class="anchor" href="#coschedulers">#</a>co::schedulers</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> co<span style="color:#000;font-weight:bold">::</span>vector<span style="color:#000;font-weight:bold">&lt;</span>Scheduler<span style="color:#000;font-weight:bold">*&gt;&amp;</span> schedulers();
</span></span></code></pre></div><ul>
<li>è¿”å› Scheduler åˆ—è¡¨çš„å¼•ç”¨ï¼Œä¸€ä¸ª Scheduler å¯¹åº”ä¸€ä¸ªè°ƒåº¦çº¿ç¨‹ã€‚</li>
</ul>
<h3 id="conext_scheduler"><a class="anchor" href="#conext_scheduler">#</a>co::next_scheduler</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Scheduler<span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">next_scheduler</span>();
</span></span></code></pre></div><ul>
<li>
<p>æ­¤å‡½æ•°è¿”å›ä¸‹ä¸€ä¸ª Scheduler æŒ‡é’ˆã€‚</p>
</li>
<li>
<p><code>go(...)</code>Â å®é™…ä¸Šç­‰ä»·äº <code>co::next_scheduler()-&gt;go(...)</code>ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// åˆ›å»ºåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œçš„åç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">auto</span> s <span style="color:#000;font-weight:bold">=</span> co<span style="color:#000;font-weight:bold">::</span>next_scheduler();
</span></span><span style="display:flex;"><span>s<span style="color:#000;font-weight:bold">-&gt;</span>go(f1);
</span></span><span style="display:flex;"><span>s<span style="color:#000;font-weight:bold">-&gt;</span>go(f2);
</span></span></code></pre></div><h3 id="coscheduler_num"><a class="anchor" href="#coscheduler_num">#</a>co::scheduler_num</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">scheduler_num</span>();
</span></span></code></pre></div><ul>
<li>
<p>è¿”å› scheduler çš„æ•°é‡ï¼Œæ­¤å‡½æ•°å¸¸ç”¨äºå®ç°ä¸€äº›åç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>vector<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> v(co<span style="color:#000;font-weight:bold">::</span>scheduler_num());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// get object for the current scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">auto</span><span style="color:#000;font-weight:bold">&amp;</span> t <span style="color:#000;font-weight:bold">=</span> v[co<span style="color:#000;font-weight:bold">::</span>scheduler_id()];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(f);
</span></span></code></pre></div><h3 id="coscheduler_id"><a class="anchor" href="#coscheduler_id">#</a>co::scheduler_id</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">scheduler_id</span>();
</span></span></code></pre></div><ul>
<li>è¿”å›å½“å‰çº¿ç¨‹çš„ scheduler idï¼Œè¿™ä¸ªå€¼æ˜¯ 0 åˆ° <code>co::scheduler_num()-1</code>Â ä¹‹é—´çš„å€¼ã€‚å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è°ƒåº¦çº¿ç¨‹ï¼Œè¿”å›å€¼æ˜¯ -1ã€‚</li>
<li>æ­¤å‡½æ•°ä¸€èˆ¬åœ¨åç¨‹ä¸­è°ƒç”¨ï¼Œç”¨äºè·å–å½“å‰åç¨‹æ‰€åœ¨çš„ scheduler idã€‚</li>
</ul>
<h3 id="cocoroutine_id"><a class="anchor" href="#cocoroutine_id">#</a>co::coroutine_id</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">coroutine_id</span>();
</span></span></code></pre></div><ul>
<li>æ­¤å‡½æ•°è¿”å›å½“å‰åç¨‹çš„ idï¼Œä¸åŒåç¨‹æœ‰ä¸åŒçš„ idã€‚</li>
<li>æ­¤å‡½æ•°ä¸€èˆ¬åœ¨åç¨‹ä¸­è°ƒç”¨ï¼Œåœ¨éåç¨‹ä¸­è°ƒç”¨æ—¶ï¼Œè¿”å›å€¼æ˜¯ -1ã€‚</li>
<li>åç¨‹ id ä¸ scheduler id æœ‰ç€ç®€å•çš„çº¿æ€§å¯¹åº”å…³ç³»ã€‚å‡è®¾æœ‰ 4 ä¸ª schedulerï¼Œid åˆ†åˆ«æ˜¯ 0, 1, 2, 3ï¼Œè¿™äº› scheduler å†…çš„åç¨‹ id åˆ†åˆ«æ˜¯ï¼š</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#099">4</span>k        (<span style="color:#099">0</span>, <span style="color:#099">4</span>, <span style="color:#099">8</span>, ...)
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>k <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>    (<span style="color:#099">1</span>, <span style="color:#099">5</span>, <span style="color:#099">9</span>, ...)
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>k <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">2</span>    (<span style="color:#099">2</span>, <span style="color:#099">6</span>, <span style="color:#099">10</span>, ...)
</span></span><span style="display:flex;"><span><span style="color:#099">4</span>k <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">3</span>    (<span style="color:#099">3</span>, <span style="color:#099">7</span>, <span style="color:#099">11</span>, ...)
</span></span></code></pre></div><h3 id="cosleep"><a class="anchor" href="#cosleep">#</a>co::sleep</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">sleep</span>(uint32 ms);
</span></span></code></pre></div><ul>
<li>è®©å½“å‰åç¨‹ç¡ä¸€ä¼šå„¿ï¼Œå‚æ•° ms æ˜¯æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li>
<li>æ­¤å‡½æ•°ä¸€èˆ¬åœ¨åç¨‹ä¸­è°ƒç”¨ï¼Œåœ¨éåç¨‹ä¸­è°ƒç”¨ç›¸å½“äº <code>sleep::ms(ms)</code>ã€‚</li>
</ul>
<h3 id="cotimeout"><a class="anchor" href="#cotimeout">#</a>co::timeout</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#900;font-weight:bold">timeout</span>();
</span></span></code></pre></div><ul>
<li>æ­¤å‡½æ•°åˆ¤æ–­ä¹‹å‰çš„ IO æ“ä½œæ˜¯å¦è¶…æ—¶ã€‚ç”¨æˆ·åœ¨è°ƒç”¨ <code>co::recv()</code>Â ç­‰å¸¦è¶…æ—¶æ—¶é—´çš„å‡½æ•°åï¼Œå¯ä»¥è°ƒç”¨æ­¤å‡½æ•°åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚</li>
<li><strong>æ­¤å‡½æ•°å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// print scheduler id and coroutine id every 3 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>) {
</span></span><span style="display:flex;"><span>        LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;s: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> co<span style="color:#000;font-weight:bold">::</span>scheduler_id() <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34; c: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> co<span style="color:#000;font-weight:bold">::</span>coroutine_id();
</span></span><span style="display:flex;"><span>        co<span style="color:#000;font-weight:bold">::</span>sleep(<span style="color:#099">3000</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">main</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">**</span> argv) {
</span></span><span style="display:flex;"><span>    flag<span style="color:#000;font-weight:bold">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>    FLG_cout <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>; <span style="color:#998;font-style:italic">// also log to terminal
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">32</span>; <span style="color:#000;font-weight:bold">++</span>i) go(f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>) sleep<span style="color:#000;font-weight:bold">::</span>sec(<span style="color:#099">1024</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="åç¨‹åŒ–çš„-socket-api"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b%e5%8c%96%e7%9a%84-socket-api">#</a>åç¨‹åŒ–çš„ socket API</h2>
<p>co æä¾›äº†å¸¸ç”¨çš„åç¨‹åŒ–çš„ socket APIï¼Œä»¥æ”¯æŒåŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹ã€‚</p>
<p><strong>å¤§éƒ¨åˆ† API å½¢å¼ä¸Šä¸åŸç”Ÿçš„ socket API ä¿æŒä¸€è‡´</strong>ï¼Œè¿™æ ·å¯ä»¥å‡è½»ç”¨æˆ·çš„å­¦ä¹ è´Ÿæ‹…ï¼Œç†Ÿæ‚‰ socket ç¼–ç¨‹çš„ç”¨æˆ·å¯ä»¥è½»æ¾ä¸Šæ‰‹ã€‚</p>
<p>è¿™äº› API å¤§éƒ¨åˆ†éœ€è¦åœ¨åç¨‹ä¸­ä½¿ç”¨ï¼Œå®ƒä»¬åœ¨ I/O é˜»å¡æˆ–è°ƒç”¨ sleep ç­‰æ“ä½œæ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šæŒ‚èµ·å½“å‰åç¨‹ï¼Œåˆ‡æ¢åˆ°å…¶ä»–ç­‰å¾…ä¸­çš„åç¨‹è¿è¡Œï¼Œè°ƒåº¦çº¿ç¨‹æœ¬èº«å¹¶ä¸ä¼šé˜»å¡ã€‚å€ŸåŠ©è¿™äº› APIï¼Œç”¨æˆ·å¯ä»¥<strong>è½»æ¾çš„å®ç°é«˜å¹¶å‘ã€é«˜æ€§èƒ½çš„ç½‘ç»œç¨‹åº</strong>ã€‚</p>
<h3 id="æœ¯è¯­çº¦å®šå¿…çœ‹"><a class="anchor" href="#%e6%9c%af%e8%af%ad%e7%ba%a6%e5%ae%9a%e5%bf%85%e7%9c%8b">#</a>æœ¯è¯­çº¦å®š(å¿…çœ‹)</h3>
<p><strong>é˜»å¡</strong></p>
<p>åœ¨æè¿° co ä¸­çš„ä¸€äº› socket API æ—¶ï¼Œä¼šç”¨åˆ°é˜»å¡ä¸€è¯ï¼Œå¦‚ accept, recvï¼Œæ–‡æ¡£ä¸­è¯´å®ƒä»¬ä¼šé˜»å¡ï¼Œæ˜¯æŒ‡å½“å‰çš„åç¨‹ä¼šé˜»å¡ï¼Œè€Œå½“å‰çš„è°ƒåº¦çº¿ç¨‹å¹¶ä¸ä¼šé˜»å¡(å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–åç¨‹è¿è¡Œ)ã€‚ç”¨æˆ·çœ‹åˆ°çš„æ˜¯åç¨‹ï¼Œè€Œä¸æ˜¯è°ƒåº¦çº¿ç¨‹ï¼Œå› æ­¤ä»ç”¨æˆ·çš„è§’åº¦çœ‹ï¼Œå®ƒä»¬æ˜¯é˜»å¡çš„ã€‚å®é™…ä¸Šï¼Œè¿™äº› API å†…éƒ¨ä½¿ç”¨ <strong>non-blocking socket</strong>ï¼Œå¹¶ä¸ä¼šçœŸçš„é˜»å¡ï¼Œåªæ˜¯åœ¨ socket ä¸Šæ²¡æœ‰æ•°æ®å¯è¯»æˆ–è€…æ— æ³•ç«‹å³å†™å…¥æ•°æ®æ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šæŒ‚èµ·å½“å‰è¿›è¡Œ I/O æ“ä½œçš„åç¨‹ï¼Œå½“ socket å˜ä¸ºå¯è¯»æˆ–å¯å†™æ—¶ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šé‡æ–°å”¤èµ·è¯¥åç¨‹ï¼Œç»§ç»­ I/O æ“ä½œã€‚</p>
<p><strong>non-blocking socket</strong></p>
<p><strong>co ä¸­çš„ socket API å¿…é¡»ä½¿ç”¨ non-blocking socket</strong>ï¼Œåœ¨ windows å¹³å°è¿˜è¦æ±‚ socket æ”¯æŒ <a href="https://support.microsoft.com/en-us/help/181611/socket-overlapped-i-o-versus-blocking-nonblocking-mode">overlapped I/O</a>ï¼Œwin32 API åˆ›å»ºçš„ socket é»˜è®¤éƒ½æ”¯æŒ overlapped I/Oï¼Œç”¨æˆ·ä¸€èˆ¬ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œè¿™é‡Œçº¦å®šæ–‡æ¡£ä¸­è¯´åˆ° non-blocking socket æ—¶ï¼ŒåŒæ—¶ä¹Ÿè¡¨ç¤ºå®ƒåœ¨ windows ä¸Šæ”¯æŒ overlapped I/Oã€‚</p>
<h3 id="cosocket"><a class="anchor" href="#cosocket">#</a>co::socket</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>sock_t <span style="color:#900;font-weight:bold">socket</span>(<span style="color:#458;font-weight:bold">int</span> domain, <span style="color:#458;font-weight:bold">int</span> type, <span style="color:#458;font-weight:bold">int</span> proto);
</span></span><span style="display:flex;"><span>sock_t <span style="color:#900;font-weight:bold">tcp_socket</span>(<span style="color:#458;font-weight:bold">int</span> domain<span style="color:#000;font-weight:bold">=</span>AF_INET);
</span></span><span style="display:flex;"><span>sock_t <span style="color:#900;font-weight:bold">udp_socket</span>(<span style="color:#458;font-weight:bold">int</span> domain<span style="color:#000;font-weight:bold">=</span>AF_INET);
</span></span></code></pre></div><ul>
<li>åˆ›å»º socketã€‚</li>
<li>ç¬¬ 1 ä¸ªå‡½æ•°å½¢å¼ä¸Šä¸åŸç”Ÿ API å®Œå…¨ä¸€æ ·ï¼Œåœ¨ linux ç³»ç»Ÿå¯ä»¥ç”¨ <code>man socket</code>Â æŸ¥çœ‹å‚æ•°è¯¦æƒ…ã€‚</li>
<li>ç¬¬ 2 ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ª TCP socketã€‚</li>
<li>ç¬¬ 3 ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ª UDPÂ socketã€‚</li>
<li>å‚æ•° domain ä¸€èˆ¬æ˜¯ AF_INET æˆ– AF_INET6ï¼Œå‰è€…è¡¨ç¤º ipv4ï¼Œåè€…è¡¨ç¤º ipv6ã€‚</li>
<li><strong>è¿™äº›å‡½æ•°è¿”å›ä¸€ä¸ª non-blocking socket</strong>ã€‚å‘ç”Ÿé”™è¯¯æ—¶ï¼Œè¿”å›å€¼æ˜¯ -1ï¼Œå¯ä»¥è°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="coaccept"><a class="anchor" href="#coaccept">#</a>co::accept</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>sock_t <span style="color:#900;font-weight:bold">accept</span>(sock_t fd, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> addr, <span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">*</span> addrlen);
</span></span></code></pre></div><ul>
<li>åœ¨æŒ‡å®š socket ä¸Šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œå‚æ•° fd æ˜¯ä¹‹å‰è°ƒç”¨ listen() ç›‘å¬çš„ non-blocking socketï¼Œå‚æ•° addr ä¸ addrlen ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯ï¼Œ<code>*addrlen</code>Â çš„åˆå§‹å€¼æ˜¯ addr æ‰€æŒ‡å‘ buffer çš„é•¿åº¦ã€‚å¦‚æœç”¨æˆ·ä¸éœ€è¦å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯ï¼Œå¯ä»¥å°† addr ä¸ addrlen è®¾ç½®ä¸º NULLã€‚</li>
<li>æ­¤å‡½æ•°<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>æ­¤å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ–°çš„è¿æ¥è¿›æ¥ï¼Œæˆ–è€…å‘ç”Ÿé”™è¯¯ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶<strong>è¿”å›ä¸€ä¸ª non-blocking socket</strong>ï¼Œå‘ç”Ÿé”™è¯¯æ—¶è¿”å› -1ï¼Œå¯ä»¥è°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="cobind"><a class="anchor" href="#cobind">#</a>co::bind</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">bind</span>(sock_t fd, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> addr, <span style="color:#458;font-weight:bold">int</span> addrlen);
</span></span></code></pre></div><ul>
<li>ç»™ socket ç»‘å®š ip åœ°å€ï¼Œå‚æ•° addr ä¸ addrlen æ˜¯åœ°å€ä¿¡æ¯ï¼Œä¸åŸç”Ÿ API ç›¸åŒã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› 0ï¼Œå¦åˆ™è¿”å› -1ï¼Œå¯ä»¥è°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="coclose"><a class="anchor" href="#coclose">#</a>co::close</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">close</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>);
</span></span></code></pre></div><ul>
<li>å…³é—­ socketã€‚</li>
<li>åœ¨ 2.0.0 åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ­¤å‡½æ•°å¿…é¡»åœ¨è¿›è¡Œ I/O æ“ä½œçš„çº¿ç¨‹ä¸­è°ƒç”¨ã€‚ä» 2.0.1 ç‰ˆæœ¬å¼€å§‹ï¼Œæ­¤å‡½æ•°å¯ä»¥åœ¨åç¨‹æˆ–éåç¨‹ä¸­è°ƒç”¨ã€‚</li>
<li>å‚æ•° ms &gt; 0 æ—¶ï¼Œå…ˆè°ƒç”¨ <code>co::sleep(ms)</code> å°†å½“å‰åç¨‹æŒ‚èµ·ä¸€æ®µæ—¶é—´ï¼Œå†å…³é—­ socketã€‚ä¸€èˆ¬åªåœ¨ server ç«¯è®¾ç½® &gt; 0 çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£éæ³•çš„ç½‘ç»œæ”»å‡»ã€‚</li>
<li>æ­¤å‡½æ•°å†…éƒ¨å·²ç»å¤„ç†äº† <code>EINTR</code> ä¿¡å·ï¼Œç”¨æˆ·æ— éœ€è€ƒè™‘ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› 0ï¼Œå¦åˆ™è¿”å› -1ï¼Œå¯ä»¥è°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="coconnect"><a class="anchor" href="#coconnect">#</a>co::connect</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">connect</span>(sock_t fd, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> addr, <span style="color:#458;font-weight:bold">int</span> addrlen, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>åœ¨æŒ‡å®š socket ä¸Šåˆ›å»ºåˆ°æŒ‡å®šåœ°å€çš„è¿æ¥ï¼Œå‚æ•° fd å¿…é¡»æ˜¯ non-blocking çš„ï¼Œå‚æ•° addr ä¸ addrlen æ˜¯åœ°å€ä¿¡æ¯ï¼Œå‚æ•° ms æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤ä¸º -1ï¼Œæ°¸ä¸è¶…æ—¶ã€‚</li>
<li>æ­¤å‡½æ•°<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>æ­¤å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°è¿æ¥å®Œæˆï¼Œæˆ–è€…è¶…æ—¶ã€å‘ç”Ÿé”™è¯¯ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› 0ï¼Œè¶…æ—¶æˆ–å‘ç”Ÿé”™è¯¯è¿”å› -1ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨ co::timeout()Â åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="colisten"><a class="anchor" href="#colisten">#</a>co::listen</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">listen</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> backlog<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1024</span>);
</span></span></code></pre></div><ul>
<li>ç›‘å¬æŒ‡å®šçš„ socketï¼Œå‚æ•° fd æ˜¯å·²ç»è°ƒç”¨ bind() ç»‘å®š ip åŠç«¯å£çš„ socketã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› 0ï¼Œå¦åˆ™è¿”å› -1ï¼Œå¯ä»¥è°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="corecv"><a class="anchor" href="#corecv">#</a>co::recv</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">recv</span>(sock_t fd, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>åœ¨æŒ‡å®š socket ä¸Šæ¥æ”¶æ•°æ®ï¼Œå‚æ•° fd å¿…é¡»æ˜¯ non-blocking çš„ï¼Œå‚æ•° buf æ˜¯ç”¨äºæ¥æ”¶æ•°æ®çš„ bufferï¼Œå‚æ•° n æ˜¯ buffer é•¿åº¦ï¼Œå‚æ•° ms æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤ä¸º -1ï¼Œæ°¸ä¸è¶…æ—¶ã€‚</li>
<li>æ­¤å‡½æ•°<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>åœ¨ Windows å¹³å°ï¼Œæ­¤å‡½æ•°åªé€‚ç”¨äº TCP ç­‰ stream ç±»å‹çš„ socketã€‚</li>
<li>æ­¤å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®è¿›æ¥ï¼Œæˆ–è€…è¶…æ—¶ã€å‘ç”Ÿé”™è¯¯ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„æ•°æ®é•¿åº¦(å¯èƒ½å°äº n)ï¼Œå¯¹ç«¯å…³é—­è¿æ¥æ—¶è¿”å› 0ï¼Œè¶…æ—¶æˆ–å‘ç”Ÿé”™è¯¯è¿”å› -1ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨ co::timeout()Â åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="corecvn"><a class="anchor" href="#corecvn">#</a>co::recvn</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">recvn</span>(sock_t fd, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>åœ¨æŒ‡å®š socket ä¸Šæ¥æ”¶æŒ‡å®šé•¿åº¦çš„æ•°æ®ï¼Œå‚æ•° fd å¿…é¡»æ˜¯ non-blocking çš„ï¼Œå‚æ•° buf æ˜¯ç”¨äºæ¥æ”¶æ•°æ®çš„ bufferï¼Œå‚æ•° n æ˜¯è¦æ¥æ”¶æ•°æ®çš„é•¿åº¦ï¼Œå‚æ•° ms æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤ä¸º -1ï¼Œæ°¸ä¸è¶…æ—¶ã€‚</li>
<li>æ­¤å‡½æ•°<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>æ­¤å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ° n å­—èŠ‚çš„æ•°æ®å…¨éƒ¨æ¥æ”¶å®Œï¼Œæˆ–è€…è¶…æ—¶ã€å‘ç”Ÿé”™è¯¯ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› nï¼Œå¯¹ç«¯å…³é—­è¿æ¥æ—¶è¿”å› 0ï¼Œè¶…æ—¶æˆ–å‘ç”Ÿé”™è¯¯è¿”å› -1ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨ co::timeout()Â æ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼Œè°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="corecvfrom"><a class="anchor" href="#corecvfrom">#</a>co::recvfrom</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">recvfrom</span>(sock_t fd, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> src_addr, <span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">*</span> addrlen, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>ä¸ recv() ç±»ä¼¼ï¼Œåªæ˜¯å¯ä»¥ç”¨å‚æ•° src_addr ä¸ addrlen æ¥æ”¶æºåœ°å€ä¿¡æ¯ï¼Œ<code>*addrlen</code>Â çš„åˆå§‹å€¼æ˜¯ src_addr æ‰€æŒ‡å‘ buffer çš„é•¿åº¦ï¼Œå¦‚æœç”¨æˆ·ä¸éœ€è¦æºåœ°å€ä¿¡æ¯ï¼Œå¯ä»¥å°† addr ä¸ addrlen è®¾ç½®ä¸º NULLã€‚</li>
<li>ä¸€èˆ¬<strong>å»ºè®®åªç”¨æ­¤å‡½æ•°æ¥æ”¶ UDP æ•°æ®</strong>ï¼Œå¯¹äº TCP æ•°æ®ï¼Œå»ºè®®ç”¨ recv() æˆ– recvn()ã€‚</li>
</ul>
<h3 id="cosend"><a class="anchor" href="#cosend">#</a>co::send</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">send</span>(sock_t fd, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>å‘æŒ‡å®š socket ä¸Šå‘é€æ•°æ®ï¼Œå‚æ•° fd å¿…é¡»æ˜¯ non-blocking çš„ï¼Œå‚æ•° buf ä¸ n æ˜¯è¦å‘é€çš„æ•°æ®åŠé•¿åº¦ï¼Œå‚æ•° ms æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤ä¸º -1ï¼Œæ°¸ä¸è¶…æ—¶ã€‚</li>
<li>æ­¤å‡½æ•°<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>åœ¨ Windows å¹³å°ï¼Œæ­¤å‡½æ•°åªé€‚ç”¨äº TCP ç­‰ stream ç±»å‹çš„ socketã€‚</li>
<li>æ­¤å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ° n å­—èŠ‚çš„æ•°æ®å…¨éƒ¨å‘é€å®Œï¼Œæˆ–è€…è¶…æ—¶ã€å‘ç”Ÿé”™è¯¯ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› nï¼Œè¶…æ—¶æˆ–å‘ç”Ÿé”™è¯¯è¿”å› -1ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨ co::timeout()Â æ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼Œè°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="cosendto"><a class="anchor" href="#cosendto">#</a>co::sendto</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">sendto</span>(sock_t fd, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> dst_addr, <span style="color:#458;font-weight:bold">int</span> addrlen, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>å‘æŒ‡å®šçš„åœ°å€å‘é€æ•°æ®ï¼Œå½“ dst_addr ä¸º NULLï¼Œaddrlen ä¸º 0 æ—¶ï¼Œä¸ send() ç­‰ä»·ã€‚</li>
<li>ä¸€èˆ¬<strong>å»ºè®®åªç”¨æ­¤å‡½æ•°å‘é€ UDP æ•°æ®</strong>ï¼Œå¯¹äº TCP æ•°æ®ï¼Œå»ºè®®ç”¨ send()ã€‚</li>
<li>fd æ˜¯ UDP socket æ—¶ï¼Œn æœ€å¤§æ˜¯ 65507ã€‚</li>
</ul>
<h3 id="coshutdown"><a class="anchor" href="#coshutdown">#</a>co::shutdown</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">shutdown</span>(sock_t fd, <span style="color:#458;font-weight:bold">char</span> c<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;b&#39;</span>);
</span></span></code></pre></div><ul>
<li>æ­¤å‡½æ•°ä¸€èˆ¬ç”¨äºåŠå…³é—­ socketï¼Œå‚æ•° c ä¸º <code>'r'</code> æ—¶è¡¨ç¤ºå…³é—­è¯»ï¼Œä¸º <code>'w'</code> æ—¶è¡¨ç¤ºå…³é—­å†™ï¼Œé»˜è®¤ä¸º <code>'b'</code>ï¼Œå…³é—­è¯»ä¸å†™ã€‚</li>
<li>ä¸€èˆ¬å»ºè®®åœ¨è¿›è¡Œ IO æ“ä½œçš„çº¿ç¨‹ä¸­è°ƒç”¨æ­¤å‡½æ•°ã€‚</li>
<li>æ­¤å‡½æ•°æˆåŠŸæ—¶è¿”å› 0ï¼Œå¦åˆ™è¿”å› -1ï¼Œå¯ä»¥è°ƒç”¨ <code>co::error()</code>, <code>co::strerror()</code> è·å–é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="coerror"><a class="anchor" href="#coerror">#</a>co::error</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">&amp;</span> error();
</span></span></code></pre></div><ul>
<li>è¿”å›å½“å‰çš„é”™è¯¯ç ã€‚</li>
<li>CO ä¸­çš„ socket API è¿”å› -1 æ—¶ï¼Œå¯ä»¥è°ƒç”¨æ­¤å‡½æ•°è·å–é”™è¯¯ç ã€‚</li>
</ul>
<h3 id="costrerror"><a class="anchor" href="#costrerror">#</a>co::strerror</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">strerror</span>(<span style="color:#458;font-weight:bold">int</span> err);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">strerror</span>();
</span></span></code></pre></div><ul>
<li>è·å–é”™è¯¯ç å¯¹åº”çš„æè¿°ä¿¡æ¯ã€‚æ­¤å‡½æ•°æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
<li>ç¬¬ 2 ä¸ªç‰ˆæœ¬è·å–å½“å‰é”™è¯¯çš„æè¿°ä¿¡æ¯ï¼Œç­‰ä»·äº <code>strerror(co::error())</code>ã€‚</li>
</ul>
<h3 id="heading"><a class="anchor" href="#heading">#</a>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</h3>
<h3 id="cogetsockopt"><a class="anchor" href="#cogetsockopt">#</a>co::getsockopt</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">getsockopt</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> lv, <span style="color:#458;font-weight:bold">int</span> opt, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> optval, <span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">*</span> optlen);
</span></span></code></pre></div><ul>
<li>è·å– socket option ä¿¡æ¯ï¼Œä¸åŸç”Ÿ API å®Œå…¨ä¸€æ ·ï¼Œman getsockopt çœ‹è¯¦æƒ…ã€‚</li>
</ul>
<h3 id="cosetsockopt"><a class="anchor" href="#cosetsockopt">#</a>co::setsockopt</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">setsockopt</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> lv, <span style="color:#458;font-weight:bold">int</span> opt, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> optval, <span style="color:#458;font-weight:bold">int</span> optlen);
</span></span></code></pre></div><ul>
<li>è®¾ç½® socket option ä¿¡æ¯ï¼Œä¸åŸç”Ÿ API å®Œå…¨ä¸€æ ·ï¼Œman setsockopt çœ‹è¯¦æƒ…ã€‚</li>
</ul>
<h3 id="coset_nonblock"><a class="anchor" href="#coset_nonblock">#</a>co::set_nonblock</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_nonblock</span>(sock_t fd);
</span></span></code></pre></div><ul>
<li>ç»™ socket è®¾ç½® O_NONBLOCK é€‰é¡¹ã€‚</li>
</ul>
<h3 id="coset_reuseaddr"><a class="anchor" href="#coset_reuseaddr">#</a>co::set_reuseaddr</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_reuseaddr</span>(sock_t fd);
</span></span></code></pre></div><ul>
<li>ç»™ socket è®¾ç½®Â SO_REUSEADDR é€‰é¡¹ï¼Œä¸€èˆ¬ server ç«¯çš„ listening socket éœ€è¦è®¾ç½®è¿™ä¸ªé€‰é¡¹ï¼Œé˜²æ­¢ server é‡å¯å bind å¤±è´¥ã€‚</li>
</ul>
<h3 id="coset_recv_buffer_size"><a class="anchor" href="#coset_recv_buffer_size">#</a>co::set_recv_buffer_size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_recv_buffer_size</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> n);
</span></span></code></pre></div><ul>
<li>è®¾ç½® socket çš„æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼Œå¿…é¡»åœ¨ socket è¿æ¥å‰è°ƒç”¨æ­¤å‡½æ•°ã€‚</li>
</ul>
<h3 id="coset_send_buffer_size"><a class="anchor" href="#coset_send_buffer_size">#</a>co::set_send_buffer_size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_send_buffer_size</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> n);
</span></span></code></pre></div><ul>
<li>è®¾ç½® socket çš„å‘é€ç¼“å†²åŒºå¤§å°ï¼Œå¿…é¡»åœ¨ socket è¿æ¥å‰è°ƒç”¨æ­¤å‡½æ•°ã€‚</li>
</ul>
<h3 id="coset_tcp_keepalive"><a class="anchor" href="#coset_tcp_keepalive">#</a>co::set_tcp_keepalive</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_tcp_keepalive</span>(sock_t fd);
</span></span></code></pre></div><ul>
<li>ç»™ socket è®¾ç½® SO_KEEPALIVE é€‰é¡¹ã€‚</li>
</ul>
<h3 id="coset_tcp_nodelay"><a class="anchor" href="#coset_tcp_nodelay">#</a>co::set_tcp_nodelay</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">set_tcp_nodelay</span>(sock_t fd);
</span></span></code></pre></div><ul>
<li>ç»™ socket è®¾ç½® TCP_NODELAY é€‰é¡¹ã€‚</li>
</ul>
<h3 id="coreset_tcp_socket"><a class="anchor" href="#coreset_tcp_socket">#</a>co::reset_tcp_socket</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">reset_tcp_socket</span>(sock_t fd, <span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>);
</span></span></code></pre></div><ul>
<li>é‡ç½® TCP è¿æ¥ï¼Œä¸ co::close() ç±»ä¼¼ï¼Œä½†ä¸»åŠ¨è°ƒç”¨æ–¹ä¸ä¼šè¿›å…¥ TIME_WAIT çŠ¶æ€ã€‚</li>
<li>ä¸€èˆ¬åªæœ‰ server ç«¯ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œç”¨äºä¸»åŠ¨å…³é—­å®¢æˆ·ç«¯è¿æ¥ï¼ŒåŒæ—¶é¿å…è¿›å…¥ TIME_WAIT çŠ¶æ€ã€‚</li>
</ul>
<h3 id="heading-1"><a class="anchor" href="#heading-1">#</a>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</h3>
<h3 id="coinit_ip_addr"><a class="anchor" href="#coinit_ip_addr">#</a>co::init_ip_addr</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#900;font-weight:bold">init_ip_addr</span>(<span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in</span><span style="color:#000;font-weight:bold">*</span> addr, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span> ip, <span style="color:#458;font-weight:bold">int</span> port);
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#900;font-weight:bold">init_ip_addr</span>(<span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in6</span><span style="color:#000;font-weight:bold">*</span> addr, <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">char</span><span style="color:#000;font-weight:bold">*</span> ip, <span style="color:#458;font-weight:bold">int</span> port);
</span></span></code></pre></div><ul>
<li>
<p>ç”¨ ip åŠ port åˆå§‹åŒ– sockaddr ç»“æ„ã€‚</p>
</li>
<li>
<p>ç¬¬ 1 ä¸ªç‰ˆæœ¬ç”¨äº ipv4 åœ°å€ï¼Œç¬¬ 2 ä¸ªç‰ˆæœ¬ç”¨äº ipv6 åœ°å€ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">union</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in</span>  v4;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in6</span> v6;
</span></span><span style="display:flex;"><span>} addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>init_ip_addr(<span style="color:#000;font-weight:bold">&amp;</span>addr.v4, <span style="color:#d14">&#34;127.0.0.1&#34;</span>, <span style="color:#099">7777</span>);
</span></span><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>init_ip_addr(<span style="color:#000;font-weight:bold">&amp;</span>addr.v6, <span style="color:#d14">&#34;::&#34;</span>, <span style="color:#099">7777</span>);
</span></span></code></pre></div><h3 id="coip_str"><a class="anchor" href="#coip_str">#</a>co::ip_str</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>fastring <span style="color:#900;font-weight:bold">ip_str</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in</span><span style="color:#000;font-weight:bold">*</span> addr);
</span></span><span style="display:flex;"><span>fastring <span style="color:#900;font-weight:bold">ip_str</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in6</span><span style="color:#000;font-weight:bold">*</span> addr);
</span></span></code></pre></div><ul>
<li>
<p>ä» sockaddr ç»“æ„ä¸­è·å– ip å­—ç¬¦ä¸²ã€‚</p>
</li>
<li>
<p>ç¬¬ 1 ä¸ªç‰ˆæœ¬ç”¨äº ipv4 åœ°å€ï¼Œç¬¬ 2 ä¸ªç‰ˆæœ¬ç”¨äº ipv6 åœ°å€ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in</span> addr;
</span></span><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>init_ip_addr(<span style="color:#000;font-weight:bold">&amp;</span>addr, <span style="color:#d14">&#34;127.0.0.1&#34;</span>, <span style="color:#099">7777</span>);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">auto</span> s <span style="color:#000;font-weight:bold">=</span> co<span style="color:#000;font-weight:bold">::</span>ip_str(<span style="color:#000;font-weight:bold">&amp;</span>addr);  <span style="color:#998;font-style:italic">// s -&gt; &#34;127.0.0.1&#34;
</span></span></span></code></pre></div><h3 id="coto_string"><a class="anchor" href="#coto_string">#</a>co::to_string</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>fastring <span style="color:#900;font-weight:bold">to_string</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in</span><span style="color:#000;font-weight:bold">*</span> addr);
</span></span><span style="display:flex;"><span>fastring <span style="color:#900;font-weight:bold">to_string</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in6</span><span style="color:#000;font-weight:bold">*</span> addr);
</span></span><span style="display:flex;"><span>fastring <span style="color:#900;font-weight:bold">to_string</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> addr, <span style="color:#458;font-weight:bold">int</span> addrlen);
</span></span></code></pre></div><ul>
<li>
<p>å°† sockaddr åœ°å€è½¬æ¢æˆ <code>&quot;ip:port&quot;</code> å½¢å¼çš„å­—ç¬¦ä¸²ã€‚</p>
</li>
<li>
<p>ç¬¬ 1 ä¸ªç‰ˆæœ¬ç”¨äº ipv4 åœ°å€ï¼Œç¬¬ 2 ä¸ªç‰ˆæœ¬ç”¨äº ipv6 åœ°å€ã€‚</p>
</li>
<li>
<p>ç¬¬ 3 ä¸ªç‰ˆæœ¬æ ¹æ® addrlen é€‰æ‹©è°ƒç”¨ç‰ˆæœ¬ 1 æˆ–ç‰ˆæœ¬ 2ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">sockaddr_in</span> addr;
</span></span><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>init_ip_addr(<span style="color:#000;font-weight:bold">&amp;</span>addr, <span style="color:#d14">&#34;127.0.0.1&#34;</span>, <span style="color:#099">7777</span>);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">auto</span> s <span style="color:#000;font-weight:bold">=</span> co<span style="color:#000;font-weight:bold">::</span>to_string(<span style="color:#000;font-weight:bold">&amp;</span>addr);  <span style="color:#998;font-style:italic">// s -&gt; &#34;127.0.0.1:7777&#34;
</span></span></span></code></pre></div><h3 id="copeer"><a class="anchor" href="#copeer">#</a>co::peer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>fastring <span style="color:#900;font-weight:bold">peer</span>(sock_t fd);
</span></span></code></pre></div><ul>
<li>è·å– peer ç«¯çš„åœ°å€ä¿¡æ¯ï¼Œè¿”å›å€¼æ˜¯ <code>&quot;ip:port&quot;</code> å½¢å¼çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>
<h2 id="channelcochan"><a class="anchor" href="#channelcochan">#</a>channel(co::Chan)</h2>
<p><code>co::Chan</code> æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå®ƒç±»ä¼¼äº golang ä¸­çš„ channelï¼Œç”¨äºåœ¨åç¨‹ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span> <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Chan</span>;
</span></span></code></pre></div><ul>
<li><code>co::Chan</code> å†…éƒ¨åŸºäºå†…å­˜æ‹·è´å®ç°ï¼Œæ¨¡æ¿å‚æ•° T å¯ä»¥æ˜¯å†…ç½®ç±»å‹ã€æŒ‡é’ˆç±»å‹ï¼Œæˆ–è€…<strong>æ‹·è´æ“ä½œå…·æœ‰ç®€å•çš„å†…å­˜æ‹·è´è¯­ä¹‰çš„ç»“æ„ä½“ç±»å‹</strong>ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒT å¿…é¡»æ»¡è¶³ä¸‹è¿°æ¡ä»¶ï¼šå¯¹äº T ç±»å‹çš„ä¸¤ä¸ªå˜é‡æˆ–å¯¹è±¡ a ä¸ b, <strong><code>a = b</code> ç­‰ä»·äº <code>memcpy(&amp;a, &amp;b, sizeof(T))</code></strong>ã€‚</li>
<li>åƒ <code>std::string</code> æˆ– STL ä¸­çš„å®¹å™¨ç±»å‹ï¼Œæ‹·è´æ“ä½œä¸æ˜¯ç®€å•çš„å†…å­˜æ‹·è´ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥åœ¨ channel ä¸­ä¼ é€’ã€‚</li>
</ul>
<h3 id="chanchan"><a class="anchor" href="#chanchan">#</a>Chan::Chan</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#900;font-weight:bold">Chan</span>(uint32 cap<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>, uint32 ms<span style="color:#000;font-weight:bold">=</span>(uint32)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>);
</span></span><span style="display:flex;"><span>Chan(Chan<span style="color:#000;font-weight:bold">&amp;&amp;</span> c);
</span></span><span style="display:flex;"><span>Chan(<span style="color:#000;font-weight:bold">const</span> Chan<span style="color:#000;font-weight:bold">&amp;</span> c);
</span></span></code></pre></div><ul>
<li>ç¬¬ 1 ä¸ªæ„é€ å‡½æ•°ä¸­ï¼Œå‚æ•° cap æ˜¯å†…éƒ¨é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡ï¼Œé»˜è®¤æ˜¯ 1ï¼Œå‚æ•° ms æ˜¯è¯»å†™æ“ä½œçš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤ä¸º -1ï¼Œæ°¸ä¸è¶…æ—¶ã€‚</li>
<li>ç¬¬ 2 ä¸ªæ˜¯ move æ„é€ å‡½æ•°ï¼Œå¯ä»¥å°† <code>co::Chan</code> æ”¾å…¥ STL å®¹å™¨ä¸­ã€‚</li>
<li>ç¬¬ 3 ä¸ªæ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼Œä»…å°†å†…éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ã€‚</li>
</ul>
<h3 id="operator"><a class="anchor" href="#operator">#</a>operator&laquo;</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span> <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> T<span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">&lt;&lt;</span>(<span style="color:#000;font-weight:bold">const</span> T<span style="color:#000;font-weight:bold">&amp;</span> x) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>å†™å…¥æ“ä½œï¼Œå¿…é¡»åœ¨åç¨‹ä¸­è¿›è¡Œã€‚</li>
<li>æ­¤æ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°å†™å…¥æ“ä½œå®Œæˆæˆ–è¶…æ—¶ã€‚</li>
<li>æ„é€ å‡½æ•°ä¸­è®¾ç½®äº†è¶…æ—¶æ—¶é—´æ—¶ï¼Œå¯ä»¥ç”¨ <code>co::timeout()</code> åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚</li>
</ul>
<h3 id="operator-1"><a class="anchor" href="#operator-1">#</a>operator&raquo;</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span> <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> T<span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">&gt;&gt;</span>(T<span style="color:#000;font-weight:bold">&amp;</span> x) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>è¯»å–æ“ä½œï¼Œå¿…é¡»åœ¨åç¨‹ä¸­è¿›è¡Œã€‚</li>
<li>æ­¤æ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°è¯»å–æ“ä½œå®Œæˆæˆ–è¶…æ—¶ã€‚</li>
<li>æ„é€ å‡½æ•°ä¸­è®¾ç½®äº†è¶…æ—¶æ—¶é—´æ—¶ï¼Œå¯ä»¥ç”¨ <code>co::timeout()</code> åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹-1"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b-1">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/co.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>Chan<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">&gt;</span> ch;
</span></span><span style="display:flex;"><span>    go([ch]() { ch <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">7</span>; });
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">int</span> v <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>    ch <span style="color:#000;font-weight:bold">&gt;&gt;</span> v;
</span></span><span style="display:flex;"><span>    LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;v: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> v;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">g</span>() {
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>Chan<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">int</span><span style="color:#000;font-weight:bold">&gt;</span> ch(<span style="color:#099">32</span>, <span style="color:#099">500</span>);
</span></span><span style="display:flex;"><span>    go([ch]() {
</span></span><span style="display:flex;"><span>        ch <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">7</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (co<span style="color:#000;font-weight:bold">::</span>timeout()) LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;write to channel timeout..&#34;</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">int</span> v <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>    ch <span style="color:#000;font-weight:bold">&gt;&gt;</span> v;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>co<span style="color:#000;font-weight:bold">::</span>timeout()) LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;v: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> v;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DEF_main(argc, argv) {
</span></span><span style="display:flex;"><span>    f();
</span></span><span style="display:flex;"><span>    g();
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šè¿°ä»£ç ä¸­çš„ channel å¯¹è±¡åœ¨æ ˆä¸Šï¼Œè€Œ CO é‡‡ç”¨çš„æ˜¯å…±äº«æ ˆå®ç°æ–¹å¼ï¼Œä¸€ä¸ªåç¨‹æ ˆä¸Šçš„æ•°æ®å¯èƒ½è¢«å…¶ä»–åç¨‹è¦†ç›–ï¼Œ<strong>åç¨‹é—´ä¸€èˆ¬ä¸èƒ½ç›´æ¥é€šè¿‡æ ˆä¸Šçš„æ•°æ®é€šä¿¡</strong>ï¼Œå› æ­¤ä»£ç ä¸­çš„ lambda é‡‡ç”¨äº†<strong>æŒ‰å€¼æ•è·</strong>çš„æ–¹å¼ï¼Œå°† channel æ‹·è´äº†ä¸€ä»½ï¼Œä¼ é€’åˆ°æ–°å»ºçš„åç¨‹ä¸­ã€‚channel çš„æ‹·è´æ“ä½œåªæ˜¯å°†å†…éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ï¼Œå‡ ä¹ä¸ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚</p>
<h2 id="åç¨‹åŒæ­¥äº‹ä»¶coevent"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b%e5%90%8c%e6%ad%a5%e4%ba%8b%e4%bb%b6coevent">#</a>åç¨‹åŒæ­¥äº‹ä»¶(co::Event)</h2>
<p><code>co::Event</code>Â æ˜¯åç¨‹é—´çš„ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå®ƒä¸çº¿ç¨‹ä¸­çš„ <code>SyncEvent</code>Â ç±»ä¼¼ã€‚ä» co 2.0.1 ç‰ˆæœ¬å¼€å§‹ï¼Œco::Event å¯ä»¥åœ¨çº¿ç¨‹ã€åç¨‹ç¯å¢ƒä¸­æ··ç”¨ã€‚</p>
<h3 id="eventevent"><a class="anchor" href="#eventevent">#</a>Event::Event</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Event();
</span></span><span style="display:flex;"><span>Event(Event<span style="color:#000;font-weight:bold">&amp;&amp;</span> e);
</span></span><span style="display:flex;"><span>Event(<span style="color:#000;font-weight:bold">const</span> Event<span style="color:#000;font-weight:bold">&amp;</span> e);
</span></span></code></pre></div><ul>
<li>ç¬¬ 1 ä¸ªæ˜¯é»˜è®¤æ„é€ å‡½æ•°ã€‚</li>
<li>ç¬¬ 2 ä¸ªæ˜¯ move æ„é€ å‡½æ•°ï¼Œæ”¯æŒå°† co::Event æ”¾å…¥ STL å®¹å™¨ä¸­ã€‚</li>
<li>ç¬¬ 3 ä¸ªæ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼Œä»…å°†å†…éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ã€‚</li>
</ul>
<h3 id="eventsignal"><a class="anchor" href="#eventsignal">#</a>Event::signal</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">signal</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>äº§ç”ŸåŒæ­¥ä¿¡å·ï¼Œco::Event å˜æˆåŒæ­¥çŠ¶æ€ï¼Œæ‰€æœ‰ waiting çŠ¶æ€çš„åç¨‹ä¼šè¢«å”¤é†’ã€‚</li>
<li>è‹¥ co::Event å½“å‰å¹¶æ²¡æœ‰ waiting çŠ¶æ€çš„åç¨‹ï¼Œåˆ™ä¸‹ä¸€ä¸ªè°ƒç”¨ wait() æ–¹æ³•çš„åç¨‹ä¼šç«‹å³è¿”å›ã€‚</li>
<li>æ­¤æ–¹æ³•å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</li>
</ul>
<h3 id="eventwait"><a class="anchor" href="#eventwait">#</a>Event::wait</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">wait</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#900;font-weight:bold">wait</span>(uint32 ms) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>ç­‰å¾…åŒæ­¥ä¿¡å·ï¼Œè‹¥ co::Event å½“å‰æ˜¯æœªåŒæ­¥çŠ¶æ€ï¼Œåˆ™è°ƒç”¨çš„åç¨‹ä¼šè¿›å…¥ waiting çŠ¶æ€ã€‚</li>
<li>åœ¨ co 2.0.0 åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæ­¤æ–¹æ³•å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨ã€‚ä» 2.0.1 ç‰ˆæœ¬å¼€å§‹ï¼Œæ­¤æ–¹æ³•å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</li>
<li>ç¬¬ 1 ä¸ªç‰ˆæœ¬ä¼šé˜»å¡ï¼Œç›´åˆ° co::Event å˜ä¸ºåŒæ­¥çŠ¶æ€ã€‚</li>
<li>ç¬¬ 2 ä¸ªç‰ˆæœ¬ä¼šé˜»å¡ï¼Œç›´åˆ° co::Event å˜ä¸ºåŒæ­¥çŠ¶æ€æˆ–è¶…æ—¶ï¼Œå‚æ•° ms æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚è¶…æ—¶è¿”å› falseï¼Œæ­£å¸¸è¿”å› trueã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹-2"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b-2">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>Event ev;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// capture by value, as data on stack may be overwritten by other coroutines.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>go([ev](){
</span></span><span style="display:flex;"><span>    ev.signal();
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ev.wait(<span style="color:#099">100</span>);  <span style="color:#998;font-style:italic">// wait for 100 ms
</span></span></span></code></pre></div><h2 id="waitgroupcowaitgroup"><a class="anchor" href="#waitgroupcowaitgroup">#</a>waitgroup(co::WaitGroup)</h2>
<p><code>co::WaitGroup</code> ç±»ä¼¼äº golang ä¸­çš„ <code>sync.WaitGroup</code>ï¼Œå¯ç”¨äºç­‰å¾…åç¨‹æˆ–çº¿ç¨‹çš„é€€å‡ºã€‚</p>
<h3 id="waitgroupwaitgroup"><a class="anchor" href="#waitgroupwaitgroup">#</a>WaitGroup::WaitGroup</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#900;font-weight:bold">WaitGroup</span>(uint32 n);
</span></span><span style="display:flex;"><span>WaitGroup();
</span></span><span style="display:flex;"><span>WaitGroup(WaitGroup<span style="color:#000;font-weight:bold">&amp;&amp;</span> wg);
</span></span><span style="display:flex;"><span>WaitGroup(<span style="color:#000;font-weight:bold">const</span> WaitGroup<span style="color:#000;font-weight:bold">&amp;</span> wg);
</span></span></code></pre></div><ul>
<li>ç¬¬ 1 ä¸ªæ„é€ å‡½æ•°ï¼Œå°†å†…éƒ¨è®¡æ•°å™¨åˆå§‹åŒ–ä¸º <code>n</code>ã€‚</li>
<li>ç¬¬ 2 ä¸ªæ˜¯é»˜è®¤æ„é€ å‡½æ•°ï¼Œå°†å†…éƒ¨è®¡æ•°å™¨åˆå§‹åŒ–ä¸º 0ã€‚</li>
<li>ç¬¬ 3 ä¸ªæ˜¯ move æ„é€ å‡½æ•°ï¼Œæ”¯æŒå°† co::WaitGroup æ”¾å…¥ STL å®¹å™¨ä¸­ã€‚</li>
<li>ç¬¬ 4 ä¸ªæ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼Œä»…å°†å†…éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ã€‚</li>
</ul>
<h3 id="waitgroupadd"><a class="anchor" href="#waitgroupadd">#</a>WaitGroup::add</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">add</span>(uint32 n<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>å°†å†…éƒ¨è®¡æ•°å™¨åŠ  nï¼Œn é»˜è®¤å€¼æ˜¯ 1ã€‚</li>
<li>æ­¤æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</li>
</ul>
<h3 id="waitgroupdone"><a class="anchor" href="#waitgroupdone">#</a>WaitGroup::done</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">done</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>å°†å†…éƒ¨è®¡æ•°å™¨å‡ 1ã€‚</li>
<li>æ­¤æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</li>
<li>æ­¤æ–¹æ³•é€šå¸¸åœ¨åç¨‹æˆ–çº¿ç¨‹å‡½æ•°ç»“æŸæ—¶è°ƒç”¨ã€‚</li>
</ul>
<h3 id="waitgroupwait"><a class="anchor" href="#waitgroupwait">#</a>WaitGroup::wait</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">wait</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>ç­‰å¾…ç›´åˆ°å†…éƒ¨è®¡æ•°å™¨çš„å€¼å˜ä¸º 0ã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹-3"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b-3">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;co/co.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>DEF_main(argc, argv) {
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>WaitGroup wg;
</span></span><span style="display:flex;"><span>    wg.add(<span style="color:#099">8</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">8</span>; <span style="color:#000;font-weight:bold">++</span>i) {
</span></span><span style="display:flex;"><span>        go([wg]() {
</span></span><span style="display:flex;"><span>            LOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;co: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> co<span style="color:#000;font-weight:bold">::</span>coroutine_id();
</span></span><span style="display:flex;"><span>            wg.done();
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    wg.wait();
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="åç¨‹é”comutex"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b%e9%94%81comutex">#</a>åç¨‹é”(co::Mutex)</h2>
<p><code>co::Mutex</code>Â æ˜¯åç¨‹ä¸­çš„äº’æ–¥é”ï¼Œä¸çº¿ç¨‹ä¸­çš„ <code>Mutex</code>Â ç±»ä¼¼ï¼Œåªæ˜¯éœ€è¦åœ¨åç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>
<h3 id="mutexmutex"><a class="anchor" href="#mutexmutex">#</a>Mutex::Mutex</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Mutex();
</span></span><span style="display:flex;"><span>Mutex(Mutex<span style="color:#000;font-weight:bold">&amp;&amp;</span> m);
</span></span><span style="display:flex;"><span>Mutex(<span style="color:#000;font-weight:bold">const</span> Mutex<span style="color:#000;font-weight:bold">&amp;</span> m);
</span></span></code></pre></div><ul>
<li>ç¬¬ 1 ä¸ªæ˜¯é»˜è®¤æ„é€ å‡½æ•°ã€‚</li>
<li>ç¬¬ 2 ä¸ªæ˜¯ move æ„é€ å‡½æ•°ï¼Œå¯ä»¥å°† co::Mutex æ”¾å…¥ STL å®¹å™¨ä¸­ã€‚</li>
<li>ç¬¬ 3 ä¸ªæ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼Œä»…å°†å†…éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ã€‚</li>
</ul>
<h3 id="mutexlock"><a class="anchor" href="#mutexlock">#</a>Mutex::lock</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">lock</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>è·å–é”ï¼Œ<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>é˜»å¡ç›´åˆ°è·å¾—é”ä¸ºæ­¢ã€‚</li>
</ul>
<h3 id="mutextry_lock"><a class="anchor" href="#mutextry_lock">#</a>Mutex::try_lock</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#900;font-weight:bold">try_lock</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼ŒæˆåŠŸè·å–é”æ—¶è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</li>
<li>æ­¤æ–¹æ³•å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä½†ä¸€èˆ¬æ˜¯åœ¨åç¨‹ä¸­è°ƒç”¨ã€‚</li>
</ul>
<h3 id="mutexunlock"><a class="anchor" href="#mutexunlock">#</a>Mutex::unlock</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">unlock</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>é‡Šæ”¾é”ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä½†è®¾è®¡è‰¯å¥½çš„ç¨‹åºï¼Œé€šå¸¸æ˜¯ç”±ä¹‹å‰è·å¾—é”çš„åç¨‹è°ƒç”¨ã€‚</li>
</ul>
<h2 id="comutexguard"><a class="anchor" href="#comutexguard">#</a>co::MutexGuard</h2>
<h3 id="mutexguardmutexguard"><a class="anchor" href="#mutexguardmutexguard">#</a>MutexGuard::MutexGuard</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#900;font-weight:bold">MutexGuard</span>(co<span style="color:#000;font-weight:bold">::</span>Mutex<span style="color:#000;font-weight:bold">&amp;</span> m);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#900;font-weight:bold">MutexGuard</span>(co<span style="color:#000;font-weight:bold">::</span>Mutex<span style="color:#000;font-weight:bold">*</span> m);
</span></span></code></pre></div><ul>
<li>æ„é€ å‡½æ•°ï¼Œè°ƒç”¨ m.lock() è·å–é”ï¼Œå‚æ•° m æ˜¯ <code>co::Mutex</code>Â ç±»çš„å¼•ç”¨æˆ–æŒ‡é’ˆã€‚</li>
</ul>
<h3 id="mutexguardmutexguard-1"><a class="anchor" href="#mutexguardmutexguard-1">#</a>MutexGuard::~MutexGuard</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">~</span>MutexGuard();
</span></span></code></pre></div><ul>
<li>ææ„å‡½æ•°ï¼Œé‡Šæ”¾æ„é€ å‡½æ•°ä¸­è·å¾—çš„é”ã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹-4"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b-4">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>Mutex mtx;
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> v <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f1</span>() {
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>MutexGuard g(mtx);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">++</span>v;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f2</span>() {
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>MutexGuard g(mtx);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">--</span>v;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(f1);
</span></span><span style="display:flex;"><span>go(f2);
</span></span></code></pre></div><h2 id="åç¨‹æ± copool"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b%e6%b1%a0copool">#</a>åç¨‹æ± (co::Pool)</h2>
<p><code>co::Pool</code> æ˜¯ä¸€ç§é€šç”¨çš„åç¨‹æ± ï¼Œå®ƒæ˜¯<strong>åç¨‹å®‰å…¨</strong>çš„ï¼Œå†…éƒ¨å­˜å‚¨ <code>void*</code>Â ç±»å‹çš„æŒ‡é’ˆï¼Œå¯ä»¥ç”¨ä½œè¿æ¥æ± ã€å†…å­˜æ± æˆ–å…¶ä»–ç”¨é€”çš„ç¼“å­˜ã€‚</p>
<h3 id="poolpool"><a class="anchor" href="#poolpool">#</a>Pool::Pool</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Pool();
</span></span><span style="display:flex;"><span>Pool(Pool<span style="color:#000;font-weight:bold">&amp;&amp;</span> p);
</span></span><span style="display:flex;"><span>Pool(<span style="color:#000;font-weight:bold">const</span> Pool<span style="color:#000;font-weight:bold">&amp;</span> p);
</span></span><span style="display:flex;"><span>Pool(std<span style="color:#000;font-weight:bold">::</span>function<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>()<span style="color:#000;font-weight:bold">&gt;&amp;&amp;</span> ccb, std<span style="color:#000;font-weight:bold">::</span>function<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">void</span>(<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>)<span style="color:#000;font-weight:bold">&gt;&amp;&amp;</span> dcb, size_t cap<span style="color:#000;font-weight:bold">=</span>(size_t)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>
<p>ç¬¬ 1 ä¸ªæ˜¯é»˜è®¤æ„é€ å‡½æ•°ï¼Œä¸ç¬¬ 4 ä¸ªç›¸æ¯”ï¼Œccb ä¸ dcb ä¸º NULLã€‚</p>
</li>
<li>
<p>ç¬¬ 2 ä¸ªæ˜¯ move æ„é€ å‡½æ•°ï¼Œå¯ä»¥å°† co::Pool æ”¾å…¥ STL å®¹å™¨ä¸­ã€‚</p>
</li>
<li>
<p>ç¬¬ 3 ä¸ªæ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼Œä»…å°†å†…éƒ¨å¼•ç”¨è®¡æ•°åŠ  1ã€‚</p>
</li>
<li>
<p>ç¬¬ 4 ä¸ªæ„é€ å‡½æ•°ä¸­ï¼Œå‚æ•° ccb ç”¨äºåˆ›å»ºå…ƒç´ ï¼Œå‚æ•° dcb ç”¨äºé”€æ¯å…ƒç´ ï¼Œå‚æ•° cap æŒ‡å®š pool çš„æœ€å¤§å®¹é‡ï¼Œé»˜è®¤ä¸º -1 ä¸é™å®¹é‡ã€‚</p>
</li>
<li>
<p>æ³¨æ„å‚æ•° cap å¹¶ä¸æ˜¯æ€»å®¹é‡ï¼Œå®ƒæ˜¯å¯¹å•ä¸ªçº¿ç¨‹è€Œè¨€ï¼Œåœ¨ co::Pool å†…éƒ¨å®ç°ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ poolï¼Œå¦‚ cap è®¾ç½®ä¸º 1024ï¼Œè°ƒåº¦çº¿ç¨‹æœ‰ 8 ä¸ªï¼Œåˆ™æ€»å®¹é‡æ˜¯ 8192ã€‚</p>
</li>
<li>
<p>å½“ dcb ä¸º NULL æ—¶ï¼Œcap å‚æ•°ä¼šè¢«å¿½ç•¥ï¼Œè¿™æ˜¯å› ä¸ºå½“å…ƒç´ ä¸ªæ•°è¶…è¿‡æœ€å¤§å®¹é‡æ—¶ï¼Œco::Pool éœ€è¦ç”¨ dcb é”€æ¯å¤šä½™çš„å…ƒç´ ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">T</span>;
</span></span><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>Pool p(
</span></span><span style="display:flex;"><span>    []() { <span style="color:#000;font-weight:bold">return</span> (<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>) <span style="color:#000;font-weight:bold">new</span> T; }, <span style="color:#998;font-style:italic">// ccb
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    [](<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> p) { <span style="color:#000;font-weight:bold">delete</span> (T<span style="color:#000;font-weight:bold">*</span>) p; }, <span style="color:#998;font-style:italic">// dcb
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>);
</span></span></code></pre></div><h3 id="poolclear"><a class="anchor" href="#poolclear">#</a>Pool::clear</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">clear</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>æ¸…ç©ºæ•´ä¸ª co::Poolï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚</li>
<li>å¦‚æœè®¾ç½®äº† dcbï¼Œä¼šç”¨ dcb é”€æ¯ pool ä¸­çš„å…ƒç´ ã€‚</li>
</ul>
<h3 id="poolpop"><a class="anchor" href="#poolpop">#</a>Pool::pop</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">pop</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>ä» co::Pool ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œ<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
<li>co::Pool ä¸ºç©ºæ—¶ï¼Œè‹¥ ccb ä¸æ˜¯ NULLï¼Œåˆ™è°ƒç”¨ ccb åˆ›å»ºä¸€ä¸ªå…ƒç´ å¹¶è¿”å›ï¼Œå¦åˆ™è¿”å› NULLã€‚</li>
<li>æ­¤æ–¹æ³•æ˜¯åç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦åŠ é”ã€‚</li>
</ul>
<h3 id="poolpush"><a class="anchor" href="#poolpush">#</a>Pool::push</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">push</span>(<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> e) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>
<p>å°†å…ƒç´ æ”¾å› co::Pool ä¸­ï¼Œ<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</p>
</li>
<li>
<p>å‚æ•° e ä¸º NULL æ—¶ï¼Œç›´æ¥å¿½ç•¥ã€‚</p>
</li>
<li>
<p>ç”±äºæ¯ä¸ªçº¿ç¨‹åœ¨å†…éƒ¨æ‹¥æœ‰è‡ªå·±çš„ poolï¼Œ<strong>push() ä¸ pop() æ–¹æ³•åº”è¯¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨</strong>ã€‚</p>
</li>
<li>
<p>è‹¥ co::Pool å·²ç»è¾¾åˆ°æœ€å¤§å®¹é‡ï¼Œä¸” dcb ä¸ä¸º NULLï¼Œåˆ™ç›´æ¥è°ƒç”¨ <code>dcb(e)</code> é”€æ¯è¯¥å…ƒç´ ã€‚</p>
</li>
<li>
<p>æ­¤æ–¹æ³•æ˜¯åç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦åŠ é”ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Redis</span>;  <span style="color:#998;font-style:italic">// assume class Redis is a connection to the redis server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>co<span style="color:#000;font-weight:bold">::</span>Pool p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> f {
</span></span><span style="display:flex;"><span>    Redis<span style="color:#000;font-weight:bold">*</span> rds <span style="color:#000;font-weight:bold">=</span> (Redis<span style="color:#000;font-weight:bold">*</span>) p.pop();     <span style="color:#998;font-style:italic">// pop a redis connection
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (rds <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) rds <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Redis;
</span></span><span style="display:flex;"><span>    rds<span style="color:#000;font-weight:bold">-&gt;</span>get(<span style="color:#d14">&#34;xx&#34;</span>);                    <span style="color:#998;font-style:italic">// call get() method of redis
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    p.push(rds);                       <span style="color:#998;font-style:italic">// push rds back to co::Pool
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(f);
</span></span></code></pre></div><h3 id="poolsize"><a class="anchor" href="#poolsize">#</a>Pool::size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>size_t <span style="color:#900;font-weight:bold">size</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>è¿”å›å½“å‰çº¿ç¨‹çš„ pool å¤§å°ï¼Œ<strong>å¿…é¡»åœ¨åç¨‹ä¸­è°ƒç”¨</strong>ã€‚</li>
</ul>
<h2 id="copoolguard"><a class="anchor" href="#copoolguard">#</a>co::PoolGuard</h2>
<p><code>co::PoolGuard</code> åœ¨æ„é€ æ—¶è‡ªåŠ¨ä» co::Pool å–å‡ºå…ƒç´ ï¼Œææ„æ—¶è‡ªåŠ¨å°†å…ƒç´ æ”¾å› co::Poolã€‚åŒæ—¶ï¼Œå®ƒè¿˜é‡è½½äº† <code>operator-&gt;</code>ï¼Œå¯ä»¥åƒæ™ºèƒ½æŒ‡é’ˆä¸€æ ·ä½¿ç”¨å®ƒã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">template</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">typename</span> T, <span style="color:#000;font-weight:bold">typename</span> D<span style="color:#000;font-weight:bold">=</span>std<span style="color:#000;font-weight:bold">::</span>default_delete<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">PoolGuard</span>;
</span></span></code></pre></div><ul>
<li>å‚æ•° T æ˜¯ co::Pool ä¸­æŒ‡é’ˆæ‰€æŒ‡å‘çš„å®é™…ç±»å‹ï¼Œå‚æ•° D æ˜¯ deleterï¼Œç”¨äº delete <code>T*</code> ç±»å‹çš„æŒ‡é’ˆã€‚</li>
</ul>
<h3 id="poolguardpoolguard"><a class="anchor" href="#poolguardpoolguard">#</a>PoolGuard::PoolGuard</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#900;font-weight:bold">PoolGuard</span>(co<span style="color:#000;font-weight:bold">::</span>Pool<span style="color:#000;font-weight:bold">&amp;</span> p);
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#900;font-weight:bold">PoolGuard</span>(co<span style="color:#000;font-weight:bold">::</span>Pool<span style="color:#000;font-weight:bold">*</span> p);
</span></span></code></pre></div><ul>
<li>æ„é€ å‡½æ•°ï¼Œä» co::Pool ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå‚æ•° p æ˜¯ co::Pool ç±»çš„å¼•ç”¨æˆ–æŒ‡é’ˆã€‚</li>
</ul>
<h3 id="poolguardpoolguard-1"><a class="anchor" href="#poolguardpoolguard-1">#</a>PoolGuard::~PoolGuard</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">~</span>PoolGuard();
</span></span></code></pre></div><ul>
<li>ææ„å‡½æ•°ï¼Œå°†æ„é€ å‡½æ•°ä¸­è·å–çš„å…ƒç´ ï¼Œæ”¾å› co::Pool ä¸­ã€‚</li>
</ul>
<h3 id="poolguardget"><a class="anchor" href="#poolguardget">#</a>PoolGuard::get</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>T<span style="color:#000;font-weight:bold">*</span> <span style="color:#900;font-weight:bold">get</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>è·å–ä» co::Pool ä¸­å–å‡ºçš„æŒ‡é’ˆã€‚</li>
</ul>
<h3 id="poolguardoperator-"><a class="anchor" href="#poolguardoperator-">#</a>PoolGuard::operator-&gt;</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>T<span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">-&gt;</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>é‡è½½ <code>operator-&gt;</code>ï¼Œè¿”å›ä» co::Pool ä¸­å–å‡ºçš„å…ƒç´ ã€‚</li>
</ul>
<h3 id="poolguardoperator"><a class="anchor" href="#poolguardoperator">#</a>PoolGuard::operator*</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>T<span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">*</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>é‡è½½ <code>operator*</code>ï¼Œè¿”å› T ç±»çš„å¼•ç”¨ã€‚</li>
</ul>
<h3 id="poolguardoperator-bool"><a class="anchor" href="#poolguardoperator-bool">#</a>PoolGuard::operator bool</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">explicit</span> <span style="color:#000;font-weight:bold">operator</span> <span style="color:#900;font-weight:bold">bool</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>å°† co::PoolGuard è½¬æ¢ä¸º bool ç±»å‹ï¼Œè‹¥å†…éƒ¨æŒ‡é’ˆä¸æ˜¯ NULLï¼Œè¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</li>
</ul>
<h3 id="poolguardoperator-1"><a class="anchor" href="#poolguardoperator-1">#</a>PoolGuard::operator!</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">!</span>() <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>åˆ¤æ–­å†…éƒ¨æŒ‡é’ˆæ˜¯å¦ä¸º NULLï¼Œä¸º NULL æ—¶è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</li>
</ul>
<h3 id="poolguardoperator-2"><a class="anchor" href="#poolguardoperator-2">#</a>PoolGuard::operator==</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">==</span>(T<span style="color:#000;font-weight:bold">*</span> p) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>åˆ¤æ–­å†…éƒ¨æŒ‡é’ˆæ˜¯å¦ç­‰äº pã€‚</li>
</ul>
<h3 id="poolguardoperator-3"><a class="anchor" href="#poolguardoperator-3">#</a>PoolGuard::operator!=</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">!=</span>(T<span style="color:#000;font-weight:bold">*</span> p) <span style="color:#000;font-weight:bold">const</span>;
</span></span></code></pre></div><ul>
<li>åˆ¤æ–­å†…éƒ¨æŒ‡é’ˆæ˜¯å¦ä¸ç­‰äº pã€‚</li>
</ul>
<h3 id="poolguardoperator-4"><a class="anchor" href="#poolguardoperator-4">#</a>PoolGuard::operator=</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">=</span>(T<span style="color:#000;font-weight:bold">*</span> p);
</span></span></code></pre></div><ul>
<li>èµ‹å€¼æ“ä½œï¼Œç­‰ä»·äº <code>reset(p)</code>ã€‚</li>
</ul>
<h3 id="poolguardreset"><a class="anchor" href="#poolguardreset">#</a>PoolGuard::reset</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">reset</span>(T<span style="color:#000;font-weight:bold">*</span> p <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>);
</span></span></code></pre></div><ul>
<li>é‡ç½®å†…éƒ¨æŒ‡é’ˆï¼Œå¹¶è°ƒç”¨ <code>D()(x)</code> åˆ é™¤åŸå…ˆçš„æŒ‡é’ˆã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹-5"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b-5">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>Pool p(
</span></span><span style="display:flex;"><span>	[]() { <span style="color:#000;font-weight:bold">return</span> (<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>) <span style="color:#000;font-weight:bold">new</span> string; }, <span style="color:#998;font-style:italic">// ccb
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	[](<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> p) { <span style="color:#000;font-weight:bold">delete</span> (string<span style="color:#000;font-weight:bold">*</span>)p; }  <span style="color:#998;font-style:italic">// dcb
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>);
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">fs</span>() {
</span></span><span style="display:flex;"><span>	co<span style="color:#000;font-weight:bold">::</span>PoolGuard<span style="color:#000;font-weight:bold">&lt;</span>string<span style="color:#000;font-weight:bold">&gt;</span> rds(p); <span style="color:#998;font-style:italic">// now rds can be used like a Redis* pointer.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	rds<span style="color:#000;font-weight:bold">-&gt;</span>append(<span style="color:#d14">&#34;xx&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(fs);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Redis</span>;  <span style="color:#998;font-style:italic">// assume class Redis is a connection to the redis server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>Pool p(
</span></span><span style="display:flex;"><span>    []() { <span style="color:#000;font-weight:bold">return</span> (<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span>) <span style="color:#000;font-weight:bold">new</span> Redis; }, <span style="color:#998;font-style:italic">// ccb
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    [](<span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> p) { <span style="color:#000;font-weight:bold">delete</span> (Redis<span style="color:#000;font-weight:bold">*</span>) p; }  <span style="color:#998;font-style:italic">// dcb
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">f</span>() {
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>PoolGuard<span style="color:#000;font-weight:bold">&lt;</span>Redis<span style="color:#000;font-weight:bold">&gt;</span> rds(p); <span style="color:#998;font-style:italic">// now rds can be used like a Redis* pointer.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    rds<span style="color:#000;font-weight:bold">-&gt;</span>get(<span style="color:#d14">&#34;xx&#34;</span>);<span style="color:#998;font-style:italic">//redisçš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(f);
</span></span></code></pre></div><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œco::Pool ç›¸å½“äº redis è¿æ¥æ± ã€‚å¦‚æœä½¿ç”¨ CLS æœºåˆ¶ï¼Œä¸€ä¸ªåç¨‹ä¸€ä¸ªè¿æ¥ï¼Œåˆ™ 100 ä¸‡åç¨‹éœ€è¦å»ºç«‹ 100 ä¸‡è¿æ¥ï¼Œæ¶ˆè€—è¾ƒå¤§ã€‚ä½†ä½¿ç”¨ pool æœºåˆ¶ï¼Œ100 ä¸‡åç¨‹å¯èƒ½åªéœ€è¦å…±ç”¨å°‘é‡çš„è¿æ¥ã€‚pool æœºåˆ¶æ¯” CLS æ›´é«˜æ•ˆã€æ›´åˆç†ï¼Œè¿™ä¹Ÿæ˜¯ CO ä¸æ”¯æŒ CLS çš„åŸå› ã€‚</p>
<h2 id="io-äº‹ä»¶coioevent"><a class="anchor" href="#io-%e4%ba%8b%e4%bb%b6coioevent">#</a>I/O äº‹ä»¶(co::IoEvent)</h2>
<p><code>co::IoEvent</code>Â ç”¨äº<strong>å°†éé˜»å¡ I/O è½¬æ¢ä¸ºåŒæ­¥æ–¹å¼</strong>ã€‚ç”¨æˆ·åœ¨<strong>åç¨‹</strong>ä¸­å¯¹ä¸€ä¸ª <strong>non-blocking socket</strong> è¿›è¡Œ I/O æ“ä½œï¼Œå½“ socket ä¸å¯è¯»æˆ–ä¸å¯å†™æ—¶ï¼Œç”¨æˆ·è°ƒç”¨ co::IoEvent çš„ <code>wait()</code>Â æ–¹æ³•æŒ‚èµ·åç¨‹ï¼Œç­‰å¾… I/O äº‹ä»¶ï¼›å½“ socket å˜ä¸ºå¯è¯»æˆ–å¯å†™æ—¶ï¼Œè°ƒåº¦çº¿ç¨‹é‡æ–°å”¤é†’è¯¥åç¨‹ï¼Œç»§ç»­ I/O æ“ä½œã€‚</p>
<p><strong>co 1.x</strong> ç‰ˆæœ¬å¹¶æ²¡æœ‰å…¬å¼€ co::IoEvent ç±»ï¼Œåªæ˜¯åœ¨ co å†…éƒ¨ä½¿ç”¨ï¼Œ<strong>co 2.0</strong> ä¸­å°†è¿™ä¸ªç±»å…¬å¼€ï¼Œæ–¹ä¾¿ç”¨æˆ·å°†ä¸‰æ–¹ç½‘ç»œåº“åç¨‹åŒ–ã€‚</p>
<h3 id="coio_event_t"><a class="anchor" href="#coio_event_t">#</a>co::io_event_t</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">io_event_t</span> {
</span></span><span style="display:flex;"><span>    ev_read <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>,
</span></span><span style="display:flex;"><span>    ev_write <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>enum ç±»å‹ï¼Œè¡¨ç¤º I/O äº‹ä»¶ç±»å‹ï¼Œco::ev_read è¡¨ç¤ºè¯»ï¼Œco::ev_write è¡¨ç¤ºå†™ã€‚</li>
</ul>
<h3 id="ioeventioevent"><a class="anchor" href="#ioeventioevent">#</a>IoEvent::IoEvent</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>IoEvent(sock_t fd, io_event_t ev);
</span></span><span style="display:flex;"><span>IoEvent(sock_t fd, <span style="color:#458;font-weight:bold">int</span> n<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>);  <span style="color:#998;font-style:italic">// for windows only
</span></span></span></code></pre></div><ul>
<li>æ„é€ å‡½æ•°ï¼Œlinux ä¸ mac å¹³å°åªæä¾›ç¬¬ 1 ä¸ªç‰ˆæœ¬ï¼Œwindows å¹³å°è¿˜æä¾›ç¬¬ 2 ä¸ªç‰ˆæœ¬ã€‚</li>
<li>ç¬¬ 1 ä¸ªç‰ˆæœ¬ä¸­ï¼Œ<strong>å‚æ•° fd æ˜¯ä¸€ä¸ª non-blocking socket</strong>ï¼Œå‚æ•° ev æ˜¯ I/O äº‹ä»¶ç±»å‹ï¼Œåªèƒ½æ˜¯ co::ev_read æˆ– co::ev_write ä¸­çš„ä¸€ç§ã€‚è°ƒç”¨ wait() æ–¹æ³•ä¼šåœ¨ socket ä¸Šç­‰å¾… ev æŒ‡å®šçš„ I/O äº‹ä»¶ï¼Œwait() æˆåŠŸè¿”å›æ—¶ï¼Œéœ€è¦ç”¨æˆ·è°ƒç”¨ recv, send ç­‰å‡½æ•°å®Œæˆ I/O æ“ä½œã€‚<strong>åœ¨ windows å¹³å°ï¼Œfd å¿…é¡»æ˜¯ TCP socket</strong>(å¯¹äº UDPï¼Œå¾ˆéš¾ç”¨ IOCP æ¨¡æ‹Ÿ epoll æˆ– kqueue çš„è¡Œä¸º)ã€‚</li>
<li>ç¬¬ 2 ä¸ªç‰ˆæœ¬ä»…é€‚ç”¨äº windowsï¼Œä¸ç¬¬ 1 ä¸ªç‰ˆæœ¬ä¸åŒï¼Œfd å¯ä»¥æ˜¯ UDP socketï¼Œä½†ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è°ƒç”¨ WSARecvFrom, WSASendTo ç­‰å‡½æ•°å‘ IOCP å‘é€ overlapped I/O è¯·æ±‚ï¼Œç„¶åè°ƒç”¨ wait() æ–¹æ³•ï¼Œå½“ wait() æˆåŠŸè¿”å›æ—¶ï¼Œè¡¨ç¤º IOCP å·²ç»å¸®ç”¨æˆ·å®Œæˆäº† I/O æ“ä½œã€‚å…·ä½“çš„ç”¨æ³•æ­¤å¤„ä¸è¯¦è¿°ï¼Œä»£ç ä¸­æœ‰è¯¦ç»†çš„æ³¨é‡Šï¼Œå»ºè®®ç›´æ¥å‚è€ƒ <a href="https://github.com/idealvin/co/blob/master/include/co/co/io_event.h">co::IoEvent çš„æºç </a>ï¼Œä»¥åŠ windows ä¸Š <a href="https://github.com/idealvin/co/blob/master/src/co/sock_win.cc">co::accept, co::connect, co::recvfrom, co::sendto çš„å®ç°</a>ã€‚</li>
</ul>
<h3 id="ioeventioevent-1"><a class="anchor" href="#ioeventioevent-1">#</a>IoEvent::~IoEvent</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">~</span>IoEvent();
</span></span></code></pre></div><ul>
<li>ææ„å‡½æ•°ï¼Œä» epoll æˆ– kqueue ä¸­ç§»é™¤ä¹‹å‰æ³¨å†Œçš„ I/O äº‹ä»¶ã€‚</li>
</ul>
<h3 id="ioeventwait"><a class="anchor" href="#ioeventwait">#</a>IoEvent::wait</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">bool</span> <span style="color:#900;font-weight:bold">wait</span>(<span style="color:#458;font-weight:bold">int</span> ms<span style="color:#000;font-weight:bold">=-</span><span style="color:#099">1</span>);
</span></span></code></pre></div><ul>
<li>æ­¤æ–¹æ³•ç­‰å¾… socket ä¸Šçš„ I/O äº‹ä»¶ï¼Œå‚æ•° ms æ˜¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤ä¸º -1ï¼Œæ°¸ä¸è¶…æ—¶ã€‚</li>
<li>æ­¤æ–¹æ³•é˜»å¡ï¼Œç›´åˆ° I/O äº‹ä»¶åˆ°æ¥ï¼Œæˆ–è€…è¶…æ—¶ã€å‘ç”Ÿé”™è¯¯ã€‚</li>
<li>æ­¤æ–¹æ³•æˆåŠŸæ—¶è¿”å› trueï¼Œè¶…æ—¶æˆ–å‘ç”Ÿé”™è¯¯æ—¶è¿”å› falseã€‚ç”¨æˆ·å¯ä»¥ç”¨ <code>co::timeout()</code>Â åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚</li>
</ul>
<h3 id="ä»£ç ç¤ºä¾‹-6"><a class="anchor" href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b-6">#</a>ä»£ç ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">recv</span>(sock_t fd, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#458;font-weight:bold">int</span> ms) {
</span></span><span style="display:flex;"><span>    CHECK(gSched) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;must be called in coroutine..&#34;</span>;
</span></span><span style="display:flex;"><span>    co<span style="color:#000;font-weight:bold">::</span>IoEvent ev(fd, co<span style="color:#000;font-weight:bold">::</span>ev_read);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> r <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">int</span>) CO_RAW_API(recv)(fd, buf, n, <span style="color:#099">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (r <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">return</span> r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (errno <span style="color:#000;font-weight:bold">==</span> EWOULDBLOCK <span style="color:#000;font-weight:bold">||</span> errno <span style="color:#000;font-weight:bold">==</span> EAGAIN) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>ev.wait(ms)) <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> (errno <span style="color:#000;font-weight:bold">!=</span> EINTR) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šé¢çš„ä¾‹å­æ˜¯ <code>co::recv</code> çš„å®ç°ï¼Œè°ƒç”¨åŸç”Ÿ recv æ–¹æ³•äº§ç”Ÿ EWOULDBLOCK æˆ– EAGAIN é”™è¯¯æ—¶ï¼Œç”¨ co::IoEvent ç­‰å¾…è¯»äº‹ä»¶ï¼Œwait() æ­£å¸¸è¿”å›æ—¶è¡¨ç¤º socket å¯è¯»ï¼Œç»§ç»­è°ƒç”¨åŸç”Ÿ recv æ–¹æ³•å®Œæˆè¯»æ“ä½œã€‚</p>
<h2 id="åç¨‹ä¸­ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b%e4%b8%ad%e4%bd%bf%e7%94%a8%e4%b8%89%e6%96%b9%e7%bd%91%e7%bb%9c%e5%ba%93">#</a>åç¨‹ä¸­ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“</h2>
<p>åœ¨åç¨‹ä¸­ç›´æ¥ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“æ—¶ï¼Œæœ‰å¯èƒ½é˜»å¡è°ƒåº¦çº¿ç¨‹ï¼Œå¯¼è‡´è°ƒåº¦çº¿ç¨‹æ— æ³•æ­£å¸¸å·¥ä½œã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯å°†ä¸‰æ–¹åº“åç¨‹åŒ–ï¼Œç¬¬äºŒç§æ˜¯ hook ç³»ç»Ÿä¸­çš„ socket APIï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»ã€‚</p>
<h3 id="åç¨‹åŒ–"><a class="anchor" href="#%e5%8d%8f%e7%a8%8b%e5%8c%96">#</a>åç¨‹åŒ–</h3>
<p>åç¨‹åŒ–éœ€è¦ä¸‰æ–¹åº“æä¾›éé˜»å¡ APIï¼Œåˆ©ç”¨ co::IoEvent å¯ä»¥è½»æ¾å°†è¿™äº› API è½¬æ¢ä¸ºåç¨‹åŒæ­¥æ–¹å¼ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">recv</span>(SSL<span style="color:#000;font-weight:bold">*</span> s, <span style="color:#458;font-weight:bold">void</span><span style="color:#000;font-weight:bold">*</span> buf, <span style="color:#458;font-weight:bold">int</span> n, <span style="color:#458;font-weight:bold">int</span> ms) {
</span></span><span style="display:flex;"><span>    CHECK(co<span style="color:#000;font-weight:bold">::</span>scheduler()) <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;must be called in coroutine..&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">int</span> r, e;
</span></span><span style="display:flex;"><span>    <span style="color:#458;font-weight:bold">int</span> fd <span style="color:#000;font-weight:bold">=</span> SSL_get_fd(s);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (fd <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>        ERR_clear_error();
</span></span><span style="display:flex;"><span>        r <span style="color:#000;font-weight:bold">=</span> SSL_read(s, buf, n);
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (r <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">return</span> r; <span style="color:#998;font-style:italic">// success
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (r <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>            DLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;SSL_read return 0, error: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> SSL_get_error(s, <span style="color:#099">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        e <span style="color:#000;font-weight:bold">=</span> SSL_get_error(s, r);
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (e <span style="color:#000;font-weight:bold">==</span> SSL_ERROR_WANT_READ) {
</span></span><span style="display:flex;"><span>            co<span style="color:#000;font-weight:bold">::</span>IoEvent ev(fd, co<span style="color:#000;font-weight:bold">::</span>ev_read);
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>ev.wait(ms)) <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> (e <span style="color:#000;font-weight:bold">==</span> SSL_ERROR_WANT_WRITE) {
</span></span><span style="display:flex;"><span>            co<span style="color:#000;font-weight:bold">::</span>IoEvent ev(fd, co<span style="color:#000;font-weight:bold">::</span>ev_write);
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>ev.wait(ms)) <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            DLOG <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;SSL_read return &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> r <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;, error: &#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> e;
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> r;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸Šé¢æ˜¯å°† openssl ä¸­çš„ SSL_read åç¨‹åŒ–çš„ä¾‹å­ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œåº•å±‚ä½¿ç”¨ non-blocking socketï¼Œåœ¨ SSL_read äº§ç”Ÿ <code>SSL_ERROR_WANT_READ</code>Â é”™è¯¯æ—¶ï¼Œç”¨ co::IoEvent ç­‰å¾…è¯»äº‹ä»¶ï¼Œäº§ç”Ÿ <code>SSL_ERROR_WANT_WRITE</code>Â é”™è¯¯æ—¶ï¼Œç”¨ co::IoEvent ç­‰å¾…å†™äº‹ä»¶ï¼Œwait() æ­£å¸¸è¿”å›æ—¶ï¼Œè¡¨ç¤º socket å¯è¯»æˆ–å¯å†™ï¼Œç»§ç»­è°ƒç”¨ SSL_read å®Œæˆ I/O æ“ä½œã€‚</p>
<p>ç›®å‰ï¼ŒCO å·²ç»æˆåŠŸå°† openssl, libcurl åç¨‹åŒ–ã€‚ç†è®ºä¸Šï¼Œæ”¯æŒéé˜»å¡ I/O æ“ä½œçš„ä¸‰æ–¹ç½‘ç»œåº“ï¼Œéƒ½å¯ä»¥ç”¨ä¸ä¸Šé¢ç±»ä¼¼çš„æ–¹æ³•åç¨‹åŒ–ã€‚</p>
<h3 id="ç³»ç»Ÿ-api-hook"><a class="anchor" href="#%e7%b3%bb%e7%bb%9f-api-hook">#</a>ç³»ç»Ÿ API hook</h3>
<p>API hook ç®€å•æ¥è¯´å°±æ˜¯æ‹¦æˆªç³»ç»Ÿ API è¯·æ±‚ï¼Œå¦‚æœå‘ç°è¯¥è¯·æ±‚æ˜¯åœ¨åç¨‹ä¸­ï¼Œä¸”ä½¿ç”¨ blocking socketï¼Œå°±å°† socket ä¿®æ”¹æˆ non-blocking æ¨¡å¼ï¼Œç„¶ååˆ©ç”¨ co::IoEvent æˆ– CO ä¸­æ›´åº•å±‚çš„æ¥å£ï¼Œç­‰å¾… socket ä¸Šçš„ I/O äº‹ä»¶ï¼ŒI/O äº‹ä»¶åˆ°æ¥æ—¶ï¼Œå†å”¤é†’åç¨‹ï¼Œè°ƒç”¨åŸç”Ÿçš„ socket api å®Œæˆ I/O æ“ä½œã€‚</p>
<p>ä» CO 2.0.1 å¼€å§‹ï¼Œåœ¨ linux, mac ä¸ windows å¹³å°å‡å·²æ”¯æŒ hookã€‚</p>
<p><strong>API hook ä¸åç¨‹åŒ–çš„åŒºåˆ«</strong>åœ¨äºï¼šå‰è€…æ˜¯å°†é˜»å¡ API è½¬æ¢æˆåç¨‹åŒæ­¥æ–¹å¼ï¼Œåè€…æ˜¯å°†éé˜»å¡ API è½¬æ¢æˆåç¨‹åŒæ­¥æ–¹å¼ã€‚åç¨‹åŒæ­¥æ–¹å¼æ˜¯æŒ‡åç¨‹å¯èƒ½ä¼šé˜»å¡ï¼Œä»åç¨‹çš„è§’åº¦çœ‹æ˜¯åŒæ­¥çš„ï¼Œä½†è°ƒåº¦çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œå®ƒå¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–åç¨‹è¿è¡Œã€‚å¦å¤–ï¼Œå®ƒä»¬çš„ä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œå‰è€…éœ€è¦åœ¨åç¨‹ä¸­ç”¨é˜»å¡çš„æ–¹å¼è°ƒç”¨åŸç”Ÿ APIï¼Œåè€…åˆ™ç›´æ¥åœ¨åç¨‹ä¸­è°ƒç”¨åç¨‹åŒ–çš„ APIã€‚</p>
<p>API hook çš„å¥½å¤„åœ¨äºï¼Œåªéœ€è¦ hook ç³»ç»Ÿä¸­çš„å°‘é‡ socket APIï¼Œå°±å¯ä»¥åœ¨åç¨‹ä¸­ä½¿ç”¨æ‰€æœ‰æä¾›é˜»å¡ API çš„ä¸‰æ–¹åº“ã€‚åç¨‹åŒ–åˆ™éœ€è¦ä¸ºæ¯ä¸ªä¸‰æ–¹åº“å„æä¾›ä¸€å¥—åç¨‹åŒ–çš„ APIï¼Œä½†å®ƒæ¯” API hook æ€§èƒ½æ›´å¥½ï¼Œä¸”æ›´å®‰å…¨ï¼Œå¯ä»¥é¿å…ç”±ä¸‰æ–¹åº“çš„å¤æ‚æ€§å¼•èµ·çš„ä¸€äº›é—®é¢˜ã€‚</p>
<h2 id="åŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼"><a class="anchor" href="#%e5%9f%ba%e4%ba%8e%e5%8d%8f%e7%a8%8b%e7%9a%84%e7%bd%91%e7%bb%9c%e7%bc%96%e7%a8%8b%e6%a8%a1%e5%bc%8f">#</a>åŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼</h2>
<p>åç¨‹å¯ä»¥ç”¨åŒæ­¥çš„æ–¹å¼ï¼Œå®ç°é«˜å¹¶å‘ã€é«˜æ€§èƒ½çš„ç½‘ç»œç¨‹åºã€‚åç¨‹è™½ç„¶ä¼šé˜»å¡ï¼Œä½†è°ƒåº¦çº¿ç¨‹å¯ä»¥åœ¨å¤§é‡çš„åç¨‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œå› æ­¤è¦å®ç°é«˜å¹¶å‘ï¼Œåªéœ€è¦åˆ›å»ºæ›´å¤šçš„åç¨‹å³å¯ã€‚</p>
<p>ä»¥ TCP ç¨‹åºä¸ºä¾‹ï¼ŒæœåŠ¡ç«¯ä¸€èˆ¬é‡‡ç”¨ä¸€ä¸ªè¿æ¥ä¸€ä¸ªåç¨‹çš„æ¨¡å¼ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ›å»ºæ–°çš„åç¨‹ï¼Œåœ¨åç¨‹ä¸­å¤„ç†è¿æ¥ä¸Šçš„æ•°æ®ã€‚å®¢æˆ·ç«¯æ²¡å¿…è¦ä¸€ä¸ªè¿æ¥ä¸€ä¸ªåç¨‹ï¼Œä¸€èˆ¬ä½¿ç”¨è¿æ¥æ± ï¼Œå¤šä¸ªåç¨‹å…±ç”¨è¿æ¥æ± ä¸­çš„è¿æ¥ã€‚</p>
<h3 id="æœåŠ¡ç«¯ç½‘ç»œæ¨¡å‹"><a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9e%8b">#</a>æœåŠ¡ç«¯ç½‘ç»œæ¨¡å‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// recv or send data on the connection
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">on_connection</span>(<span style="color:#458;font-weight:bold">int</span> fd) {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>) {
</span></span><span style="display:flex;"><span>        co<span style="color:#000;font-weight:bold">::</span>recv(fd, ...);  <span style="color:#998;font-style:italic">// recv request from client
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        process(...);       <span style="color:#998;font-style:italic">// process the request
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        co<span style="color:#000;font-weight:bold">::</span>send(fd, ...);  <span style="color:#998;font-style:italic">// send response to client
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">server_fun</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#0086b3">true</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> fd <span style="color:#000;font-weight:bold">=</span> co<span style="color:#000;font-weight:bold">::</span>accept(...);
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (fd <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>) go(on_connection, fd);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(server_fun);
</span></span></code></pre></div><ul>
<li>æœåŠ¡ç«¯é‡‡ç”¨ä¸€ä¸ªè¿æ¥ä¸€ä¸ªåç¨‹çš„æ¨¡å‹ã€‚</li>
<li>åœ¨ä¸€ä¸ªåç¨‹ä¸­ï¼Œè°ƒç”¨ <code>co::accept()</code>Â æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
<li>æœ‰è¿æ¥åˆ°æ¥æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹ï¼Œåœ¨åç¨‹ä¸­å¤„ç†è¿æ¥ä¸Šçš„æ•°æ®ã€‚</li>
<li><code>on_connection()</code>Â æ˜¯å¤„ç†è¿æ¥çš„åç¨‹å‡½æ•°ï¼Œæ¥æ”¶ã€å¤„ç†ä¸å‘é€æ•°æ®ï¼Œåœ¨è¯¥åç¨‹ä¸­ä»¥å®Œå…¨åŒæ­¥çš„æ–¹å¼è¿›è¡Œï¼Œä¸éœ€è¦ä»»ä½•å¼‚æ­¥å›è°ƒã€‚</li>
<li>å®Œæ•´çš„å®ç°å¯ä»¥å‚è€ƒ <a href="https://github.com/idealvin/co/blob/master/test/so/tcp2.cc">co ä¸­çš„æµ‹è¯•ä»£ç </a>ã€‚</li>
</ul>
<h3 id="å®¢æˆ·ç«¯ç½‘ç»œæ¨¡å‹"><a class="anchor" href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9e%8b">#</a>å®¢æˆ·ç«¯ç½‘ç»œæ¨¡å‹</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">client_fun</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">while</span> <span style="color:#0086b3">true</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>connected) co<span style="color:#000;font-weight:bold">::</span>connect(...);  <span style="color:#998;font-style:italic">// connect to the server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        co<span style="color:#000;font-weight:bold">::</span>send(...);                     <span style="color:#998;font-style:italic">// send request to the server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        co<span style="color:#000;font-weight:bold">::</span>recv(...);                     <span style="color:#998;font-style:italic">// recv response from the server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        process(...);                      <span style="color:#998;font-style:italic">// process the response
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (over) co<span style="color:#000;font-weight:bold">::</span>close(...);          <span style="color:#998;font-style:italic">// close the connection
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(client_fun);
</span></span></code></pre></div><ul>
<li>å»ºç«‹è¿æ¥ï¼Œå‘é€ã€æ¥æ”¶ã€å¤„ç†æ•°æ®ï¼Œåœ¨åç¨‹ä¸­ä»¥å®Œå…¨åŒæ­¥çš„æ–¹å¼è¿›è¡Œã€‚</li>
<li>å®Œæ•´çš„å®ç°å¯ä»¥å‚è€ƒ <a href="https://github.com/idealvin/co/blob/master/test/so/tcp2.cc">co ä¸­çš„æµ‹è¯•ä»£ç </a>ã€‚</li>
</ul>
<p>å®é™…åº”ç”¨ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨ <strong>co::Pool</strong> ä½œä¸ºè¿æ¥æ± ï¼Œä»¥é¿å…åˆ›å»ºè¿‡å¤šçš„è¿æ¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>co<span style="color:#000;font-weight:bold">::</span>Pool pool;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">client_fun</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">while</span> <span style="color:#0086b3">true</span> {
</span></span><span style="display:flex;"><span>        co<span style="color:#000;font-weight:bold">::</span>PoolGuard<span style="color:#000;font-weight:bold">&lt;</span>Connection<span style="color:#000;font-weight:bold">&gt;</span> conn(pool);  <span style="color:#998;font-style:italic">// get a idle connection from the pool
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        conn<span style="color:#000;font-weight:bold">-&gt;</span>send(...);                       <span style="color:#998;font-style:italic">// send request to the server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        conn<span style="color:#000;font-weight:bold">-&gt;</span>recv(...);                       <span style="color:#998;font-style:italic">// recv response from the server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        process(...);                          <span style="color:#998;font-style:italic">// process the response
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (over) conn<span style="color:#000;font-weight:bold">-&gt;</span>close(...);            <span style="color:#998;font-style:italic">// close the connection
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go(client_fun);
</span></span></code></pre></div><ul>
<li>co::PoolGuard æ„é€ æ—¶è‡ªåŠ¨ä» co::Pool ä¸­è·å–ä¸€ä¸ªç©ºé—²è¿æ¥ï¼Œææ„æ—¶è‡ªåŠ¨å°†è¯¥è¿æ¥æ”¾åŠ  co::Pool ä¸­ã€‚</li>
</ul>
<h2 id="é…ç½®"><a class="anchor" href="#%e9%85%8d%e7%bd%ae">#</a>é…ç½®</h2>
<h3 id="co_debug_log"><a class="anchor" href="#co_debug_log">#</a>co_debug_log</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_bool(co_debug_log, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;#1 enable debug log for coroutine library&#34;</span>);
</span></span></code></pre></div><ul>
<li>æ‰“å°åç¨‹ç›¸å…³çš„è°ƒè¯•æ—¥å¿—ï¼Œé»˜è®¤ä¸º falseã€‚</li>
</ul>
<h3 id="co_sched_num"><a class="anchor" href="#co_sched_num">#</a>co_sched_num</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_uint32(co_sched_num, os<span style="color:#000;font-weight:bold">::</span>cpunum(), <span style="color:#d14">&#34;#1 number of coroutine schedulers, default: os::cpunum()&#34;</span>);
</span></span></code></pre></div><ul>
<li>åç¨‹è°ƒåº¦çº¿ç¨‹çš„æ•°é‡ï¼Œé»˜è®¤ä¸ºç³»ç»Ÿ CPU æ ¸æ•°ã€‚ç›®å‰çš„å®ç°ä¸­ï¼Œè¿™ä¸ªå€¼æœ€å¤§ä¹Ÿæ˜¯ç³»ç»Ÿ CPU æ ¸æ•°ã€‚</li>
</ul>
<h3 id="co_stack_size"><a class="anchor" href="#co_stack_size">#</a>co_stack_size</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_uint32(co_stack_size, <span style="color:#099">1024</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">1024</span>, <span style="color:#d14">&#34;#1 size of the stack shared by coroutines, default: 1M&#34;</span>);
</span></span></code></pre></div><ul>
<li>åç¨‹æ ˆå¤§å°ï¼Œé»˜è®¤ä¸º 1Mã€‚</li>
</ul>
<h3 id="disable_hook_sleep"><a class="anchor" href="#disable_hook_sleep">#</a>disable_hook_sleep</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_bool(disable_hook_sleep, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;#1 disable hook sleep if true&#34;</span>);
</span></span></code></pre></div><ul>
<li>ç¦æ­¢ hook sleep ç›¸å…³çš„ APIï¼Œé»˜è®¤ä¸º falseã€‚</li>
</ul>
<h3 id="hook_log"><a class="anchor" href="#hook_log">#</a>hook_log</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>DEF_bool(hook_log, <span style="color:#0086b3">false</span>, <span style="color:#d14">&#34;#1 enable log for hook if true&#34;</span>);
</span></span></code></pre></div><ul>
<li>æ‰“å° hook ç›¸å…³çš„æ—¥å¿—ï¼Œé»˜è®¤ä¸º falseã€‚</li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

  



  
    
  
    
  


  


<div class="book-languages" tabindex="0" aria-haspopup="true">
  <ul>
    <li class="flex align-center">
      <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
      ä¸­æ–‡
    </li> 
  </ul>

  <ul class="book-languages-list">
    
    <li class="active">
      <a href="../../../cn/" class="flex align-center">
        <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
        ä¸­æ–‡
      </a>
    </li>
    
    <li class="">
      <a href="../../../en/co/coroutine/" class="flex align-center">
        <img src="../../../svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </li>
    
  </ul>
</div>




  <div class="book-date"><a class="flex align-center" href="https://github.com/cocoyaxi/codoc/commit/8f91caf0a938c19fe549b8d0fdd1771a2d67c525" title='æœ€åä¿®æ”¹è€… idealvin | August 14, 2022' target="_blank" rel="noopener">
      <img src="../../../svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>August 14, 2022</span>
    </a>
  </div>



  <div class="book-edit">
    <a class="flex align-center" href="https://github.com/cocoyaxi/codoc/edit/master/content/cn/co/coroutine.md" target="_blank" rel="noopener">
      <img src="../../../svg/edit.svg" class="book-icon" alt="Edit" />
      <span>ç¼–è¾‘æœ¬é¡µ</span>
    </a>
  </div>

</div>

 
        





<script src="//cdn.bootcss.com/highlight.js/11.1.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/cpp.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/bash.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/lua.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/11.1.0/languages/yaml.min.js"></script>
<script>hljs.configure({ languages: [] }); hljs.initHighlightingOnLoad();</script>





      </footer>

      
  
  <div class="book-comments">


<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.css">
<script src="//cdn.bootcss.com/gitalk/1.7.2/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '11f9ff9ca43804d70b32',
    clientSecret: '07e2bd5b09a1654e7942a7698c3ec164e7566177',
    repo: 'gitalk',
    owner: 'idealvin',
    admin: ['idealvin'],
    id: location.pathname,
    language: 'zh-CN',
    distractionFreeMode: false,
    proxy: 'https:\/\/cors-anywhere.azm.workers.dev\/https:\/\/github.com\/login\/oauth\/access_token'
  })
  gitalk.render('gitalk-container');
</script></div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></li>
        <li><a href="#åç¨‹-api">åç¨‹ API</a>
          <ul>
            <li><a href="#v30-åˆ é™¤çš„-api">v3.0 åˆ é™¤çš„ API</a></li>
            <li><a href="#go">go</a></li>
            <li><a href="#def_main">DEF_main</a></li>
            <li><a href="#cocoroutine">co::coroutine</a></li>
            <li><a href="#coresume">co::resume</a></li>
            <li><a href="#coyield">co::yield</a></li>
            <li><a href="#coscheduler">co::scheduler</a></li>
            <li><a href="#coschedulers">co::schedulers</a></li>
            <li><a href="#conext_scheduler">co::next_scheduler</a></li>
            <li><a href="#coscheduler_num">co::scheduler_num</a></li>
            <li><a href="#coscheduler_id">co::scheduler_id</a></li>
            <li><a href="#cocoroutine_id">co::coroutine_id</a></li>
            <li><a href="#cosleep">co::sleep</a></li>
            <li><a href="#cotimeout">co::timeout</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹åŒ–çš„-socket-api">åç¨‹åŒ–çš„ socket API</a>
          <ul>
            <li><a href="#æœ¯è¯­çº¦å®šå¿…çœ‹">æœ¯è¯­çº¦å®š(å¿…çœ‹)</a></li>
            <li><a href="#cosocket">co::socket</a></li>
            <li><a href="#coaccept">co::accept</a></li>
            <li><a href="#cobind">co::bind</a></li>
            <li><a href="#coclose">co::close</a></li>
            <li><a href="#coconnect">co::connect</a></li>
            <li><a href="#colisten">co::listen</a></li>
            <li><a href="#corecv">co::recv</a></li>
            <li><a href="#corecvn">co::recvn</a></li>
            <li><a href="#corecvfrom">co::recvfrom</a></li>
            <li><a href="#cosend">co::send</a></li>
            <li><a href="#cosendto">co::sendto</a></li>
            <li><a href="#coshutdown">co::shutdown</a></li>
            <li><a href="#coerror">co::error</a></li>
            <li><a href="#costrerror">co::strerror</a></li>
            <li><a href="#heading">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</a></li>
            <li><a href="#cogetsockopt">co::getsockopt</a></li>
            <li><a href="#cosetsockopt">co::setsockopt</a></li>
            <li><a href="#coset_nonblock">co::set_nonblock</a></li>
            <li><a href="#coset_reuseaddr">co::set_reuseaddr</a></li>
            <li><a href="#coset_recv_buffer_size">co::set_recv_buffer_size</a></li>
            <li><a href="#coset_send_buffer_size">co::set_send_buffer_size</a></li>
            <li><a href="#coset_tcp_keepalive">co::set_tcp_keepalive</a></li>
            <li><a href="#coset_tcp_nodelay">co::set_tcp_nodelay</a></li>
            <li><a href="#coreset_tcp_socket">co::reset_tcp_socket</a></li>
            <li><a href="#heading-1">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</a></li>
            <li><a href="#coinit_ip_addr">co::init_ip_addr</a></li>
            <li><a href="#coip_str">co::ip_str</a></li>
            <li><a href="#coto_string">co::to_string</a></li>
            <li><a href="#copeer">co::peer</a></li>
          </ul>
        </li>
        <li><a href="#channelcochan">channel(co::Chan)</a>
          <ul>
            <li><a href="#chanchan">Chan::Chan</a></li>
            <li><a href="#operator">operator&laquo;</a></li>
            <li><a href="#operator-1">operator&raquo;</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-1">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹åŒæ­¥äº‹ä»¶coevent">åç¨‹åŒæ­¥äº‹ä»¶(co::Event)</a>
          <ul>
            <li><a href="#eventevent">Event::Event</a></li>
            <li><a href="#eventsignal">Event::signal</a></li>
            <li><a href="#eventwait">Event::wait</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-2">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#waitgroupcowaitgroup">waitgroup(co::WaitGroup)</a>
          <ul>
            <li><a href="#waitgroupwaitgroup">WaitGroup::WaitGroup</a></li>
            <li><a href="#waitgroupadd">WaitGroup::add</a></li>
            <li><a href="#waitgroupdone">WaitGroup::done</a></li>
            <li><a href="#waitgroupwait">WaitGroup::wait</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-3">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹é”comutex">åç¨‹é”(co::Mutex)</a>
          <ul>
            <li><a href="#mutexmutex">Mutex::Mutex</a></li>
            <li><a href="#mutexlock">Mutex::lock</a></li>
            <li><a href="#mutextry_lock">Mutex::try_lock</a></li>
            <li><a href="#mutexunlock">Mutex::unlock</a></li>
          </ul>
        </li>
        <li><a href="#comutexguard">co::MutexGuard</a>
          <ul>
            <li><a href="#mutexguardmutexguard">MutexGuard::MutexGuard</a></li>
            <li><a href="#mutexguardmutexguard-1">MutexGuard::~MutexGuard</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-4">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹æ± copool">åç¨‹æ± (co::Pool)</a>
          <ul>
            <li><a href="#poolpool">Pool::Pool</a></li>
            <li><a href="#poolclear">Pool::clear</a></li>
            <li><a href="#poolpop">Pool::pop</a></li>
            <li><a href="#poolpush">Pool::push</a></li>
            <li><a href="#poolsize">Pool::size</a></li>
          </ul>
        </li>
        <li><a href="#copoolguard">co::PoolGuard</a>
          <ul>
            <li><a href="#poolguardpoolguard">PoolGuard::PoolGuard</a></li>
            <li><a href="#poolguardpoolguard-1">PoolGuard::~PoolGuard</a></li>
            <li><a href="#poolguardget">PoolGuard::get</a></li>
            <li><a href="#poolguardoperator-">PoolGuard::operator-&gt;</a></li>
            <li><a href="#poolguardoperator">PoolGuard::operator*</a></li>
            <li><a href="#poolguardoperator-bool">PoolGuard::operator bool</a></li>
            <li><a href="#poolguardoperator-1">PoolGuard::operator!</a></li>
            <li><a href="#poolguardoperator-2">PoolGuard::operator==</a></li>
            <li><a href="#poolguardoperator-3">PoolGuard::operator!=</a></li>
            <li><a href="#poolguardoperator-4">PoolGuard::operator=</a></li>
            <li><a href="#poolguardreset">PoolGuard::reset</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-5">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#io-äº‹ä»¶coioevent">I/O äº‹ä»¶(co::IoEvent)</a>
          <ul>
            <li><a href="#coio_event_t">co::io_event_t</a></li>
            <li><a href="#ioeventioevent">IoEvent::IoEvent</a></li>
            <li><a href="#ioeventioevent-1">IoEvent::~IoEvent</a></li>
            <li><a href="#ioeventwait">IoEvent::wait</a></li>
            <li><a href="#ä»£ç ç¤ºä¾‹-6">ä»£ç ç¤ºä¾‹</a></li>
          </ul>
        </li>
        <li><a href="#åç¨‹ä¸­ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“">åç¨‹ä¸­ä½¿ç”¨ä¸‰æ–¹ç½‘ç»œåº“</a>
          <ul>
            <li><a href="#åç¨‹åŒ–">åç¨‹åŒ–</a></li>
            <li><a href="#ç³»ç»Ÿ-api-hook">ç³»ç»Ÿ API hook</a></li>
          </ul>
        </li>
        <li><a href="#åŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼">åŸºäºåç¨‹çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼</a>
          <ul>
            <li><a href="#æœåŠ¡ç«¯ç½‘ç»œæ¨¡å‹">æœåŠ¡ç«¯ç½‘ç»œæ¨¡å‹</a></li>
            <li><a href="#å®¢æˆ·ç«¯ç½‘ç»œæ¨¡å‹">å®¢æˆ·ç«¯ç½‘ç»œæ¨¡å‹</a></li>
          </ul>
        </li>
        <li><a href="#é…ç½®">é…ç½®</a>
          <ul>
            <li><a href="#co_debug_log">co_debug_log</a></li>
            <li><a href="#co_sched_num">co_sched_num</a></li>
            <li><a href="#co_stack_size">co_stack_size</a></li>
            <li><a href="#disable_hook_sleep">disable_hook_sleep</a></li>
            <li><a href="#hook_log">hook_log</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












